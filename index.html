<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wavelength ‚Äî Song of the Week</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c27;
    --border: #2a2a3a;
    --accent: #e8c547;
    --accent2: #c47aff;
    --text: #e8e8f0;
    --text-muted: #6b6b88;
    --text-dim: #3a3a55;
    --red: #ff6b6b;
    --green: #6bffb8;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 1000; opacity: 0.35;
  }

  .view { display: none; }
  .view.active { display: block; }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.9); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 60px;
  }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-style: italic; color: var(--accent); cursor: pointer; }
  .logo span { color: var(--accent2); }
  .nav-actions { display: flex; gap: 0.75rem; align-items: center; }
  .nav-user { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--text-muted); }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn { font-family: 'DM Mono', monospace; font-size: 0.72rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; padding: 0.5rem 1.1rem; border-radius: 4px; border: none; cursor: pointer; transition: all 0.15s; }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
  .btn-ghost:hover { border-color: var(--text-muted); color: var(--text); }
  .btn-primary { background: var(--accent); color: #0a0a0f; }
  .btn-primary:hover { background: #f0d060; transform: translateY(-1px); }
  .btn-danger { background: transparent; border: 1px solid var(--red); color: var(--red); }
  .btn-danger:hover { background: var(--red); color: #0a0a0f; }
  .btn-wide { width: 100%; padding: 0.85rem; font-size: 0.8rem; }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-group { margin-bottom: 1.25rem; }
  .form-group label { display: block; font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.4rem; }
  .form-group input, .form-group textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 4px;
    padding: 0.75rem 0.9rem; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    transition: border-color 0.15s; outline: none;
  }
  .form-group input:focus, .form-group textarea:focus { border-color: var(--accent); }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-hint { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--text-muted); margin-top: 0.35rem; }
  .form-error { color: var(--red); font-family: 'DM Mono', monospace; font-size: 0.72rem; margin-top: 0.4rem; text-align: center; }

  /* ‚îÄ‚îÄ CENTERED SCREEN SHELL ‚îÄ‚îÄ */
  .center-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
  .center-box { width: 100%; max-width: 460px; }

  /* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
  .setup-logo { font-family: 'Playfair Display', serif; font-size: 2.8rem; font-weight: 900; font-style: italic; color: var(--accent); margin-bottom: 0.4rem; }
  .setup-logo span { color: var(--accent2); }
  .setup-tagline { font-family: 'DM Mono', monospace; font-size: 0.78rem; color: var(--text-muted); margin-bottom: 2.5rem; line-height: 1.6; }

  .step-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.4rem 1.6rem; margin-bottom: 1rem; }
  .step-num { font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.5rem; }
  .step-card h3 { font-family: 'Playfair Display', serif; font-size: 1.05rem; font-weight: 700; margin-bottom: 0.6rem; }
  .step-card p, .step-card li { font-size: 0.84rem; color: var(--text-muted); line-height: 1.65; }
  .step-card ul { padding-left: 1.2rem; }
  .step-card li { margin-bottom: 0.35rem; }
  .step-card strong { color: var(--text); }

  .code-block {
    background: #080810; border: 1px solid var(--border); border-radius: 4px;
    padding: 0.9rem 1rem; font-family: 'DM Mono', monospace; font-size: 0.7rem;
    color: var(--green); margin-top: 0.85rem; white-space: pre; overflow-x: auto; line-height: 1.65;
  }
  .copy-btn {
    display: inline-block; margin-top: 0.5rem; font-family: 'DM Mono', monospace;
    font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--text-muted); cursor: pointer; border: none; background: none; padding: 0;
    transition: color 0.15s;
  }
  .copy-btn:hover { color: var(--accent); }

  .creds-section { margin-top: 1.5rem; }
  .creds-section h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; }
  .creds-section p { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.6; }
  .cred-input-group { margin-bottom: 0.9rem; }
  .cred-input-group label { display: block; font-family: 'DM Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.35rem; }
  .cred-input-group input {
    width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    padding: 0.7rem 0.9rem; color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.72rem;
    outline: none; transition: border-color 0.15s;
  }
  .cred-input-group input:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  .auth-logo { font-family: 'Playfair Display', serif; font-size: 2rem; font-style: italic; color: var(--accent); margin-bottom: 0.3rem; }
  .auth-logo span { color: var(--accent2); }
  .auth-tagline { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6; }
  .magic-sent-box { background: var(--surface); border: 1px solid var(--accent); border-radius: 6px; padding: 1.5rem; text-align: center; }
  .magic-sent-box .icon { font-size: 2rem; margin-bottom: 0.75rem; }
  .magic-sent-box h3 { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
  .magic-sent-box p { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--text-muted); line-height: 1.65; }

  /* ‚îÄ‚îÄ ONBOARDING (profile setup) ‚îÄ‚îÄ */
  .onboarding-box h2 { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 900; margin-bottom: 0.4rem; }
  .onboarding-box .sub { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.65; }

  /* ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ */
  .color-picker-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.15s, transform 0.1s; flex-shrink: 0; }
  .color-swatch:hover, .color-swatch.selected { border-color: white; transform: scale(1.12); }

  /* ‚îÄ‚îÄ FEED ‚îÄ‚îÄ */
  .feed-header { padding: 3rem 2rem 2rem; max-width: 960px; margin: 0 auto; }
  .feed-header h1 { font-family: 'Playfair Display', serif; font-size: 2.6rem; font-weight: 900; line-height: 1; margin-bottom: 0.5rem; }
  .feed-header .meta { color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.78rem; }
  .week-pill { display: inline-block; background: var(--accent); color: #0a0a0f; font-family: 'DM Mono', monospace; font-size: 0.65rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; padding: 0.22rem 0.55rem; border-radius: 2px; margin-bottom: 1rem; }
  .friends-grid { max-width: 960px; margin: 0 auto; padding: 0 2rem 4rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5px; background: var(--border); border: 1px solid var(--border); }
  .friend-card { background: var(--surface); padding: 1.5rem; cursor: pointer; transition: background 0.15s; position: relative; overflow: hidden; }
  .friend-card:hover { background: var(--surface2); }
  .f-avatar { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
  .f-name { font-family: 'DM Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.3rem; }
  .f-song { font-family: 'Playfair Display', serif; font-size: 1.15rem; font-weight: 700; line-height: 1.2; margin-bottom: 0.2rem; }
  .f-artist { font-size: 0.85rem; color: var(--text-muted); }
  .no-pick { color: var(--text-dim); font-family: 'DM Mono', monospace; font-size: 0.75rem; font-style: italic; }
  .card-arrow { position: absolute; bottom: 1.5rem; right: 1.5rem; color: var(--text-dim); font-size: 1rem; transition: all 0.15s; }
  .friend-card:hover .card-arrow { color: var(--accent); transform: translate(2px,-2px); }

  /* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
  .profile-wrap { max-width: 860px; margin: 0 auto; padding: 1.5rem 2rem 0; }
  .back-btn { background: none; border: none; color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; transition: color 0.15s; padding: 0; }
  .back-btn:hover { color: var(--accent); }
  .profile-hero { max-width: 860px; margin: 0 auto; padding: 2rem 2rem 1.2rem; display: flex; align-items: flex-end; gap: 1.5rem; border-bottom: 1px solid var(--border); }
  .p-avatar-lg { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; flex-shrink: 0; }
  .p-meta h2 { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 900; }
  .p-meta p { color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.75rem; margin-top: 0.2rem; }
  .weeks-list { max-width: 860px; margin: 0 auto; padding: 0 2rem 4rem; }
  .week-row { display: grid; grid-template-columns: 140px 1fr auto; align-items: center; gap: 1.5rem; padding: 1.1rem 0.5rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; border-radius: 4px; margin: 0 -0.5rem; }
  .week-row:hover { background: var(--surface); }
  .week-row.is-current .wk-label { color: var(--accent); }
  .wk-label { font-family: 'DM Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
  .wk-date { font-size: 0.6rem; color: var(--text-dim); margin-top: 0.15rem; }
  .wk-song strong { font-family: 'Playfair Display', serif; font-size: 1.05rem; display: block; }
  .wk-song span { font-size: 0.82rem; color: var(--text-muted); }
  .wk-arrow { color: var(--text-dim); }
  .week-row:hover .wk-arrow { color: var(--accent); }

  /* ‚îÄ‚îÄ SONG DETAIL ‚îÄ‚îÄ */
  .song-wrap { max-width: 720px; margin: 0 auto; padding: 0 2rem 4rem; }
  .song-hero { padding: 2.5rem 0 2rem; border-bottom: 1px solid var(--border); }
  .song-badge { font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.75rem; }
  .song-title { font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 900; line-height: 1; margin-bottom: 0.4rem; }
  .song-artist { font-size: 1.1rem; color: var(--text-muted); }
  .tags { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 1rem; }
  .tag { font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.06em; padding: 0.25rem 0.6rem; border-radius: 2px; border: 1px solid var(--accent); color: var(--accent); }
  .detail-sec { padding: 2rem 0; border-bottom: 1px solid var(--border); }
  .detail-sec:last-child { border-bottom: none; }
  .detail-sec h3 { font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 1.2rem; }
  .detail-sec p { font-size: 0.95rem; line-height: 1.75; }
  .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.88rem; }
  .stat-row:last-child { border-bottom: none; }
  .stat-row .lbl { color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.7rem; }
  .similar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .sim-item { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 0.9rem 1rem; transition: border-color 0.15s; }
  .sim-item:hover { border-color: var(--accent2); }
  .sim-item strong { font-family: 'Playfair Display', serif; font-size: 0.95rem; display: block; margin-bottom: 0.1rem; }
  .sim-item span { font-size: 0.78rem; color: var(--text-muted); }

  /* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
  .settings-wrap { max-width: 560px; margin: 0 auto; padding: 2rem; }
  .settings-wrap h2 { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 900; margin-bottom: 0.3rem; }
  .settings-wrap .sub { color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.75rem; margin-bottom: 2rem; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 1.75rem 0; }
  .user-result { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
  .user-result:last-child { border-bottom: none; }
  .ur-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; }
  .ur-info { flex: 1; }
  .ur-info strong { font-size: 0.9rem; }
  .ur-info span { display: block; font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--text-muted); }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.72); backdrop-filter: blur(10px); z-index: 500; display: none; align-items: center; justify-content: center; padding: 1rem; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; width: 100%; max-width: 500px; position: relative; max-height: 92vh; overflow-y: auto; }
  .modal h3 { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; margin-bottom: 0.3rem; }
  .modal .modal-sub { color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.72rem; margin-bottom: 1.5rem; }
  .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: color 0.15s; line-height: 1; }
  .modal-close:hover { color: var(--text); }

  /* ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ */
  .spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-center { display: flex; align-items: center; justify-content: center; padding: 4rem; }
  .empty-state { text-align: center; padding: 4rem 2rem; }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 1rem; }
  .empty-state p { font-family: 'DM Mono', monospace; font-size: 0.8rem; color: var(--text-muted); line-height: 1.65; margin-bottom: 1.5rem; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(120px); background: var(--accent); color: #0a0a0f; font-family: 'DM Mono', monospace; font-size: 0.75rem; font-weight: 500; padding: 0.7rem 1.4rem; border-radius: 4px; z-index: 9999; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.err { background: var(--red); color: white; }

  @media (max-width: 600px) {
    .song-title { font-size: 2rem; }
    .similar-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .week-row { grid-template-columns: 90px 1fr auto; gap: 0.75rem; }
    nav { padding: 0 1rem; }
    .friends-grid { padding: 0 1rem 3rem; }
    .feed-header, .profile-hero, .profile-wrap, .weeks-list, .song-wrap, .settings-wrap { padding-left: 1rem; padding-right: 1rem; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view active" id="view-setup">
  <div class="center-screen" style="align-items:flex-start;padding-top:3rem">
    <div class="center-box" style="max-width:520px">
      <div class="setup-logo">Wave<span>length</span></div>
      <p class="setup-tagline">Before you can use the app, you need to connect a free Supabase database.<br>Follow the steps below ‚Äî it takes about 5 minutes.</p>

      <div class="step-card">
        <div class="step-num">Step 1 of 4</div>
        <h3>Create a free Supabase account</h3>
        <ul>
          <li>Open a new tab and go to <strong>supabase.com</strong></li>
          <li>Click <strong>"Start your project"</strong> and sign up (GitHub or email)</li>
          <li>Once logged in, click <strong>"New project"</strong></li>
          <li>Give it any name (e.g. <em>wavelength</em>), pick a region, set a database password, then click <strong>"Create new project"</strong></li>
          <li>Wait about 2 minutes for it to finish setting up</li>
        </ul>
      </div>

      <div class="step-card">
        <div class="step-num">Step 2 of 4</div>
        <h3>Enable Magic Link login</h3>
        <ul>
          <li>In your Supabase project, click <strong>Authentication</strong> in the left sidebar</li>
          <li>Click <strong>Providers</strong> (or "Sign In / Up" depending on your version)</li>
          <li>Make sure <strong>Email</strong> is enabled ‚Äî it is by default ‚úì</li>
          <li>Scroll down and make sure <strong>"Confirm email"</strong> is turned <strong>ON</strong> ‚Äî this is what sends the magic link</li>
        </ul>
      </div>

      <div class="step-card">
        <div class="step-num">Step 3 of 4</div>
        <h3>Create the database tables</h3>
        <p>In your Supabase project, click <strong>SQL Editor</strong> in the left sidebar. Click <strong>"New query"</strong>, paste in the code below, then click <strong>"Run"</strong> (or press Cmd/Ctrl + Enter).</p>
        <div class="code-block" id="sql-block">-- Profiles (one per user)
create table profiles (
  id uuid references auth.users primary key,
  username text unique not null,
  display_name text not null,
  color text default '#e8c547',
  created_at timestamptz default now()
);

-- Picks (one per user per week)
create table picks (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references profiles(id) on delete cascade,
  week_number integer not null,
  song text not null,
  artist text not null,
  note text,
  tags text[],
  year text,
  band_info text,
  created_at timestamptz default now(),
  unique(user_id, week_number)
);

-- Follows
create table follows (
  follower_id uuid references profiles(id) on delete cascade,
  following_id uuid references profiles(id) on delete cascade,
  created_at timestamptz default now(),
  primary key (follower_id, following_id)
);

-- Security rules (Row Level Security)
alter table profiles enable row level security;
alter table picks enable row level security;
alter table follows enable row level security;

create policy "Profiles readable by all"
  on profiles for select using (true);
create policy "Users can create own profile"
  on profiles for insert with check (auth.uid() = id);
create policy "Users can update own profile"
  on profiles for update using (auth.uid() = id);

create policy "Picks readable by all"
  on picks for select using (true);
create policy "Users manage own picks"
  on picks for all using (auth.uid() = user_id);

create policy "Follows readable by all"
  on follows for select using (true);
create policy "Users manage own follows"
  on follows for all using (auth.uid() = follower_id);</div>
        <button class="copy-btn" onclick="copySQL()">‚éò Copy SQL</button>
      </div>

      <div class="step-card">
        <div class="step-num">Step 4 of 4</div>
        <h3>Paste your API credentials below</h3>
        <ul>
          <li>In your Supabase project, click <strong>Project Settings</strong> (gear icon, bottom of left sidebar)</li>
          <li>Click <strong>API</strong> in the settings menu</li>
          <li>Copy your <strong>Project URL</strong> and <strong>anon / public key</strong> and paste them below</li>
        </ul>
      </div>

      <div class="creds-section">
        <h3>Your Supabase credentials</h3>
        <p>These are saved in your browser only and never sent anywhere else.</p>
        <div class="cred-input-group">
          <label>Project URL</label>
          <input type="text" id="setup-url" placeholder="https://xxxxxxxxxxx.supabase.co" />
        </div>
        <div class="cred-input-group">
          <label>Anon / Public Key</label>
          <input type="text" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
        </div>
        <br>
        <button class="btn btn-primary btn-wide" onclick="connectSupabase()">Connect & Continue ‚Üí</button>
        <div id="setup-error" class="form-error" style="margin-top:0.6rem"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-auth">
  <div class="center-screen">
    <div class="center-box">
      <div class="auth-logo">Wave<span>length</span></div>
      <p class="auth-tagline">One song. Every week. Share what's moving you.<br>Enter your email and we'll send you a magic sign-in link ‚Äî no password needed.</p>

      <div id="auth-form">
        <div class="form-group">
          <label>Your Email</label>
          <input type="email" id="auth-email" placeholder="you@example.com" />
          <p class="form-hint">We'll email you a link. Click it and you're in.</p>
        </div>
        <button class="btn btn-primary btn-wide" id="auth-btn" onclick="sendMagicLink()">Send Magic Link ‚Üí</button>
        <div id="auth-error" class="form-error" style="margin-top:0.5rem"></div>
      </div>

      <div id="auth-sent" style="display:none">
        <div class="magic-sent-box">
          <div class="icon">‚úâÔ∏è</div>
          <h3>Check your inbox</h3>
          <p>We sent a sign-in link to <strong id="auth-sent-email"></strong>.<br><br>Click the link in the email to sign in. You can close this tab if you like ‚Äî just come back after clicking.</p>
        </div>
        <p style="margin-top:1rem;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-muted);text-align:center;cursor:pointer" onclick="resetAuth()">‚Üê Use a different email</p>
      </div>

      <p style="margin-top:2rem;font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--text-dim);text-align:center;cursor:pointer" onclick="resetSetup()">‚Üê Change Supabase credentials</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-onboarding">
  <div class="center-screen">
    <div class="center-box onboarding-box">
      <h2>Set Up Your Profile</h2>
      <p class="sub">You're in! Now pick a name and username ‚Äî this is what your friends will see when they visit your profile.</p>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="ob-name" placeholder="e.g. Jamie" />
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="ob-username" placeholder="e.g. jamie_listens" />
        <p class="form-hint">Letters, numbers, and underscores only. No spaces.</p>
      </div>
      <div class="form-group">
        <label>Pick an Avatar Color</label>
        <div class="color-picker-row" id="ob-colors"></div>
      </div>
      <button class="btn btn-primary btn-wide" id="ob-btn" onclick="createProfile()">Enter Wavelength ‚Üí</button>
      <div id="ob-error" class="form-error" style="margin-top:0.5rem"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav id="mainNav" style="display:none">
  <div class="logo" onclick="showView('feed')">Wave<span>length</span></div>
  <div class="nav-actions">
    <span class="nav-user" id="nav-user"></span>
    <button class="btn btn-ghost" onclick="showView('settings')">Settings</button>
    <button class="btn btn-primary" onclick="openPickModal()">+ This Week</button>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FEED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-feed">
  <div class="feed-header">
    <div class="week-pill" id="feed-pill">Week 1</div>
    <h1>This Week's<br>Picks</h1>
    <p class="meta" id="feed-range"></p>
  </div>
  <div class="friends-grid" id="friends-grid">
    <div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-profile">
  <div class="profile-wrap">
    <button class="back-btn" id="profile-back">‚Üê Back to Feed</button>
  </div>
  <div class="profile-hero" id="profile-hero"></div>
  <div class="weeks-list" id="weeks-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SONG DETAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-songdetail">
  <div class="song-wrap">
    <div style="padding-top:1.5rem;margin-bottom:0.5rem">
      <button class="back-btn" id="song-back">‚Üê Back to Profile</button>
    </div>
    <div id="song-content"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-settings">
  <div class="settings-wrap">
    <button class="back-btn" style="margin-bottom:1.5rem" onclick="showView('feed')">‚Üê Back to Feed</button>
    <h2>Settings</h2>
    <p class="sub">Update your profile or find friends</p>

    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="s-name" />
    </div>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="s-username" />
    </div>
    <div class="form-group">
      <label>Avatar Color</label>
      <div class="color-picker-row" id="s-colors"></div>
    </div>
    <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>

    <hr class="divider">
    <h3 style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;margin-bottom:0.5rem">Find Friends</h3>
    <p style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-muted);margin-bottom:1rem">Search by username to follow people</p>
    <div style="display:flex;gap:0.75rem;margin-bottom:1rem">
      <input type="text" id="search-q" placeholder="Search username..." style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:0.65rem 0.9rem;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.15s" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'" />
      <button class="btn btn-ghost" onclick="searchUsers()">Search</button>
    </div>
    <div id="search-results"></div>

    <hr class="divider">
    <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PICK MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="pick-modal">
  <div class="modal">
    <button class="modal-close" onclick="closePickModal()">‚úï</button>
    <h3>This Week's Pick</h3>
    <p class="modal-sub" id="pick-week-label"></p>
    <div class="form-group">
      <label>Song Title</label>
      <input type="text" id="p-song" placeholder="e.g. Karma Police" />
    </div>
    <div class="form-group">
      <label>Artist / Band</label>
      <input type="text" id="p-artist" placeholder="e.g. Radiohead" />
    </div>
    <div class="form-group">
      <label>Why this song? <span style="color:var(--text-dim)">(optional)</span></label>
      <textarea id="p-note" placeholder="What makes this your pick this week?"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Vibe Tags <span style="color:var(--text-dim)">(comma-separated)</span></label>
        <input type="text" id="p-tags" placeholder="e.g. alt-rock, melancholic" />
      </div>
      <div class="form-group">
        <label>Release Year <span style="color:var(--text-dim)">(optional)</span></label>
        <input type="text" id="p-year" placeholder="e.g. 1997" />
      </div>
    </div>
    <div class="form-group">
      <label>About the Artist <span style="color:var(--text-dim)">(optional)</span></label>
      <textarea id="p-bandinfo" placeholder="A little background on the artist..."></textarea>
    </div>
    <button class="btn btn-primary btn-wide" id="pick-save-btn" onclick="savePick()">Save Pick ‚Üí</button>
    <div id="pick-error" class="form-error" style="margin-top:0.5rem"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIMILAR MUSIC DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SIMILAR_SONGS = {
  'kate bush':['Running Up That Hill ‚Äî Kate Bush','Wuthering Heights ‚Äî Kate Bush','Cloudbusting ‚Äî Kate Bush','The Hounds of Love ‚Äî Kate Bush'],
  'radiohead':['Exit Music (For a Film) ‚Äî Radiohead','How to Disappear Completely ‚Äî Radiohead','Street Spirit ‚Äî Radiohead','Reckoner ‚Äî Radiohead'],
  'kendrick lamar':['Alright ‚Äî Kendrick Lamar','DNA. ‚Äî Kendrick Lamar','m.A.A.d city ‚Äî Kendrick Lamar','Swimming Pools ‚Äî Kendrick Lamar'],
  'frank ocean':['Nights ‚Äî Frank Ocean','Self Control ‚Äî Frank Ocean','Pink + White ‚Äî Frank Ocean','Seigfried ‚Äî Frank Ocean'],
  'alt-j':['Something Good ‚Äî alt-J','Tessellate ‚Äî alt-J','Breezeblocks ‚Äî alt-J','Fitzpleasure ‚Äî alt-J'],
  'beach house':['Space Song ‚Äî Beach House','Silver Soul ‚Äî Beach House','Used to Be ‚Äî Beach House','Myth ‚Äî Beach House'],
  'tame impala':['Let It Happen ‚Äî Tame Impala','Feels Like We Only Go Backwards ‚Äî Tame Impala','Eventually ‚Äî Tame Impala','New Person, Same Old Mistakes ‚Äî Tame Impala'],
  'the national':['Bloodbuzz Ohio ‚Äî The National','Sorrow ‚Äî The National','Afraid of Everyone ‚Äî The National','Terrible Love ‚Äî The National'],
  'bon iver':['Holocene ‚Äî Bon Iver','Skinny Love ‚Äî Bon Iver','Towers ‚Äî Bon Iver','Michicant ‚Äî Bon Iver'],
  'fleet foxes':['White Winter Hymnal ‚Äî Fleet Foxes','Helplessness Blues ‚Äî Fleet Foxes','Mykonos ‚Äî Fleet Foxes'],
  'phoebe bridgers':['Motion Sickness ‚Äî Phoebe Bridgers','Savior Complex ‚Äî Phoebe Bridgers','Funeral ‚Äî Phoebe Bridgers'],
};
const SIMILAR_ARTISTS = {
  'kate bush':['Bj√∂rk','Florence + The Machine','Tori Amos','Bat for Lashes'],
  'radiohead':['Portishead','Thom Yorke','Sigur R√≥s','The National'],
  'kendrick lamar':['J. Cole','Isaiah Rashad','ScHoolboy Q','Jay Rock'],
  'frank ocean':['Syd','Steve Lacy','Brent Faiyaz','Daniel Caesar'],
  'alt-j':['Bon Iver','The xx','Foals','Glass Animals'],
  'beach house':['Mazzy Star','Cocteau Twins','Washed Out','Cigarettes After Sex'],
  'tame impala':['MGMT','Unknown Mortal Orchestra','Pond','TEMPOREX'],
  'the national':['Frightened Rabbit','Bon Iver','Iron & Wine','Sufjan Stevens'],
  'bon iver':['The National','Fleet Foxes','Sufjan Stevens','Elbow'],
  'fleet foxes':['Bon Iver','Iron & Wine','The Head and the Heart','Phosphorescent'],
  'phoebe bridgers':['Julien Baker','Lucy Dacus','boygenius','Angel Olsen'],
};

function findSimilar(artist, db) {
  const a = artist.toLowerCase();
  const key = Object.keys(db).find(k => a.includes(k) || k.includes(a));
  return key ? db[key] : null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLORS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS = ['#e8c547','#c47aff','#ff6b6b','#6bffb8','#6bb5ff','#ff9f6b','#ff6bce','#a8ff6b'];

function buildColorPicker(id, selectedColor) {
  const el = document.getElementById(id);
  el.innerHTML = '';
  COLORS.forEach((c, i) => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch';
    sw.style.background = c;
    sw.dataset.color = c;
    if (selectedColor ? c === selectedColor : i === 0) sw.classList.add('selected');
    sw.onclick = () => { el.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected')); sw.classList.add('selected'); };
    el.appendChild(sw);
  });
}

function getColor(id) {
  const s = document.getElementById(id).querySelector('.selected');
  return s ? s.dataset.color : COLORS[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sb = null;
let currentUser = null;
let currentProfile = null;
let viewingUserId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPABASE CONNECT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectSupabase() {
  const url = document.getElementById('setup-url').value.trim();
  const key = document.getElementById('setup-key').value.trim();
  const errEl = document.getElementById('setup-error');
  errEl.textContent = '';
  if (!url || !key) { errEl.textContent = 'Both fields are required.'; return; }
  if (!url.startsWith('https://')) { errEl.textContent = 'URL must start with https://'; return; }
  localStorage.setItem('wl_url', url);
  localStorage.setItem('wl_key', key);
  bootSupabase(url, key);
}

async function bootSupabase(url, key) {
  try {
    sb = window.supabase.createClient(url, key);
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      currentUser = session.user;
      await loadProfileAndContinue();
    } else {
      showView('auth');
    }
    // Listen for auth changes (magic link callback)
    sb.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session && !currentUser) {
        currentUser = session.user;
        await loadProfileAndContinue();
      }
    });
  } catch(e) {
    document.getElementById('setup-error').textContent = 'Could not connect. Double-check your URL and key.';
  }
}

function resetSetup() {
  localStorage.removeItem('wl_url');
  localStorage.removeItem('wl_key');
  showView('setup');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMagicLink() {
  const email = document.getElementById('auth-email').value.trim();
  const errEl = document.getElementById('auth-error');
  const btn = document.getElementById('auth-btn');
  errEl.textContent = '';
  if (!email || !email.includes('@')) { errEl.textContent = 'Please enter a valid email.'; return; }
  btn.disabled = true; btn.textContent = 'Sending...';
  const { error } = await sb.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.href }
  });
  btn.disabled = false; btn.textContent = 'Send Magic Link ‚Üí';
  if (error) { errEl.textContent = error.message; return; }
  document.getElementById('auth-sent-email').textContent = email;
  document.getElementById('auth-form').style.display = 'none';
  document.getElementById('auth-sent').style.display = 'block';
}

function resetAuth() {
  document.getElementById('auth-form').style.display = 'block';
  document.getElementById('auth-sent').style.display = 'none';
  document.getElementById('auth-email').value = '';
}

async function signOut() {
  await sb.auth.signOut();
  currentUser = null; currentProfile = null;
  document.getElementById('mainNav').style.display = 'none';
  showView('auth');
}

async function loadProfileAndContinue() {
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (data) {
    currentProfile = data;
    document.getElementById('nav-user').textContent = '@' + data.username;
    document.getElementById('mainNav').style.display = 'flex';
    showView('feed');
  } else {
    buildColorPicker('ob-colors', null);
    showView('onboarding');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE CREATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function createProfile() {
  const name = document.getElementById('ob-name').value.trim();
  const username = document.getElementById('ob-username').value.trim().toLowerCase().replace(/\s+/g,'_');
  const errEl = document.getElementById('ob-error');
  const btn = document.getElementById('ob-btn');
  errEl.textContent = '';
  if (!name || !username) { errEl.textContent = 'Both fields are required.'; return; }
  if (!/^[a-z0-9_]+$/.test(username)) { errEl.textContent = 'Username: letters, numbers, underscores only.'; return; }
  btn.disabled = true; btn.textContent = 'Saving...';
  const { data, error } = await sb.from('profiles').insert({
    id: currentUser.id, username, display_name: name, color: getColor('ob-colors')
  }).select().single();
  btn.disabled = false; btn.textContent = 'Enter Wavelength ‚Üí';
  if (error) { errEl.textContent = error.message === 'duplicate key value violates unique constraint "profiles_username_key"' ? 'That username is taken. Try another.' : error.message; return; }
  currentProfile = data;
  document.getElementById('nav-user').textContent = '@' + data.username;
  document.getElementById('mainNav').style.display = 'flex';
  showView('feed');
  showToast('Welcome to Wavelength! üéµ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEWS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(name, opts = {}) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  window.scrollTo(0, 0);
  if (name === 'feed') renderFeed();
  if (name === 'profile') renderProfile(opts.userId);
  if (name === 'songdetail') renderSongDetail(opts);
  if (name === 'settings') renderSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCurrentWeek() {
  const start = new Date('2024-01-01');
  return Math.max(1, Math.floor((new Date() - start) / (7*24*60*60*1000)) + 1);
}
function getWeekRange(w) {
  const s = new Date('2024-01-01');
  s.setDate(s.getDate() + (w-1)*7);
  const e = new Date(s); e.setDate(e.getDate()+6);
  const f = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  return `${f(s)} ‚Äì ${f(e)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FEED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderFeed() {
  const week = getCurrentWeek();
  document.getElementById('feed-pill').textContent = `Week ${week}`;
  document.getElementById('feed-range').textContent = getWeekRange(week);
  const grid = document.getElementById('friends-grid');
  grid.innerHTML = '<div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>';

  const { data: follows } = await sb.from('follows').select('following_id').eq('follower_id', currentUser.id);
  const ids = [currentUser.id, ...(follows||[]).map(f=>f.following_id)];
  const { data: profiles } = await sb.from('profiles').select('*').in('id', ids);
  const { data: picks } = await sb.from('picks').select('*').in('user_id', ids).eq('week_number', week);
  const pickMap = Object.fromEntries((picks||[]).map(p=>[p.user_id, p]));

  if (!profiles || profiles.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">üéµ</div><p>Your feed is empty.<br>Go to Settings to search for friends to follow!</p></div>';
    return;
  }

  const sorted = [profiles.find(p=>p.id===currentUser.id), ...profiles.filter(p=>p.id!==currentUser.id)].filter(Boolean);
  grid.innerHTML = sorted.map(p => {
    const pick = pickMap[p.id];
    const me = p.id === currentUser.id;
    return `<div class="friend-card" onclick="showView('profile',{userId:'${p.id}'})">
      <div class="f-avatar" style="background:${p.color}22;color:${p.color}">${p.display_name[0]}</div>
      <div class="f-name">${me ? '‚≠ê You' : '@'+esc(p.username)}</div>
      ${pick ? `<div class="f-song">${esc(pick.song)}</div><div class="f-artist">${esc(pick.artist)}</div>`
              : `<div class="no-pick">No pick yet this week</div>`}
      <div class="card-arrow">‚Üó</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderProfile(userId) {
  viewingUserId = userId;
  const isMe = userId === currentUser.id;
  const week = getCurrentWeek();
  document.getElementById('profile-back').onclick = () => showView('feed');
  document.getElementById('profile-hero').innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';
  document.getElementById('weeks-list').innerHTML = '';

  const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
  if (!profile) return;
  const { data: picks } = await sb.from('picks').select('*').eq('user_id', userId).order('week_number',{ascending:false});
  const pickMap = Object.fromEntries((picks||[]).map(p=>[p.week_number, p]));

  document.getElementById('profile-hero').innerHTML = `
    <div class="p-avatar-lg" style="background:${profile.color}22;color:${profile.color}">${profile.display_name[0]}</div>
    <div class="p-meta">
      <h2>${esc(profile.display_name)}</h2>
      <p>@${esc(profile.username)} ¬∑ ${(picks||[]).length} picks total</p>
    </div>`;

  let html = '';
  for (let w = week; w >= 1; w--) {
    const pick = pickMap[w];
    const cur = w === week;
    html += `<div class="week-row ${cur?'is-current':''}" onclick="${pick ? `showView('songdetail',{userId:'${userId}',week:${w}})` : isMe ? 'openPickModal()' : ''}">
      <div><div class="wk-label">${cur ? '‚òÖ This week' : `Week ${w}`}</div><div class="wk-date">${getWeekRange(w)}</div></div>
      ${pick ? `<div class="wk-song"><strong>${esc(pick.song)}</strong><span>${esc(pick.artist)}</span></div><div class="wk-arrow">‚Üí</div>`
             : isMe ? `<div class="no-pick" style="color:var(--text-muted)">+ Add your pick</div><div></div>`
                    : `<div class="no-pick">No pick</div><div></div>`}
    </div>`;
  }
  document.getElementById('weeks-list').innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SONG DETAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderSongDetail({ userId, week }) {
  document.getElementById('song-back').onclick = () => showView('profile', { userId });
  document.getElementById('song-content').innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';
  const { data: pick } = await sb.from('picks').select('*').eq('user_id', userId).eq('week_number', week).single();
  const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
  if (!pick || !profile) return;

  const tags = pick.tags || [];
  const simSongs = findSimilar(pick.artist, SIMILAR_SONGS);
  const simArtists = findSimilar(pick.artist, SIMILAR_ARTISTS);

  document.getElementById('song-content').innerHTML = `
    <div class="song-hero">
      <div class="song-badge">Week ${week} ¬∑ ${getWeekRange(week)} ¬∑ ${esc(profile.display_name)}'s Pick</div>
      <div class="song-title">${esc(pick.song)}</div>
      <div class="song-artist">${esc(pick.artist)}${pick.year ? ` ¬∑ ${pick.year}` : ''}</div>
      ${tags.length ? `<div class="tags">${tags.map(t=>`<div class="tag">${esc(t)}</div>`).join('')}</div>` : ''}
      ${pick.note ? `<p style="margin-top:1.2rem;font-size:0.92rem;line-height:1.75;color:var(--text-muted);border-left:2px solid var(--accent);padding-left:1rem;font-style:italic">"${esc(pick.note)}"</p>` : ''}
    </div>

    ${pick.band_info ? `<div class="detail-sec"><h3>About ${esc(pick.artist)}</h3><p>${esc(pick.band_info)}</p></div>` : ''}

    <div class="detail-sec">
      <h3>Song Info</h3>
      <div class="stat-row"><span class="lbl">Title</span><span>${esc(pick.song)}</span></div>
      <div class="stat-row"><span class="lbl">Artist</span><span>${esc(pick.artist)}</span></div>
      ${pick.year ? `<div class="stat-row"><span class="lbl">Year</span><span>${pick.year}</span></div>` : ''}
      ${tags.length ? `<div class="stat-row"><span class="lbl">Vibe</span><span>${tags.join(', ')}</span></div>` : ''}
    </div>

    ${simSongs ? `<div class="detail-sec"><h3>Similar Songs</h3><div class="similar-grid">
      ${simSongs.map(s=>{const p=s.split(' ‚Äî ');return `<div class="sim-item"><strong>${esc(p[0])}</strong><span>${esc(p[1]||'')}</span></div>`;}).join('')}
    </div></div>` : ''}

    ${simArtists ? `<div class="detail-sec"><h3>Similar Artists</h3><div class="similar-grid">
      ${simArtists.map(a=>`<div class="sim-item"><strong>${esc(a)}</strong><span>You might enjoy</span></div>`).join('')}
    </div></div>` : ''}
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings() {
  if (!currentProfile) return;
  document.getElementById('s-name').value = currentProfile.display_name;
  document.getElementById('s-username').value = currentProfile.username;
  buildColorPicker('s-colors', currentProfile.color);
  document.getElementById('search-results').innerHTML = '';
  document.getElementById('search-q').value = '';
}

async function saveSettings() {
  const name = document.getElementById('s-name').value.trim();
  const username = document.getElementById('s-username').value.trim().toLowerCase().replace(/\s+/g,'_');
  if (!name || !username) { showToast('Fields required', true); return; }
  const { data, error } = await sb.from('profiles').update({ display_name: name, username, color: getColor('s-colors') }).eq('id', currentUser.id).select().single();
  if (error) { showToast(error.message, true); return; }
  currentProfile = data;
  document.getElementById('nav-user').textContent = '@' + data.username;
  showToast('Saved!');
}

async function searchUsers() {
  const q = document.getElementById('search-q').value.trim();
  if (!q) return;
  const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).neq('id', currentUser.id).limit(10);
  const { data: follows } = await sb.from('follows').select('following_id').eq('follower_id', currentUser.id);
  const followSet = new Set((follows||[]).map(f=>f.following_id));
  const el = document.getElementById('search-results');
  if (!data || data.length === 0) { el.innerHTML = '<p style="font-family:\'DM Mono\',monospace;font-size:0.75rem;color:var(--text-muted);padding:0.5rem 0">No users found.</p>'; return; }
  el.innerHTML = data.map(u => {
    const following = followSet.has(u.id);
    return `<div class="user-result">
      <div class="ur-avatar" style="background:${u.color}22;color:${u.color}">${u.display_name[0]}</div>
      <div class="ur-info"><strong>${esc(u.display_name)}</strong><span>@${esc(u.username)}</span></div>
      <button class="btn ${following?'btn-ghost':'btn-primary'}" style="font-size:0.65rem;padding:0.4rem 0.9rem"
        onclick="toggleFollow('${u.id}',${following},this)">${following?'Following':'Follow'}</button>
    </div>`;
  }).join('');
}

async function toggleFollow(userId, isFollowing, btn) {
  btn.disabled = true;
  if (isFollowing) {
    await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('following_id', userId);
    btn.textContent = 'Follow'; btn.className = 'btn btn-primary'; btn.style.cssText = 'font-size:0.65rem;padding:0.4rem 0.9rem';
    btn.onclick = () => toggleFollow(userId, false, btn);
  } else {
    await sb.from('follows').insert({ follower_id: currentUser.id, following_id: userId });
    btn.textContent = 'Following'; btn.className = 'btn btn-ghost'; btn.style.cssText = 'font-size:0.65rem;padding:0.4rem 0.9rem';
    btn.onclick = () => toggleFollow(userId, true, btn);
    showToast('Following!');
  }
  btn.disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PICK MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openPickModal() {
  const week = getCurrentWeek();
  document.getElementById('pick-week-label').textContent = `Week ${week} ¬∑ ${getWeekRange(week)}`;
  document.getElementById('pick-error').textContent = '';
  const { data } = await sb.from('picks').select('*').eq('user_id', currentUser.id).eq('week_number', week).single();
  document.getElementById('p-song').value = data?.song || '';
  document.getElementById('p-artist').value = data?.artist || '';
  document.getElementById('p-note').value = data?.note || '';
  document.getElementById('p-tags').value = data?.tags?.join(', ') || '';
  document.getElementById('p-year').value = data?.year || '';
  document.getElementById('p-bandinfo').value = data?.band_info || '';
  document.getElementById('pick-modal').classList.add('open');
}

function closePickModal() { document.getElementById('pick-modal').classList.remove('open'); }

async function savePick() {
  const song = document.getElementById('p-song').value.trim();
  const artist = document.getElementById('p-artist').value.trim();
  const errEl = document.getElementById('pick-error');
  const btn = document.getElementById('pick-save-btn');
  errEl.textContent = '';
  if (!song || !artist) { errEl.textContent = 'Song title and artist are required.'; return; }
  const tags = document.getElementById('p-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const week = getCurrentWeek();
  btn.disabled = true; btn.textContent = 'Saving...';
  const { error } = await sb.from('picks').upsert({
    user_id: currentUser.id, week_number: week, song, artist,
    note: document.getElementById('p-note').value.trim(),
    tags, year: document.getElementById('p-year').value.trim(),
    band_info: document.getElementById('p-bandinfo').value.trim(),
  }, { onConflict: 'user_id,week_number' });
  btn.disabled = false; btn.textContent = 'Save Pick ‚Üí';
  if (error) { errEl.textContent = error.message; return; }
  closePickModal();
  showToast('Pick saved! üéµ');
  if (document.getElementById('view-feed').classList.contains('active')) renderFeed();
  if (document.getElementById('view-profile').classList.contains('active')) renderProfile(currentUser.id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg, isErr=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isErr ? ' err' : '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

function copySQL() {
  const sql = document.getElementById('sql-block').textContent;
  navigator.clipboard.writeText(sql).then(() => showToast('SQL copied to clipboard!'));
}

document.getElementById('pick-modal').addEventListener('click', e => { if (e.target.id === 'pick-modal') closePickModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function init() {
  const url = localStorage.getItem('wl_url');
  const key = localStorage.getItem('wl_key');
  if (url && key) bootSupabase(url, key);
  else showView('setup');
})();
</script>
</body>
</html>
