<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wavelength ‚Äî Song of the Week</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0d0000; --surface: #160505; --surface2: #1f0808; --border: #3a0a0a;
    --red: #cc1111; --red-bright: #ff2020; --red-dim: #7a0a0a;
    --white: #f0ece8; --text: #f0ece8; --text-muted: #a09890; --text-dim: #4a3f3a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Crimson Pro', serif; min-height: 100vh; overflow-x: hidden; }
  body::before { content: ''; position: fixed; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px); pointer-events: none; z-index: 999; opacity: 0.3; }
  .view { display: none; position: relative; z-index: 1; }
  .view.active { display: block; }
  nav { position: sticky; top: 0; z-index: 100; background: rgba(13,0,0,0.96); backdrop-filter: blur(20px); border-bottom: 2px solid var(--red-dim); padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 64px; gap: 1rem; }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.7rem; letter-spacing: 0.08em; color: var(--white); cursor: pointer; display: flex; align-items: center; gap: 0.4rem; flex-shrink: 0; }
  .logo span { color: var(--red); }
  .nav-center { display: flex; gap: 0.2rem; align-items: center; }
  .nav-link { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); background: none; border: none; cursor: pointer; padding: 0.4rem 0.75rem; border-radius: 3px; transition: all 0.15s; }
  .nav-link:hover, .nav-link.active { color: var(--white); background: var(--surface2); }
  .nav-actions { display: flex; gap: 0.6rem; align-items: center; flex-shrink: 0; }
  .nav-user { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-muted); }
  .btn { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; padding: 0.5rem 1.1rem; border-radius: 3px; border: none; cursor: pointer; transition: all 0.15s; }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
  .btn-ghost:hover { border-color: var(--red-dim); color: var(--white); }
  .btn-primary { background: var(--red); color: var(--white); }
  .btn-primary:hover { background: var(--red-bright); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(204,17,17,0.35); }
  .btn-danger { background: transparent; border: 1px solid var(--red-dim); color: var(--red); }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-wide { width: 100%; padding: 0.85rem; font-size: 0.75rem; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
  .form-group { margin-bottom: 1.2rem; }
  .form-group label { display: block; font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); margin-bottom: 0.4rem; }
  .form-group input, .form-group textarea { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 3px; padding: 0.75rem 0.9rem; color: var(--text); font-family: 'Crimson Pro', serif; font-size: 1rem; transition: border-color 0.15s; outline: none; }
  .form-group input:focus, .form-group textarea:focus { border-color: var(--red-dim); }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-hint { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; color: var(--text-muted); margin-top: 0.3rem; line-height: 1.5; }
  .form-error { color: #ff7070; font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; margin-top: 0.4rem; text-align: center; }
  .center-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
  .center-box { width: 100%; max-width: 420px; }
  .auth-logo { font-family: 'Bebas Neue', sans-serif; font-size: 2.8rem; letter-spacing: 0.1em; color: var(--white); margin-bottom: 0.3rem; }
  .auth-logo span { color: var(--red); }
  .auth-tagline { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.7; }
  .auth-tabs { display: flex; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 1.5rem; }
  .auth-tab { flex: 1; padding: 0.6rem; text-align: center; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; background: transparent; border: none; color: var(--text-muted); transition: all 0.15s; }
  .auth-tab.active { background: var(--red); color: white; }
  .ob-box h2 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 0.08em; margin-bottom: 0.4rem; }
  .ob-box .sub { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.65; }
  .color-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; flex-shrink: 0; }
  .swatch:hover, .swatch.selected { border-color: white; transform: scale(1.12); }
  .instrument-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .instrument-btn { width: 44px; height: 44px; border-radius: 8px; cursor: pointer; border: 2px solid var(--border); background: var(--surface2); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; transition: all 0.15s; flex-shrink: 0; }
  .instrument-btn:hover { border-color: var(--red-dim); transform: scale(1.08); }
  .instrument-btn.selected { border-color: var(--red); background: var(--red)22; transform: scale(1.08); }
  .feed-header { padding: 3rem 2rem 2rem; max-width: 980px; margin: 0 auto; position: relative; overflow: hidden; }
  .feed-header-deco { position: absolute; top: -10px; right: 20px; font-size: 10rem; opacity: 0.04; pointer-events: none; line-height: 1; }
  .feed-header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem; letter-spacing: 0.06em; line-height: 1; margin-bottom: 0.5rem; color: var(--white); }
  .feed-header h1 span { color: var(--red); }
  .feed-meta { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; }
  .week-pill { display: inline-block; background: var(--red); color: var(--white); font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.12em; padding: 0.22rem 0.6rem; border-radius: 2px; margin-bottom: 1rem; }
  .friends-grid { max-width: 980px; margin: 0 auto; padding: 0 2rem 4rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1px; background: var(--border); border: 1px solid var(--border); }
  .friend-card { background: var(--surface); cursor: pointer; transition: background 0.15s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
  .friend-card:hover { background: var(--surface2); }
  .friend-card-art { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; background: var(--bg); border-bottom: 1px solid var(--border); }
  .friend-card-art-ph { width: 100%; aspect-ratio: 1; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; opacity: 0.1; }
  .friend-card-body { padding: 1.2rem; flex: 1; }
  .f-avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 1rem; margin-bottom: 0.6rem; }
  .f-name { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.3rem; }
  .f-song { font-family: 'Bebas Neue', sans-serif; font-size: 1.25rem; letter-spacing: 0.04em; line-height: 1.1; margin-bottom: 0.15rem; color: var(--white); }
  .f-artist { font-size: 0.88rem; color: var(--text-muted); font-style: italic; }
  .no-pick { color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; }
  .card-arrow { position: absolute; bottom: 1.2rem; right: 1.2rem; color: var(--text-dim); font-size: 0.9rem; transition: all 0.15s; }
  .friend-card:hover .card-arrow { color: var(--red); transform: translate(2px,-2px); }
  .page-header { padding: 3rem 2rem 2rem; max-width: 980px; margin: 0 auto; position: relative; overflow: hidden; }
  .page-header-deco { position: absolute; top: 0; right: 20px; font-size: 9rem; opacity: 0.04; pointer-events: none; line-height: 1; }
  .page-header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; letter-spacing: 0.06em; margin-bottom: 0.5rem; }
  .page-header h1 span { color: var(--red); }
  .page-header p { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--text-muted); }
  .members-grid { max-width: 980px; margin: 0 auto; padding: 0 2rem 4rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1px; background: var(--border); border: 1px solid var(--border); }
  .member-card { background: var(--surface); padding: 1.5rem; cursor: pointer; transition: background 0.15s; text-align: center; }
  .member-card:hover { background: var(--surface2); }
  .member-avatar { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; margin: 0 auto 0.9rem; border: 2px solid var(--red-dim); }
  .member-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.15rem; letter-spacing: 0.06em; margin-bottom: 0.15rem; }
  .member-username { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; color: var(--text-muted); margin-bottom: 0.6rem; }
  .member-picks { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; color: var(--red); margin-bottom: 0.6rem; }
  .member-follow-btn { width: 100%; margin-top: 0.5rem; padding: 0.45rem; border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; border: 1px solid var(--red-dim); background: transparent; color: var(--red); transition: all 0.15s; }
  .member-follow-btn:hover { background: var(--red); color: white; }
  .member-follow-btn.following { border-color: #2a5a2a; background: #0d1f0d; color: #4caf50; }
  .member-follow-btn.following:hover { background: #1a3a1a; border-color: #4caf50; }
  .member-follow-btn.guest-follow { border-color: var(--border); color: var(--text-dim); }
  .member-follow-btn.guest-follow:hover { border-color: var(--red-dim); color: var(--text-muted); }
  .profile-wrap { max-width: 880px; margin: 0 auto; padding: 1.5rem 2rem 0; }
  .back-btn { background: none; border: none; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; transition: color 0.15s; padding: 0; }
  .back-btn:hover { color: var(--red); }
  .profile-hero { max-width: 880px; margin: 0 auto; padding: 2rem 2rem 1.5rem; display: flex; align-items: flex-end; gap: 1.5rem; border-bottom: 1px solid var(--border); position: relative; overflow: hidden; }
  .profile-hero-deco { position: absolute; right: 1.5rem; bottom: -15px; font-size: 7rem; opacity: 0.04; pointer-events: none; }
  .p-avatar-lg { width: 76px; height: 76px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.9rem; flex-shrink: 0; border: 2px solid var(--red-dim); }
  .p-meta h2 { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 0.06em; color: var(--white); }
  .p-meta p { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; margin-top: 0.2rem; }
  .weeks-list { max-width: 880px; margin: 0 auto; padding: 0 2rem 4rem; }
  .week-row { display: grid; grid-template-columns: 52px 130px 1fr auto; align-items: center; gap: 1.1rem; padding: 0.85rem 0.5rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; border-radius: 3px; margin: 0 -0.5rem; }
  .week-row:hover { background: var(--surface); }
  .week-row.is-current .wk-label { color: var(--red); }
  .week-row-art { width: 52px; height: 52px; object-fit: cover; border-radius: 2px; background: var(--surface2); border: 1px solid var(--border); flex-shrink: 0; }
  .week-row-art-ph { width: 52px; height: 52px; border-radius: 2px; background: var(--surface2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; opacity: 0.25; flex-shrink: 0; }
  .wk-label { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
  .wk-date { font-size: 0.56rem; color: var(--text-dim); margin-top: 0.2rem; }
  .wk-song strong { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.04em; display: block; color: var(--white); }
  .wk-song span { font-size: 0.83rem; color: var(--text-muted); font-style: italic; }
  .wk-arrow { color: var(--text-dim); font-size: 0.85rem; }
  .week-row:hover .wk-arrow { color: var(--red); }
  .song-wrap { max-width: 740px; margin: 0 auto; padding: 0 2rem 4rem; }
  .song-hero { padding: 2.5rem 0 2rem; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 180px 1fr; gap: 2rem; align-items: start; }
  .song-hero-art { width: 180px; height: 180px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border); }
  .song-hero-art-ph { width: 180px; height: 180px; border-radius: 4px; background: var(--surface); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 4rem; opacity: 0.12; }
  .song-badge { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); margin-bottom: 0.75rem; }
  .song-title { font-family: 'Bebas Neue', sans-serif; font-size: 2.8rem; letter-spacing: 0.04em; line-height: 1; margin-bottom: 0.3rem; color: var(--white); }
  .song-artist { font-size: 1.1rem; color: var(--text-muted); font-style: italic; }
  .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
  .tag { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em; padding: 0.35rem 0.8rem; border-radius: 20px; background: rgba(204,17,17,0.12); border: 1px solid var(--red-dim); color: var(--red); transition: all 0.15s; }
  .tag:hover { background: rgba(204,17,17,0.22); border-color: var(--red); }
  .detail-sec { padding: 1.75rem 0; border-bottom: 1px solid var(--border); }
  .detail-sec:last-child { border-bottom: none; }
  .detail-sec h3 { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.16em; color: var(--red-dim); margin-bottom: 1.1rem; }
  .detail-sec p { font-size: 1rem; line-height: 1.75; color: var(--text-muted); }
  .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 0.55rem 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
  .stat-row:last-child { border-bottom: none; }
  .stat-row .lbl { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; }
  .similar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .sim-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem 1.1rem; transition: all 0.15s; cursor: default; }
  .sim-item:hover { border-color: var(--red-dim); background: var(--surface2); transform: translateY(-1px); }
  .sim-item strong { font-family: 'Bebas Neue', sans-serif; font-size: 1.05rem; letter-spacing: 0.04em; display: block; margin-bottom: 0.15rem; color: var(--white); }
  .sim-item span { font-size: 0.75rem; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-style: normal; letter-spacing: 0.04em; }
  /* Artist stat pills */
  .artist-stats { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
  .artist-stat-pill { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.06em; padding: 0.3rem 0.75rem; border-radius: 20px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); }
  .settings-wrap { max-width: 560px; margin: 0 auto; padding: 2rem; }
  .settings-wrap h2 { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 0.06em; margin-bottom: 0.3rem; }
  .settings-wrap .sub { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; margin-bottom: 2rem; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 1.75rem 0; }
  .user-result { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
  .user-result:last-child { border-bottom: none; }
  .ur-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 1rem; flex-shrink: 0; }
  .ur-info { flex: 1; }
  .ur-info strong { font-size: 0.95rem; }
  .ur-info span { display: block; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; color: var(--text-muted); }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 500; display: none; align-items: center; justify-content: center; padding: 1rem; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-top: 3px solid var(--red); border-radius: 4px; padding: 2rem; width: 100%; max-width: 520px; position: relative; max-height: 92vh; overflow-y: auto; }
  .modal h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 0.06em; margin-bottom: 0.3rem; }
  .modal .modal-sub { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; margin-bottom: 1.5rem; }
  .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: color 0.15s; line-height: 1; }
  .modal-close:hover { color: var(--red); }
  .spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--red); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-center { display: flex; align-items: center; justify-content: center; padding: 4rem; }
  .empty-state { text-align: center; padding: 4rem 2rem; }
  .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.25; }
  .empty-state p { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); line-height: 1.65; margin-bottom: 1.5rem; }
  .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(120px); background: var(--red); color: white; font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; font-weight: 500; padding: 0.7rem 1.4rem; border-radius: 3px; z-index: 9999; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.err { background: #5a0000; }
  .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 200; background: rgba(13,0,0,0.97); border-top: 1px solid var(--red-dim); padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom)); }
  .mobile-nav-inner { display: flex; justify-content: space-around; align-items: center; }
  .mobile-nav-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; padding: 0.3rem 0.5rem; transition: color 0.15s; min-width: 48px; }
  .mobile-nav-btn.active { color: var(--red); }
  .mobile-nav-btn .mnb-icon { font-size: 1.3rem; line-height: 1; }
  .mobile-nav-btn .mnb-label { font-family: 'IBM Plex Mono', monospace; font-size: 0.48rem; text-transform: uppercase; letter-spacing: 0.08em; }
  .mobile-pick-btn { background: var(--red); border: none; border-radius: 50%; width: 52px; height: 52px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; margin-top: -1.5rem; box-shadow: 0 4px 20px rgba(204,17,17,0.5); transition: all 0.15s; }
  .mobile-pick-btn:hover { background: var(--red-bright); transform: scale(1.08); }
  @media (max-width: 650px) { .mobile-nav { display: block; } body { padding-bottom: 80px; } nav .btn-primary { display: none; } }
  @media (max-width: 650px) {
    .song-hero { grid-template-columns: 1fr; }
    .song-hero-art, .song-hero-art-ph { width: 100%; height: 220px; }
    .song-title { font-size: 2rem; }
    .similar-grid, .form-row { grid-template-columns: 1fr; }
    .week-row { grid-template-columns: 44px 1fr auto; gap: 0.7rem; }
    .week-row > div:nth-child(2) { display: none; }
    nav { padding: 0 1rem; height: 56px; }
    .nav-center { display: none; }
    .logo { font-size: 1.4rem; }
    .nav-actions { gap: 0.4rem; }
    .nav-actions .nav-user { display: none; }
    .btn { padding: 0.45rem 0.8rem; font-size: 0.62rem; }
    .friends-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); padding: 0 1rem 3rem; }
    .members-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); padding: 0 1rem 3rem; }
    .feed-header { padding: 1.5rem 1rem 1rem; }
    .feed-header h1 { font-size: 2.2rem; }
    .profile-hero { padding: 1.2rem 1rem 1rem; flex-wrap: wrap; gap: 1rem; }
    .profile-wrap { padding: 1rem 1rem 0; }
    .weeks-list { padding: 0 1rem 4rem; }
    .song-wrap { padding: 0 1rem 4rem; }
    .settings-wrap { padding: 1.2rem 1rem; }
    .page-header { padding: 1.5rem 1rem 1rem; }
    .page-header h1 { font-size: 2rem; }
    .p-meta h2 { font-size: 1.6rem; }
    .modal { padding: 1.4rem; border-radius: 12px 12px 0 0; position: fixed; bottom: 0; left: 0; right: 0; max-width: 100%; max-height: 90vh; margin: 0; }
    .modal-overlay { align-items: flex-end; padding: 0; }
    .center-box { max-width: 100%; }
    .auth-logo { font-size: 2.2rem; }
    .ob-box h2 { font-size: 1.8rem; }
    .week-pill { font-size: 0.55rem; }
    .friend-card-art, .friend-card-art-ph { aspect-ratio: 1; }
    .f-song { font-size: 1rem; }
  }
  .nav-dropdown { position: relative; }
  .nav-dropdown-toggle { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; padding: 0.5rem 1.1rem; border-radius: 3px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
  .nav-dropdown-toggle:hover { border-color: var(--red-dim); color: var(--white); }
  .nav-dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; min-width: 160px; z-index: 200; box-shadow: 0 8px 24px rgba(0,0,0,0.5); display: none; }
  .nav-dropdown-menu.open { display: block; }
  .nav-dropdown-item { display: block; width: 100%; text-align: left; padding: 0.7rem 1rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: all 0.15s; }
  .nav-dropdown-item:hover { background: var(--surface2); color: var(--white); }
  .nav-dropdown-item.danger { color: var(--red); }
  .nav-dropdown-item.danger:hover { background: var(--red); color: white; }
  .about-wrap { max-width: 740px; margin: 0 auto; padding: 0 2rem 6rem; }
  .about-hero { padding: 4rem 0 3rem; border-bottom: 1px solid var(--border); position: relative; overflow: hidden; }
  .about-hero-deco { position: absolute; right: 0; top: 1rem; font-size: 9rem; opacity: 0.04; pointer-events: none; line-height: 1; }
  .about-title { font-family: 'Bebas Neue', sans-serif; font-size: 4rem; letter-spacing: 0.04em; line-height: 1.05; margin: 0.75rem 0 1.5rem; color: var(--white); }
  .about-title span { color: var(--red); }
  .about-intro { font-size: 1.15rem; line-height: 1.8; color: var(--text-muted); font-style: italic; max-width: 580px; }
  .about-body { padding: 0.5rem 0; }
  .about-section { padding: 2.5rem 0; border-bottom: 1px solid var(--border); }
  .about-section:last-child { border-bottom: none; }
  .about-section-label { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.18em; color: var(--red-dim); margin-bottom: 1.2rem; }
  .about-section p { font-size: 1.05rem; line-height: 1.85; color: var(--text-muted); margin-bottom: 1rem; }
  .about-section p:last-child { margin-bottom: 0; }
  .about-section em { color: var(--text); font-style: italic; }
  .about-closing { padding: 3rem 0 0; }
  .about-david-wrap { position: relative; margin-bottom: 3rem; border-radius: 8px; overflow: hidden; }
  .about-david-img { width: 100%; max-height: 480px; object-fit: cover; object-position: center top; display: block; filter: grayscale(20%) contrast(1.05); }
  .about-david-question { position: absolute; bottom: 22%; left: 0; right: 0; padding: 0 2.5rem; background: none; font-family: 'Bebas Neue', sans-serif; font-size: 3.2rem; letter-spacing: 0.04em; line-height: 1.1; color: var(--white); text-shadow: 0 2px 20px rgba(0,0,0,0.9), 0 0 40px rgba(0,0,0,0.8); }
  .about-cta { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
  @media (max-width: 650px) {
    .about-title { font-size: 2.6rem; }
    .about-david-question { font-size: 2.2rem; padding: 2rem 1.5rem 1.5rem; bottom: 8%; }
    .about-wrap { padding: 0 1rem 6rem; }
    .about-hero { padding: 2rem 0 2rem; }
  }
  /* ‚îÄ‚îÄ SPOTIFY SEARCH ‚îÄ‚îÄ */
  .spotify-search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; z-index: 500; max-height: 280px; overflow-y: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.5); display: none; }
  .spotify-search-results.open { display: block; }
  .spotify-result { display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 0.9rem; cursor: pointer; transition: background 0.1s; border-bottom: 1px solid var(--border); }
  .spotify-result:last-child { border-bottom: none; }
  .spotify-result:hover { background: var(--surface2); }
  .spotify-result-art { width: 40px; height: 40px; border-radius: 3px; object-fit: cover; flex-shrink: 0; background: var(--bg); }
  .spotify-result-info { min-width: 0; flex: 1; }
  .spotify-result-song { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.04em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .spotify-result-artist { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .spotify-result-searching { padding: 1rem; text-align: center; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-dim); }
  .notif-bell-wrap { position: relative; }
  .notif-bell-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0.3rem 0.5rem; position: relative; line-height: 1; border-radius: 4px; transition: background 0.15s; }
  .notif-bell-btn:hover { background: var(--surface2); }
  .notif-badge { position: absolute; top: 0; right: 0; background: var(--red); color: white; font-family: 'IBM Plex Mono', monospace; font-size: 0.5rem; font-weight: 700; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 3px; pointer-events: none; }
  .notif-panel { position: absolute; top: calc(100% + 0.6rem); right: 0; width: 320px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); z-index: 400; display: none; max-height: 420px; overflow: hidden; flex-direction: column; }
  .notif-panel.open { display: flex; }
  .notif-panel-header { display: flex; align-items: center; justify-content: space-between; padding: 0.9rem 1rem 0.7rem; border-bottom: 1px solid var(--border); font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); flex-shrink: 0; }
  .notif-mark-read { background: none; border: none; font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--red); cursor: pointer; text-transform: uppercase; letter-spacing: 0.08em; }
  .notif-mark-read:hover { color: var(--red-bright); }
  .notif-list { overflow-y: auto; flex: 1; }
  .notif-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.85rem 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
  .notif-item:hover { background: var(--surface2); }
  .notif-item.unread { background: rgba(204,17,17,0.06); }
  .notif-item.unread:hover { background: rgba(204,17,17,0.1); }
  .notif-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 0.1rem; }
  .notif-body { flex: 1; min-width: 0; }
  .notif-text { font-family: 'Crimson Pro', serif; font-size: 0.92rem; color: var(--text); line-height: 1.45; }
  .notif-text strong { color: var(--white); }
  .notif-time { font-family: 'IBM Plex Mono', monospace; font-size: 0.58rem; color: var(--text-dim); margin-top: 0.25rem; }
  .notif-empty { padding: 2rem; text-align: center; font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; color: var(--text-dim); }
  /* ‚îÄ‚îÄ REACTIONS ‚îÄ‚îÄ */
  .reaction-btn { display: inline-flex; align-items: center; gap: 0.35rem; background: none; border: 1px solid var(--border); border-radius: 20px; padding: 0.3rem 0.75rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
  .reaction-btn:hover { border-color: var(--red-dim); color: var(--white); }
  .reaction-btn.reacted { background: rgba(204,17,17,0.12); border-color: var(--red); color: var(--red); }
  .reaction-btn .reaction-count { font-size: 0.7rem; }
  @media (max-width: 650px) { .notif-panel { width: calc(100vw - 2rem); right: -4rem; } }
  .auth-split { display: grid; grid-template-columns: 1fr 1fr; min-height: 100vh; }
  .auth-image-side { position: relative; overflow: hidden; }
  .auth-split-img { width: 100%; height: 100%; object-fit: cover; object-position: center top; display: block; filter: grayscale(15%) contrast(1.05); }
  .auth-split-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(13,0,0,0.5) 0%, rgba(13,0,0,0.1) 40%, rgba(13,0,0,0.8) 100%); display: flex; flex-direction: column; justify-content: space-between; padding: 2.5rem; }
  .auth-split-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
  .auth-split-logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 0.1em; color: var(--white); flex-shrink: 0; }
  .auth-split-logo span { color: var(--red); }
  .auth-split-tagline { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; color: rgba(240,236,232,0.65); letter-spacing: 0.08em; line-height: 1.7; text-align: right; display: none; }
  .auth-split-question { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; letter-spacing: 0.04em; line-height: 1.1; color: var(--white); text-shadow: 0 2px 20px rgba(0,0,0,0.9), 0 0 40px rgba(0,0,0,0.8); margin-bottom: 0.5rem; }
  .auth-form-side { display: flex; align-items: center; justify-content: center; padding: 2rem; background: var(--bg); }
  .auth-form-side .auth-logo { display: none; }
  .auth-form-side .auth-tagline { display: none; }
  @media (max-width: 780px) {
    .auth-split { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
    .auth-image-side { height: 280px; }
    .auth-split-logo { font-size: 1.3rem; }
    .auth-split-tagline { display: block; font-size: 0.62rem; max-width: 38%; }
    .auth-split-question { font-size: 2rem; position: absolute; bottom: 24%; }
    .auth-split-overlay { padding: 1.5rem; }
    .auth-form-side .auth-logo { display: none; }
    .auth-form-side .auth-tagline { display: none; }
    .auth-form-side { padding: 1.5rem 1.5rem 3rem; align-items: flex-start; }
  }
  .spotify-popup { position: fixed; bottom: 6rem; right: 1.5rem; z-index: 300; background: var(--surface); border: 1px solid #1db954; border-radius: 12px; padding: 1rem 1.1rem; width: 260px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); transform: translateX(320px); opacity: 0; transition: all 0.4s cubic-bezier(0.34,1.56,0.64,1); pointer-events: none; }
  .spotify-popup.show { transform: translateX(0); opacity: 1; pointer-events: all; }
  .spotify-popup-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
  .spotify-popup-title { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: #1db954; display: flex; align-items: center; gap: 0.4rem; }
  .spotify-popup-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 1rem; line-height: 1; padding: 0; transition: color 0.15s; }
  .spotify-popup-close:hover { color: var(--text-muted); }
  .spotify-popup p { font-family: 'Crimson Pro', serif; font-size: 0.92rem; color: var(--text-muted); line-height: 1.55; margin-bottom: 0.9rem; }
  .spotify-connect-btn { width: 100%; background: #1db954; border: none; border-radius: 6px; color: white; font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; padding: 0.65rem; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
  .spotify-connect-btn:hover { background: #1ed760; transform: translateY(-1px); }
  .play-on-spotify-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: #1db954; color: white; border: none; border-radius: 6px; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; padding: 0.55rem 1rem; cursor: pointer; transition: all 0.15s; text-decoration: none; white-space: nowrap; }
  .play-on-spotify-btn:hover { background: #1ed760; transform: translateY(-1px); }
  .play-on-youtube-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: #ff0000; color: white; border: none; border-radius: 6px; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; padding: 0.55rem 1rem; cursor: pointer; transition: all 0.15s; text-decoration: none; white-space: nowrap; }
  .play-on-youtube-btn:hover { background: #cc0000; transform: translateY(-1px); }
</style>
</head>
<body>

<!-- AUTH -->
<div class="view active" id="view-auth">
  <div class="auth-split">

    <!-- LEFT: David Byrne image -->
    <div class="auth-image-side">
      <img src="https://www.rollingstone.com/wp-content/uploads/2023/09/SMS_005.jpg?w=1600&h=900&crop=1" alt="David Byrne" class="auth-split-img" />
      <div class="auth-split-overlay">
        <div class="auth-split-top-row">
          <div class="auth-split-logo">üéµ Wave<span>length</span></div>
          <div class="auth-split-tagline">One song.<br>Every week.<br>Share what's<br>moving you.</div>
        </div>
        <div class="auth-split-question">What do you have<br>to share?</div>
      </div>
    </div>

    <!-- RIGHT: Form -->
    <div class="auth-form-side">
      <div class="center-box">
        <div class="auth-logo" style="margin-bottom:0.2rem">üéµ Wave<span>length</span></div>
        <p class="auth-tagline">One song. Every week. Share what's moving you.</p>
        <div class="auth-tabs">
          <button class="auth-tab active" id="tab-signin" onclick="switchTab('signin')">Sign In</button>
          <button class="auth-tab" id="tab-signup" onclick="switchTab('signup')">Sign Up</button>
        </div>
        <!-- Browse button moved above form fields -->
        <div style="margin-bottom:1.2rem">
          <button class="btn btn-ghost btn-wide" onclick="browseAsGuest()" style="border-color:var(--red-dim);color:var(--text-muted)">üëÄ Just browsing ‚Äî show me around</button>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.2rem">
          <div style="flex:1;height:1px;background:var(--border)"></div>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.58rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em">or sign in</span>
          <div style="flex:1;height:1px;background:var(--border)"></div>
        </div>
        <div id="auth-signin">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="signin-email" placeholder="you@example.com" />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="signin-password" placeholder="Your password" />
          </div>
          <button class="btn btn-primary btn-wide" id="signin-btn" onclick="signIn()">Sign In</button>
          <div id="signin-error" class="form-error" style="margin-top:0.5rem"></div>
          <p style="margin-top:1rem;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--text-dim)">
            <span onclick="showForgotPassword()" style="cursor:pointer;color:var(--text-muted);text-decoration:underline">Forgot password?</span>
          </p>
        </div>
        <div id="auth-signup" style="display:none">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="signup-email" placeholder="you@example.com" />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="signup-password" placeholder="Min. 6 characters" />
          </div>
          <button class="btn btn-primary btn-wide" id="signup-btn" onclick="signUp()">Create Account</button>
          <div id="signup-error" class="form-error" style="margin-top:0.5rem"></div>
        </div>
        <p style="margin-top:1.2rem;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:0.62rem;color:var(--text-dim)">
          <span onclick="showView('about')" style="cursor:pointer;color:var(--text-muted);text-decoration:underline">What is Wavelength?</span>
        </p>
      </div>
    </div>

  </div>
</div>

<!-- FORGOT PASSWORD -->
<div class="view" id="view-forgot">
  <div class="center-screen">
    <div class="center-box">
      <div class="auth-logo">üéµ Wave<span>length</span></div>
      <p class="auth-tagline">Enter your email and we'll send you a reset link.</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="forgot-email" placeholder="you@example.com" />
      </div>
      <button class="btn btn-primary btn-wide" id="forgot-btn" onclick="sendPasswordReset()">Send Reset Link</button>
      <div id="forgot-msg" class="form-error" style="margin-top:0.5rem"></div>
      <p style="margin-top:1.5rem;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--text-dim);cursor:pointer" onclick="showView('auth')">‚Üê Back to Sign In</p>
    </div>
  </div>
</div>

<!-- RESET PASSWORD (shown after clicking email link) -->
<div class="view" id="view-resetpassword">
  <div class="center-screen">
    <div class="center-box">
      <div class="auth-logo">üéµ Wave<span>length</span></div>
      <p class="auth-tagline">Choose a new password for your account.</p>
      <div class="form-group">
        <label>New Password</label>
        <input type="password" id="reset-password" placeholder="Min. 6 characters" />
      </div>
      <div class="form-group">
        <label>Confirm New Password</label>
        <input type="password" id="reset-password2" placeholder="Repeat your password" />
      </div>
      <button class="btn btn-primary btn-wide" id="reset-btn" onclick="saveNewPassword()">Save New Password</button>
      <div id="reset-msg" class="form-error" style="margin-top:0.5rem"></div>
    </div>
  </div>
</div>

<!-- ONBOARDING -->
<div class="view" id="view-onboarding">
  <div class="center-screen">
    <div class="center-box ob-box">
      <h2>üé∂ Set Up Your Profile</h2>
      <p class="sub">You're in! Pick a name and username.</p>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="ob-name" placeholder="e.g. Jamie" />
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="ob-username" placeholder="e.g. jamie_listens" />
        <p class="form-hint">Letters, numbers, and underscores only.</p>
      </div>
      <div class="form-group">
        <label>Your Instrument <span style="color:var(--text-dim)">‚Äî pick your vibe</span></label>
        <div class="instrument-row" id="ob-instruments"></div>
      </div>
      <div class="form-group">
        <label>Avatar Color</label>
        <div class="color-row" id="ob-colors"></div>
      </div>
      <button class="btn btn-primary btn-wide" id="ob-btn" onclick="createProfile()">Enter Wavelength</button>
      <div id="ob-error" class="form-error" style="margin-top:0.5rem"></div>
    </div>
  </div>
</div>

<!-- ABOUT -->
<div class="view" id="view-about">
  <div class="about-wrap">

    <div class="about-hero">
      <div class="about-hero-deco">üéµ</div>
      <div class="week-pill">About</div>
      <h1 class="about-title">Some songs just<br><span>stay with you.</span></h1>
      <p class="about-intro">You know the feeling. It's Tuesday evening and a song comes on and suddenly everything makes sense. Or nothing does. Either way, you need someone to know.</p>
    </div>

    <div class="about-body">

      <div class="about-section">
        <div class="about-section-label">Why we built this</div>
        <p>Wavelength started as a simple idea between friends ‚Äî the kind of people who are always sending each other songs at odd hours with no explanation except <em>"you need to hear this."</em></p>
        <p>We wanted a place that wasn't about follower counts or algorithms or whatever everyone else is listening to. Just the people we actually care about, and one song a week that says something true about where they are right now.</p>
        <p>So we built it.</p>
      </div>

      <div class="about-section">
        <div class="about-section-label">How it works</div>
        <p>Every week, you pick one song. That's it. Not a playlist. Not a mood board. One song ‚Äî the one that's been living in your head, the one that felt right for this particular stretch of days.</p>
        <p>Your friends do the same. And every week you get a small window into where everyone is, told entirely through music.</p>
      </div>

      <div class="about-section">
        <div class="about-section-label">What it becomes</div>
        <p>Over time, your profile becomes something unexpected ‚Äî a real archive of your life told in songs. Scroll back through your picks six months from now and you'll remember exactly what you were going through when you chose each one.</p>
        <p>Music has always been how we mark time. Wavelength just makes that a little more intentional.</p>
      </div>

      <div class="about-section">
        <div class="about-section-label">Who it's for</div>
        <p>People who take music personally. People who want to stay close to the friends who matter, even when life pulls everyone in different directions. People who believe that what someone's listening to on a random Wednesday tells you more about them than anything they'd ever post.</p>
      </div>

    </div>

    <div class="about-closing">
      <div class="about-david-wrap">
        <img src="https://www.rollingstone.com/wp-content/uploads/2023/09/SMS_005.jpg?w=1600&h=900&crop=1" alt="David Byrne" class="about-david-img" />
        <div class="about-david-question">What do you have<br>to share?</div>
      </div>
      <div class="about-cta">
        <button class="btn btn-primary" style="font-size:0.8rem;padding:0.9rem 2rem" onclick="showView('auth')">Join Wavelength</button>
        <button class="btn btn-ghost" style="font-size:0.75rem;padding:0.9rem 1.5rem" onclick="browseAsGuest()">Browse first</button>
      </div>
    </div>

  </div>
</div>

<!-- NAV -->
<nav id="mainNav" style="display:none">
  <div class="logo" onclick="showView('feed')">üéµ Wave<span>length</span></div>
  <div class="nav-center">
    <button class="nav-link" id="nav-feed" onclick="showView('feed')">Feed</button>
    <button class="nav-link" id="nav-members" onclick="showView('members')">Members</button>
    <button class="nav-link" id="nav-myprofile" onclick="showView('profile',{userId:currentUser&&currentUser.id})">My Profile</button>
    <button class="nav-link" id="nav-about" onclick="showView('about')">About</button>
  </div>
  <div class="nav-actions">
    <span class="nav-user" id="nav-user"></span>
    <button class="btn btn-primary" id="nav-pick-btn" onclick="openPickModal()">+ This Week</button>
    <button class="btn btn-primary" id="nav-join-btn" style="display:none" onclick="showView('auth')">Join Wavelength</button>
    <!-- NOTIFICATION BELL -->
    <div class="notif-bell-wrap" id="notif-bell-wrap" style="display:none">
      <button class="notif-bell-btn" id="notif-bell" onclick="toggleNotifPanel()">
        üîî
        <span class="notif-badge" id="notif-badge" style="display:none">0</span>
      </button>
      <div class="notif-panel" id="notif-panel">
        <div class="notif-panel-header">
          <span>Notifications</span>
          <button onclick="markAllRead()" class="notif-mark-read">Mark all read</button>
        </div>
        <div class="notif-list" id="notif-list"><div class="notif-empty">No notifications yet</div></div>
      </div>
    </div>
    <div class="nav-dropdown" id="nav-dropdown">
      <button class="nav-dropdown-toggle" onclick="toggleNavDropdown()">Menu ‚ñæ</button>
      <div class="nav-dropdown-menu" id="nav-dropdown-menu">
        <button class="nav-dropdown-item" id="nav-settings-btn" onclick="closeNavDropdown();showView('settings')">‚öô Settings</button>
        <button class="nav-dropdown-item danger" id="nav-signout-btn" onclick="closeNavDropdown();signOut()">Sign Out</button>
      </div>
    </div>
  </div>
</nav>

<!-- FEED -->
<div class="view" id="view-feed">
  <div id="guest-banner" style="display:none;background:var(--surface);border-bottom:1px solid var(--red-dim);padding:0.75rem 2rem;text-align:center">
    <span style="font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--text-muted)">You're browsing as a guest &mdash; </span>
    <span onclick="showView('auth')" style="font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--red);cursor:pointer;text-decoration:underline">Sign up to make your own picks and join the community ‚Üí</span>
  </div>
  <div class="feed-header">
    <div class="feed-header-deco">üé∏</div>
    <div class="week-pill" id="feed-pill">Week 1</div>
    <h1>This Week's <span>Picks</span></h1>
    <p class="feed-meta" id="feed-range"></p>
  </div>
  <div class="friends-grid" id="friends-grid">
    <div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>
  </div>
</div>

<!-- MEMBERS -->
<div class="view" id="view-members">
  <div class="page-header">
    <div class="page-header-deco">üé∑</div>
    <div class="week-pill">Community</div>
    <h1>All <span>Members</span></h1>
    <p>Browse everyone on Wavelength and visit their profiles</p>
  </div>
  <div class="members-grid" id="members-grid">
    <div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>
  </div>
</div>

<!-- PROFILE -->
<div class="view" id="view-profile">
  <div class="profile-wrap">
    <button class="back-btn" id="profile-back">‚Üê Back</button>
  </div>
  <div class="profile-hero" id="profile-hero">
    <div class="profile-hero-deco">üé∏</div>
  </div>
  <div class="weeks-list" id="weeks-list"></div>
</div>

<!-- SONG DETAIL -->
<div class="view" id="view-songdetail">
  <div class="song-wrap">
    <div style="padding-top:1.5rem;margin-bottom:0.5rem">
      <button class="back-btn" id="song-back">‚Üê Back to Profile</button>
    </div>
    <div id="song-content"></div>
  </div>
</div>

<!-- SETTINGS -->
<div class="view" id="view-settings">
  <div class="settings-wrap">
    <button class="back-btn" style="margin-bottom:1.5rem" onclick="showView('feed')">‚Üê Back to Feed</button>
    <h2>‚öô Settings</h2>
    <p class="sub">Update your profile or find friends to follow</p>
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="s-name" />
    </div>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="s-username" />
    </div>
    <div class="form-group">
      <label>Your Instrument</label>
      <div class="instrument-row" id="s-instruments"></div>
    </div>
    <div class="form-group">
      <label>Avatar Color</label>
      <div class="color-row" id="s-colors"></div>
    </div>
    <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
    <hr class="divider">
    <h3 style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:0.06em;margin-bottom:0.5rem">Find Friends</h3>
    <p style="font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--text-muted);margin-bottom:1rem">Search by username to follow people</p>
    <div style="display:flex;gap:0.75rem;margin-bottom:1rem">
      <input type="text" id="search-q" placeholder="Search username..." style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:0.65rem 0.9rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:1rem;outline:none" />
      <button class="btn btn-ghost" onclick="searchUsers()">Search</button>
    </div>
    <div id="search-results"></div>
    <hr class="divider">
    <h3 style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:0.06em;margin-bottom:0.5rem">Change Password</h3>
    <p style="font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--text-muted);margin-bottom:1rem">Set a new password for your account</p>
    <div class="form-group">
      <label>New Password</label>
      <input type="password" id="cp-password" placeholder="Min. 6 characters" />
    </div>
    <div class="form-group">
      <label>Confirm New Password</label>
      <input type="password" id="cp-password2" placeholder="Repeat your password" />
    </div>
    <button class="btn btn-primary" id="cp-btn" onclick="changePassword()">Update Password</button>
    <div id="cp-msg" class="form-error" style="margin-top:0.5rem"></div>
    <hr class="divider">
    <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
    <div style="height:4rem"></div>
  </div>
</div>

<!-- PICK MODAL -->
<div class="modal-overlay" id="pick-modal">
  <div class="modal">
    <button class="modal-close" onclick="closePickModal()">‚úï</button>
    <h3>üéµ This Week's Pick</h3>
    <p class="modal-sub" id="pick-week-label"></p>

    <!-- SPOTIFY SEARCH -->
    <div class="form-group" style="position:relative">
      <label>Search for a song</label>
      <div style="display:flex;gap:0.5rem">
        <input type="text" id="p-search" placeholder="Type a song or artist..." oninput="debounceSpotifySearch()" autocomplete="off" style="flex:1" />
        <button class="btn btn-ghost" onclick="clearPickSelection()" id="p-clear-btn" style="display:none;font-size:0.6rem;padding:0.4rem 0.7rem">‚úï Clear</button>
      </div>
      <div class="spotify-search-results" id="spotify-search-results"></div>
    </div>

    <!-- SELECTED SONG PREVIEW -->
    <div id="pick-selected-preview" style="display:none;margin-bottom:1.2rem">
      <div style="display:flex;align-items:center;gap:0.9rem;background:var(--surface2);border:1px solid var(--red-dim);border-radius:6px;padding:0.75rem">
        <img id="pick-preview-art" src="" alt="" style="width:52px;height:52px;border-radius:4px;object-fit:cover;flex-shrink:0" />
        <div style="min-width:0">
          <div id="pick-preview-song" style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:0.04em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
          <div id="pick-preview-artist" style="font-family:'IBM Plex Mono',monospace;font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem"></div>
          <div id="pick-preview-year" style="font-family:'IBM Plex Mono',monospace;font-size:0.58rem;color:var(--text-dim);margin-top:0.1rem"></div>
        </div>
        <div style="margin-left:auto;flex-shrink:0;color:#1db954;font-size:0.7rem">‚úì Selected</div>
      </div>
    </div>

    <!-- HIDDEN AUTO-FILLED FIELDS -->
    <input type="hidden" id="p-song" />
    <input type="hidden" id="p-artist" />
    <input type="hidden" id="p-art" />
    <input type="hidden" id="p-spotify" />
    <input type="hidden" id="p-year" />

    <!-- YOUTUBE FALLBACK -->
    <div class="form-group" id="p-youtube-group">
      <label>YouTube Link <span style="color:var(--text-dim)">(optional ‚Äî if not on Spotify)</span></label>
      <input type="text" id="p-youtube" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <div class="form-group">
      <label>Why this song? <span style="color:var(--text-dim)">(optional)</span></label>
      <textarea id="p-note" placeholder="What makes this your pick this week?"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Vibe Tags <span style="color:var(--text-dim)">(comma-separated)</span></label>
        <input type="text" id="p-tags" placeholder="e.g. alt-rock, melancholic" />
      </div>
    </div>
    <div class="form-group">
      <label>About the Artist <span style="color:var(--text-dim)">(optional)</span></label>
      <textarea id="p-bandinfo" placeholder="A little background on the artist..."></textarea>
    </div>
    <button class="btn btn-primary btn-wide" id="pick-save-btn" onclick="savePick()">Save Pick</button>
    <div id="pick-error" class="form-error" style="margin-top:0.5rem"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-nav" id="mobileNav" style="display:none">
  <div class="mobile-nav-inner">
    <button class="mobile-nav-btn" id="mnav-feed" onclick="showView('feed')">
      <span class="mnb-icon">üéµ</span>
      <span class="mnb-label">Feed</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-members" onclick="showView('members')">
      <span class="mnb-icon">üé∏</span>
      <span class="mnb-label">Members</span>
    </button>
    <button class="mobile-pick-btn" id="mobile-pick-btn" onclick="openPickModal()">Ôºã</button>
    <button class="mobile-nav-btn" id="mnav-myprofile" onclick="showView('profile',{userId:currentUser&&currentUser.id})">
      <span class="mnb-icon">üéß</span>
      <span class="mnb-label">Profile</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-about" onclick="showView('about')">
      <span class="mnb-icon">‚ÑπÔ∏è</span>
      <span class="mnb-label">About</span>
    </button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ HARDCODED CREDENTIALS ‚Äî no setup screen needed ‚îÄ‚îÄ
const SUPABASE_URL = "https://ozkrjvyuptwlzaqhqljc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96a3Jqdnl1cHR3bHphcWhxbGpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODI2NDksImV4cCI6MjA4Njk1ODY0OX0.SqNJLTYZwnHV5kywP1PyLdp9-y76ugu-PyfL7BOGLIA";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storageKey: 'wavelength-auth'
  }
});

let currentUser = null, currentProfile = null;

// ‚îÄ‚îÄ SIMILAR MUSIC ‚îÄ‚îÄ
const SIMILAR_SONGS = {'kate bush':['Running Up That Hill ‚Äî Kate Bush','Wuthering Heights ‚Äî Kate Bush','Cloudbusting ‚Äî Kate Bush','The Hounds of Love ‚Äî Kate Bush'],'radiohead':['Exit Music (For a Film) ‚Äî Radiohead','How to Disappear Completely ‚Äî Radiohead','Street Spirit ‚Äî Radiohead','Reckoner ‚Äî Radiohead'],'kendrick lamar':['Alright ‚Äî Kendrick Lamar','DNA. ‚Äî Kendrick Lamar','m.A.A.d city ‚Äî Kendrick Lamar','Swimming Pools ‚Äî Kendrick Lamar'],'frank ocean':['Nights ‚Äî Frank Ocean','Self Control ‚Äî Frank Ocean','Pink + White ‚Äî Frank Ocean','Seigfried ‚Äî Frank Ocean'],'tame impala':['Let It Happen ‚Äî Tame Impala','Feels Like We Only Go Backwards ‚Äî Tame Impala','Eventually ‚Äî Tame Impala','New Person, Same Old Mistakes ‚Äî Tame Impala'],'the national':['Bloodbuzz Ohio ‚Äî The National','Sorrow ‚Äî The National','Afraid of Everyone ‚Äî The National','Terrible Love ‚Äî The National'],'bon iver':['Holocene ‚Äî Bon Iver','Skinny Love ‚Äî Bon Iver','Towers ‚Äî Bon Iver','Michicant ‚Äî Bon Iver'],'phoebe bridgers':['Motion Sickness ‚Äî Phoebe Bridgers','Savior Complex ‚Äî Phoebe Bridgers','Funeral ‚Äî Phoebe Bridgers']};
const SIMILAR_ARTISTS = {
  // ‚îÄ‚îÄ INDIE / ALTERNATIVE ‚îÄ‚îÄ
  'radiohead':['Portishead','Thom Yorke','Sigur R√≥s','The National','Mogwai','Boards of Canada'],
  'the national':['Frightened Rabbit','Bon Iver','Iron & Wine','Sufjan Stevens','Villagers','The War on Drugs'],
  'bon iver':['The National','Fleet Foxes','Sufjan Stevens','Elbow','Gregory Alan Isakov','S. Carey'],
  'tame impala':['MGMT','Unknown Mortal Orchestra','Pond','Flaming Lips','Allah-Las','Mac DeMarco'],
  'arctic monkeys':['The Last Shadow Puppets','Miles Kane','Interpol','The Strokes','Humbug-era Black Keys','Richard Hawley'],
  'the strokes':['Arctic Monkeys','Interpol','Yeah Yeah Yeahs','LCD Soundsystem','Clap Your Hands Say Yeah','The Walkmen'],
  'interpol':['The Strokes','Editors','Doves','The National','White Lies','She Wants Revenge'],
  'lcd soundsystem':['Hot Chip','Caribou','Four Tet','!!! (Chk Chk Chk)','New Order','Daft Punk'],
  'mgmt':['Tame Impala','Of Montreal','Animal Collective','Flaming Lips','Ariel Pink','Neon Indian'],
  'vampire weekend':['Rostam','Paul Simon','Ezra Koenig','Ra Ra Riot','Dirty Projectors','Grizzly Bear'],
  'grizzly bear':['Fleet Foxes','Dirty Projectors','Animal Collective','Beach House','Department of Eagles','Deerhunter'],
  'fleet foxes':['Grizzly Bear','Iron & Wine','Bon Iver','My Morning Jacket','Father John Misty','Joanna Newsom'],
  'beach house':['Mazzy Star','Cocteau Twins','Grouper','Slowdive','Cigarettes After Sex','Still Woozy'],
  'car seat headrest':['Alex G','Girlpool','Palehound','Snail Mail','illuminati hotties','Julien Baker'],
  'the war on drugs':['Kurt Vile','Real Estate','Phosphorescent','Sun Kil Moon','Jason Isbell','Wilco'],
  'kurt vile':['The War on Drugs','Real Estate','Steve Gunn','Woods','Angel Olsen','Courtney Barnett'],
  'courtney barnett':['Kurt Vile','Palehound','Snail Mail','Waxahatchee','Julien Baker','Lucy Dacus'],
  'snail mail':['Soccer Mommy','Girlpool','Palehound','Jay Som','Julien Baker','Hovvdy'],
  'soccer mommy':['Snail Mail','Jay Som','Frankie Cosmos','Hovvdy','Julia Jacklin','Palehound'],
  'big thief':['Adrianne Lenker','Waxahatchee','Tiny Ruins','Hand Habits','Faye Webster','Indigo De Souza'],
  'waxahatchee':['Big Thief','Hurray for the Riff Raff','Mountain Goats','Julien Baker','Angel Olsen','Neko Case'],
  'angel olsen':['Sharon Van Etten','Waxahatchee','Marissa Nadler','Hand Habits','Julia Jacklin','Aldous Harding'],
  'sharon van etten':['Angel Olsen','Julien Baker','Phoebe Bridgers','Adrianne Lenker','Hand Habits','Weyes Blood'],
  'weyes blood':['Father John Misty','Judee Sill','Joni Mitchell','Karen Dalton','Aldous Harding','Julia Holter'],
  'father john misty':['Fleet Foxes','Weyes Blood','Kevin Morby','Jonathan Wilson','Unknown Mortal Orchestra','Perfume Genius'],
  'perfume genius':['Sufjan Stevens','Weyes Blood','Bon Iver','Julia Holter','How to Dress Well','Aldous Harding'],
  'sufjan stevens':['Bon Iver','Joanna Newsom','Fleet Foxes','Perfume Genius','Weyes Blood','Owen Pallett'],
  'phoebe bridgers':['Julien Baker','Lucy Dacus','boygenius','Angel Olsen','Soccer Mommy','Snail Mail'],
  'julien baker':['Phoebe Bridgers','Lucy Dacus','boygenius','Hop Along','Palehound','Hand Habits'],
  'boygenius':['Phoebe Bridgers','Julien Baker','Lucy Dacus','Angel Olsen','Sharon Van Etten','Big Thief'],
  'deerhunter':['Atlas Sound','Real Estate','Grizzly Bear','Beach House','Wild Nothing','Ducktails'],
  'real estate':['Deerhunter','Wild Nothing','Beach Fossils','Woods','Ducktails','The Clientele'],
  'mac demarco':['Alex G','Homeshake','Mild High Club','Drugdealer','Men I Trust','Whitney'],
  'alex g':['Car Seat Headrest','Hand Habits','Hovvdy','Florist','Tomberlin','Snail Mail'],
  'mitski':['Japanese Breakfast','Hand Habits','Palehound','Soccer Mommy','Advance Base','Florist'],
  'japanese breakfast':['Mitski','illuminati hotties','Alex G','Snail Mail','Hand Habits','Caroline Rose'],
  'faye webster':['Big Thief','Hand Habits','Charlotte Day Wilson','Beabadoobee','Men I Trust','Hovvdy'],
  'men i trust':['Beach House','Wild Nothing','Mac DeMarco','Whitney','Homeshake','Still Woozy'],
  'whitney':['Shintaro Sakamoto','Men I Trust','Hovvdy','Hand Habits','Mild High Club','Whitney Rose'],
  'wilco':['Uncle Tupelo','Son Volt','Jay Farrar','Tweedy','The War on Drugs','Silver Jews'],
  // ‚îÄ‚îÄ INDIE POP / DREAM POP ‚îÄ‚îÄ
  'kate bush':['Bj√∂rk','Florence + The Machine','Tori Amos','Bat for Lashes','Anna Calvi','St. Vincent'],
  'bj√∂rk':['Kate Bush','Sigur R√≥s','Fever Ray','M√∫m','Arca','Holly Herndon'],
  'florence + the machine':['Kate Bush','Bat for Lashes','Lykke Li','Anna Calvi','Daughter','Oh Wonder'],
  'st. vincent':['Talking Heads','David Byrne','Annie Clark','Cate Le Bon','Rostam','Sufjan Stevens'],
  'lorde':['Ella Yelich-O\'Connor','Lana Del Rey','Halsey','Banks','Billie Eilish','Sza'],
  'lana del rey':['Lorde','Weyes Blood','Mazzy Star','Hope Sandoval','Beach House','Cigarettes After Sex'],
  'cigarettes after sex':['Beach House','Mazzy Star','Lana Del Rey','Her','Wild Nothing','Chelsea Wolfe'],
  'billie eilish':['Lorde','Olivia Rodrigo','Clairo','Remi Wolf','girl in red','Role Model'],
  'clairo':['Beabadoobee','Soccer Mommy','Rex Orange County','Still Woozy','Men I Trust','Snail Mail'],
  'beabadoobee':['Clairo','Soccer Mommy','Snail Mail','Remi Wolf','girl in red','Spacey Jane'],
  'olivia rodrigo':['Billie Eilish','Lorde','Gracie Abrams','Sabrina Carpenter','Girl in Red','Maisie Peters'],
  'rex orange county':['Still Woozy','Dominic Fike','Clairo','Men I Trust','Homeshake','boy pablo'],
  'still woozy':['Rex Orange County','Dominic Fike','Clairo','Remi Wolf','Role Model','Jake Wesley Rogers'],
  'remi wolf':['Still Woozy','Dominic Fike','Clairo','Brockhampton','Rex Orange County','Steve Lacy'],
  'dominic fike':['Rex Orange County','Still Woozy','Omar Apollo','Remi Wolf','Steve Lacy','Brockhampton'],
  // ‚îÄ‚îÄ R&B / SOUL / NEO-SOUL ‚îÄ‚îÄ
  'frank ocean':['Syd','Steve Lacy','Brent Faiyaz','Daniel Caesar','Sampha','James Blake'],
  'james blake':['Bon Iver','Sampha','Moses Sumney','How to Dress Well','Sohn','Banks'],
  'sampha':['James Blake','Sohn','Kwabs','Moses Sumney','Frank Ocean','Kojey Radical'],
  'daniel caesar':['Frank Ocean','H.E.R.','Lucky Daye','Brent Faiyaz','Syd','Charlotte Day Wilson'],
  'brent faiyaz':['Frank Ocean','Daniel Caesar','Syd','Steve Lacy','Ari Lennox','Lucky Daye'],
  'syd':['Frank Ocean','Steve Lacy','Brent Faiyaz','Ravyn Lenae','Charlotte Day Wilson','H.E.R.'],
  'steve lacy':['Frank Ocean','Syd','Brent Faiyaz','Rex Orange County','Remi Wolf','Ravyn Lenae'],
  'h.e.r.':['Jhen√© Aiko','Kehlani','Sza','Ari Lennox','Summer Walker','Alicia Keys'],
  'sza':['H.E.R.','Jhen√© Aiko','Summer Walker','Kehlani','Ari Lennox','Ravyn Lenae'],
  'jhen√© aiko':['Sza','H.E.R.','Kehlani','Summer Walker','Banks','Snoh Aalegra'],
  'summer walker':['Sza','H.E.R.','Kehlani','Jhen√© Aiko','Ari Lennox','Lucky Daye'],
  'kehlani':['Sza','H.E.R.','Jhen√© Aiko','Summer Walker','Tinashe','Ravyn Lenae'],
  'moses sumney':['Sampha','James Blake','Perfume Genius','Bon Iver','How to Dress Well','Anohni'],
  'blood orange':['Frank Ocean','Solange','Kelela','Arca','How to Dress Well','Kindness'],
  'solange':['Blood Orange','Kelela','Sza','Frank Ocean','Erykah Badu','Janelle Mon√°e'],
  'janelle mon√°e':['Solange','Prince','Erykah Badu','Cindi Mayweather','St. Vincent','Lianne La Havas'],
  'erykah badu':['D\'Angelo','Lauryn Hill','Bilal','Jill Scott','Common','Mos Def'],
  'd\'angelo':['Erykah Badu','Maxwell','Lauryn Hill','Bilal','Prince','Anthony Hamilton'],
  // ‚îÄ‚îÄ HIP-HOP / RAP ‚îÄ‚îÄ
  'kendrick lamar':['J. Cole','Isaiah Rashad','ScHoolboy Q','Jay Rock','Ab-Soul','SZA'],
  'j. cole':['Kendrick Lamar','Drake','Big K.R.I.T.','Wale','Dreamville','Bas'],
  'earl sweatshirt':['MF DOOM','Mach-Hommy','MIKE','billy woods','Armand Hammer','Boldly'],
  'tyler the creator':['Frank Ocean','Odd Future','Vince Staples','BROCKHAMPTON','Kali Uchis','Rex Orange County'],
  'vince staples':['Tyler the Creator','Earl Sweatshirt','Danny Brown','Saba','Buddy','Freddie Gibbs'],
  'danny brown':['Vince Staples','JPEGMAFIA','Death Grips','clipping.','Open Mike Eagle','aesop rock'],
  'jpegmafia':['Danny Brown','Death Grips','clipping.','serpentwithfeet','Injury Reserve','Show Me The Body'],
  'death grips':['JPEGMAFIA','clipping.','Show Me The Body','Daughters','Merzbow','Ho99o9'],
  'childish gambino':['Frank Ocean','Tyler the Creator','Chance the Rapper','Donald Glover','Janelle Mon√°e','Blood Orange'],
  'chance the rapper':['Childish Gambino','Noname','Saba','Mick Jenkins','Joey Purp','Knox Fortune'],
  'noname':['Saba','Chance the Rapper','Mick Jenkins','Tierra Whack','Lianne La Havas','Jamila Woods'],
  'saba':['Noname','Chance the Rapper','Mick Jenkins','Femdot','Ravyn Lenae','Smino'],
  'freddie gibbs':['Madlib','Pusha T','Boldy James','Benny the Butcher','Ransom','Vince Staples'],
  'mf doom':['Madlib','Ghostface Killah','Czarface','Danger Doom','Captain Murphy','Billy Woods'],
  'outkast':['Goodie Mob','Erykah Badu','Janelle Mon√°e','UGK','Dungeon Family','Cee-Lo Green'],
  'kanye west':['Kid Cudi','Chance the Rapper','Pusha T','Common','Jay-Z','Childish Gambino'],
  'kid cudi':['Kanye West','Travis Scott','Pusha T','Chip tha Ripper','Don Broco','The Neighbourhood'],
  'travis scott':['Kid Cudi','Young Thug','Drake','Future','Nav','Don Toliver'],
  'drake':['J. Cole','Travis Scott','Future','PartyNextDoor','dvsn','Majid Jordan'],
  'mac miller':['Chance the Rapper','J. Cole','Tyler the Creator','Joey Bada$$','Logic','Vince Staples'],
  // ‚îÄ‚îÄ ELECTRONIC / DANCE ‚îÄ‚îÄ
  'four tet':['Caribou','Bonobo','Jon Hopkins','Floating Points','Nicolas Jaar','Burial'],
  'caribou':['Four Tet','Bonobo','Jon Hopkins','Floating Points','Nils Frahm','Com Truise'],
  'bonobo':['Caribou','Four Tet','Tycho','Emancipator','Catching Flies','Maribou State'],
  'burial':['Four Tet','The Caretaker','Actress','Boards of Canada','Andy Stott','Demdike Stare'],
  'boards of canada':['Burial','Aphex Twin','Autechre','Plaid','Bibio','Tycho'],
  'aphex twin':['Boards of Canada','Autechre','Squarepusher','Plaid','Luke Vibert','Orbital'],
  'nicolas jaar':['Actress','Four Tet','Burial','The Field','Ben Frost','Objekt'],
  'jon hopkins':['Nils Frahm','Olafur Arnalds','Rival Consoles','Max Richter','Peter Broderick','Floating Points'],
  'floating points':['Four Tet','Caribou','Jon Hopkins','Sohn','Matthew Halsall','Yussef Kamaal'],
  'james holden':['Nicolas Jaar','Andy Stott','Objekt','Function','Demdike Stare','Actress'],
  'daft punk':['LCD Soundsystem','Justice','Kavinsky','Moderat','Phoenix','Air'],
  'justice':['Daft Punk','Boys Noize','Kavinsky','SebastiAn','Gesaffelstein','Chromatics'],
  'tycho':['Bonobo','Washed Out','Emancipator','Catching Flies','Maribou State','S U R V I V E'],
  'washed out':['Tycho','Toro y Moi','Neon Indian','Small Black','How to Dress Well','Ducktails'],
  'toro y moi':['Washed Out','Neon Indian','Tycho','Small Black','How to Dress Well','Com Truise'],
  'moderat':['Modeselektor','Apparat','Nils Frahm','Jon Hopkins','Rival Consoles','Sohn'],
  'bicep':['Four Tet','Floating Points','Caribou','Jon Hopkins','Peggy Gou','Mall Grab'],
  'disclosure':['AlunaGeorge','Tourist','Duke Dumont','George FitzGerald','Julio Bashmore','Shadow Child'],
  // ‚îÄ‚îÄ ROCK / POST-PUNK / NOISE ‚îÄ‚îÄ
  'david bowie':['Iggy Pop','Lou Reed','Brian Eno','Roxy Music','T. Rex','Nick Cave'],
  'the cure':['Siouxsie and the Banshees','Bauhaus','The Smiths','Joy Division','Cocteau Twins','Wire'],
  'the smiths':['Morrissey','Johnny Marr','The Cure','New Order','Aztec Camera','Lloyd Cole'],
  'joy division':['New Order','The Cure','Bauhaus','Siouxsie and the Banshees','Wire','The Fall'],
  'new order':['Joy Division','The Cure','The Smiths','Depeche Mode','Electronic','Pet Shop Boys'],
  'depeche mode':['New Order','Tears for Fears','Pet Shop Boys','Soft Cell','The Cure','Ultravox'],
  'talking heads':['David Byrne','Brian Eno','Television','Pere Ubu','XTC','Devo'],
  'pixies':['Dinosaur Jr.','Husker Du','Sebadoh','Guided by Voices','Pavement','Archers of Loaf'],
  'pavement':['Guided by Voices','Sebadoh','Silver Jews','Built to Spill','Neutral Milk Hotel','Yo La Tengo'],
  'neutral milk hotel':['The Microphones','Bright Eyes','Mount Eerie','Okkervil River','Sufjan Stevens','Songs: Ohia'],
  'mount eerie':['The Microphones','Phil Elverum','Sun Kil Moon','Grouper','Marissa Nadler','Bonnie Prince Billy'],
  'built to spill':['Guided by Voices','Pavement','Dinosaur Jr.','Sebadoh','Modest Mouse','Archers of Loaf'],
  'modest mouse':['Built to Spill','Pavement','The Shins','Iron & Wine','Death Cab for Cutie','Ugly Casanova'],
  'the shins':['Modest Mouse','Death Cab for Cutie','Iron & Wine','Bright Eyes','Sufjan Stevens','Rilo Kiley'],
  'death cab for cutie':['The Shins','Iron & Wire','Bright Eyes','Rilo Kiley','Pedro the Lion','The Postal Service'],
  'bright eyes':['Conor Oberst','Neutral Milk Hotel','Pedro the Lion','The Mountain Goats','Death Cab for Cutie','Jason Molina'],
  'the mountain goats':['John Darnielle','Bright Eyes','Okkervil River','Songs: Ohia','Will Oldham','Silver Jews'],
  'yo la tengo':['Guided by Voices','Pavement','The Velvet Underground','Galaxie 500','Mazzy Star','Low'],
  'low':['Codeine','Galaxie 500','Microphones','Grouper','Bedhead','Songs: Ohia'],
  'slowdive':['Cocteau Twins','My Bloody Valentine','Ride','Lush','Pale Saints','Chapterhouse'],
  'my bloody valentine':['Slowdive','Ride','Lush','Swervedriver','Pale Saints','A Place to Bury Strangers'],
  'cocteau twins':['This Mortal Coil','Dead Can Dance','Slowdive','Beach House','Mazzy Star','Grouper'],
  'mazzy star':['Cocteau Twins','Beach House','Hope Sandoval','Cigarettes After Sex','Galaxie 500','Low'],
  'nick cave':['The Bad Seeds','Mark Lanegan','Tom Waits','Leonard Cohen','Crime & the City Solution','Rowland S. Howard'],
  'tom waits':['Nick Cave','Captain Beefheart','Leonard Cohen','Scott Walker','Mark Lanegan','Waits'],
  'leonard cohen':['Nick Cave','Tom Waits','Bob Dylan','John Cale','Scott Walker','Mark Lanegan'],
  'the velvet underground':['Lou Reed','John Cale','Nico','Television','Patti Smith','Iggy Pop'],
  'wire':['Gang of Four','The Fall','Mission of Burma','Public Image Ltd.','Swell Maps','Essential Logic'],
  'gang of four':['Wire','Public Image Ltd.','The Fall','Magazine','The Pop Group','Pere Ubu'],
  'television':['Talking Heads','Patti Smith','The Velvet Underground','Pere Ubu','Wire','The Feelies'],
  'sonic youth':['Dinosaur Jr.','Pixies','Sebadoh','Pavement','Guided by Voices','Shellac'],
  'dinosaur jr.':['Sebadoh','Sonic Youth','Pixies','Guided by Voices','Superchunk','Lemonheads'],
  'the church':['Echo & the Bunnymen','The Chameleons','Felt','The Sound','The Verlaines','The Go-Betweens'],
  'echo & the bunnymen':['The Teardrop Explodes','The Church','The Chameleons','The Sound','Felt','Comsat Angels'],
  'the jesus and mary chain':['My Bloody Valentine','Slowdive','Lush','Ride','The Cure','Swervedriver'],
  'spiritualized':['Spacemen 3','The Brian Jonestown Massacre','Primal Scream','Bark Psychosis','Mogwai','Godspeed You! Black Emperor'],
  'mogwai':['Godspeed You! Black Emperor','Explosions in the Sky','Sigur R√≥s','65daysofstatic','Russian Circles','Tortoise'],
  'godspeed you! black emperor':['Mogwai','Explosions in the Sky','Sigur R√≥s','Silver Mt. Zion','This Will Destroy You','Mono'],
  'explosions in the sky':['Godspeed You! Black Emperor','Mogwai','Sigur R√≥s','This Will Destroy You','Hammock','Caspian'],
  'sigur r√≥s':['Explosions in the Sky','Mogwai','√ìlafur Arnalds','Nils Frahm','Johann Johannsson','J√≥hann J√≥hannsson'],
  'radiohead':['Portishead','Thom Yorke','Sigur R√≥s','The National','Mogwai','Boards of Canada'],
  'portishead':['Massive Attack','Tricky','Bj√∂rk','Radiohead','Archive','Lamb'],
  'massive attack':['Portishead','Tricky','Bj√∂rk','Goldie','Lamb','Archive'],
  'nick drake':['John Martyn','Sandy Denny','Tim Buckley','Fred Neil','Judee Sill','Vashti Bunyan'],
  'john martyn':['Nick Drake','Sandy Denny','Richard Thompson','Bert Jansch','Tim Buckley','Fairport Convention'],
  'vashti bunyan':['Nick Drake','Judee Sill','Sandy Denny','Sibylle Baier','Linda Perhacs','Karen Dalton'],
  // ‚îÄ‚îÄ FOLK / AMERICANA / COUNTRY ‚îÄ‚îÄ
  'iron & wine':['Fleet Foxes','Bon Iver','Sufjan Stevens','Death Cab for Cutie','The Shins','Calexico'],
  'joanna newsom':['Vashti Bunyan','Devendra Banhart','Sufjan Stevens','Weyes Blood','Julia Holter','CocoRosie'],
  'devendra banhart':['Joanna Newsom','Sufjan Stevens','Cate Le Bon','Vetiver','Feathers','Jos√© Gonz√°lez'],
  'jason isbell':['Drive-By Truckers','Americana','Sturgill Simpson','John Prine','Lucinda Williams','Ryan Adams'],
  'sturgill simpson':['Jason Isbell','Colter Wall','Whitey Morgan','Chris Stapleton','Tyler Childers','Margo Price'],
  'tyler childers':['Colter Wall','Jason Isbell','Sturgill Simpson','Whitey Morgan','Sierra Ferrell','Charley Crockett'],
  'colter wall':['Tyler Childers','Jason Isbell','Sturgill Simpson','Chris Stapleton','Charley Crockett','Ian Noe'],
  'the mountain goats':['John Darnielle','Bright Eyes','Okkervil River','Songs: Ohia','Will Oldham','Silver Jews'],
  'bonnie prince billy':['Will Oldham','Silver Jews','Songs: Ohia','Smog','Mount Eerie','Magnolia Electric Co.'],
  'neko case':['Waxahatchee','Calexico','New Pornographers','Neko Case','Gillian Welch','Iris DeMent'],
  'gillian welch':['David Rawlings','Iris DeMent','Lucinda Williams','Emmylou Harris','Alison Krauss','Townes Van Zandt'],
  // ‚îÄ‚îÄ JAZZ / SOUL CROSSOVER ‚îÄ‚îÄ
  'bill evans':['Keith Jarrett','Brad Mehldau','Herbie Hancock','Paul Desmond','Miles Davis','Chick Corea'],
  'miles davis':['John Coltrane','Herbie Hancock','Bill Evans','Wayne Shorter','Thelonious Monk','Charles Mingus'],
  'john coltrane':['Miles Davis','Pharoah Sanders','Albert Ayler','Wayne Shorter','McCoy Tyner','Archie Shepp'],
  'esperanza spalding':['Norah Jones','Jos√© James','Gregory Porter','Lianne La Havas','C√©cile McLorin Salvant','Malia'],
  'lianne la havas':['Laura Mvula','Esperanza Spalding','Sault','Celeste','Noname','Jamila Woods'],
  'sault':['Lianne La Havas','Blood Orange','Solange','Cleo Sol','Celeste','Little Simz'],
  'little simz':['Sault','Noname','Saba','Kojey Radical','Dave','Loyle Carner'],
  // ‚îÄ‚îÄ POP ‚îÄ‚îÄ
  'harry styles':['Niall Horan','Louis Tomlinson','Shawn Mendes','Conan Gray','Rex Orange County','Dominic Fike'],
  'taylor swift':['Gracie Abrams','Olivia Rodrigo','Sabrina Carpenter','Lorde','Haim','Kacey Musgraves'],
  'kacey musgraves':['Orville Peck','Lana Del Rey','Weyes Blood','Angel Olsen','Brandi Carlile','Maren Morris'],
  'haim':['Fleetwood Mac','Jenny Lewis','Best Coast','Waxahatchee','Lucius','First Aid Kit'],
  'first aid kit':['Haim','Fleet Foxes','Emmylou Harris','The Staves','Laura Marling','Lucius'],
  'laura marling':['First Aid Kit','Aldous Harding','Joanna Newsom','Richard Thompson','Joni Mitchell','Marissa Nadler'],
  'joni mitchell':['Carole King','Laura Nyro','Judee Sill','Carly Simon','Nick Drake','Laura Marling'],
  'fleetwood mac':['Haim','Stevie Nicks','Eagles','Tom Petty','Crosby Stills Nash Young','Lindsey Buckingham'],
  'madison beer':['Olivia Rodrigo','Lana Del Rey','Gracie Abrams','Conan Gray','Lennon Stella','Bea Miller'],
  'balu brigada':['Omar Apollo','Still Woozy','Rex Orange County','Remi Wolf','beabadoobee','Dominic Fike'],
  'omar apollo':['Remi Wolf','Still Woozy','Dominic Fike','Steve Lacy','Rex Orange County','Brockhampton'],
};
function findSimilar(artist,db){
  const a=(artist||'').toLowerCase();
  // Try exact match first, then partial
  const key=Object.keys(db).find(k=>a===k) || Object.keys(db).find(k=>a.includes(k)||k.includes(a));
  return key?db[key]:null;
}
function getRelatedArtistsFromDB(artist, genres){
  const fromDB = findSimilar(artist, SIMILAR_ARTISTS);
  if(fromDB) return fromDB;
  // Genre-based fallback
  const g = (genres||[]).join(' ').toLowerCase();
  if(g.includes('indie rock')||g.includes('indie pop')) return ['Vampire Weekend','The National','Bon Iver','Tame Impala','Fleet Foxes','Phoebe Bridgers'];
  if(g.includes('dream pop')||g.includes('shoegaze')) return ['Beach House','Slowdive','Cocteau Twins','Mazzy Star','My Bloody Valentine','Cigarettes After Sex'];
  if(g.includes('hip hop')||g.includes('rap')) return ['Kendrick Lamar','Frank Ocean','Tyler the Creator','J. Cole','Earl Sweatshirt','Noname'];
  if(g.includes('r&b')||g.includes('soul')) return ['Frank Ocean','SZA','James Blake','Daniel Caesar','Sampha','Solange'];
  if(g.includes('folk')||g.includes('americana')) return ['Fleet Foxes','Bon Iver','Iron & Wine','Sufjan Stevens','Phoebe Bridgers','Big Thief'];
  if(g.includes('electronic')||g.includes('ambient')) return ['Four Tet','Caribou','Jon Hopkins','Bonobo','Burial','Boards of Canada'];
  if(g.includes('post-punk')||g.includes('punk')) return ['Interpol','The Strokes','Wire','Gang of Four','LCD Soundsystem','Talking Heads'];
  if(g.includes('jazz')) return ['Bill Evans','Miles Davis','John Coltrane','Floating Points','Yussef Kamaal','Nubya Garcia'];
  if(g.includes('country')) return ['Sturgill Simpson','Tyler Childers','Jason Isbell','Kacey Musgraves','Colter Wall','Sierra Ferrell'];
  if(g.includes('pop')) return ['Lorde','Lana Del Rey','St. Vincent','Janelle Mon√°e','Haim','Kacey Musgraves'];
  return null;
}

// ‚îÄ‚îÄ INSTRUMENTS ‚îÄ‚îÄ
const INSTRUMENTS = ['üé∏','üéπ','ü•Å','üé∫','üé∑','üéª','üé§','üéß','üéµ','üé∂','üìª','üéº','ü™ó','ü™ò','üéôÔ∏è','ü™à'];
function buildInstrumentPicker(id, sel){
  const el=document.getElementById(id); el.innerHTML='';
  INSTRUMENTS.forEach((inst,i)=>{
    const btn=document.createElement('div');
    btn.className='instrument-btn'+((sel?inst===sel:i===0)?' selected':'');
    btn.textContent=inst; btn.dataset.instrument=inst;
    btn.onclick=()=>{el.querySelectorAll('.instrument-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');};
    el.appendChild(btn);
  });
}
function getInstrument(id){const b=document.getElementById(id).querySelector('.selected');return b?b.dataset.instrument:INSTRUMENTS[0];}
function getAvatar(profile){return profile.instrument||profile.display_name[0];}

// ‚îÄ‚îÄ COLORS ‚îÄ‚îÄ
const COLORS = ['#cc1111','#ff4444','#ff9090','#ffffff','#cccccc','#8b0000','#ff6b6b','#660000'];
function buildColorPicker(id,sel){
  const el=document.getElementById(id);el.innerHTML='';
  COLORS.forEach((c,i)=>{
    const sw=document.createElement('div');
    sw.className='swatch'+((sel?c===sel:i===0)?' selected':'');
    sw.style.background=c;
    if(c==='#ffffff'||c==='#cccccc')sw.style.border='2px solid #555';
    sw.dataset.color=c;
    sw.onclick=()=>{el.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));sw.classList.add('selected');};
    el.appendChild(sw);
  });
}
function getColor(id){const s=document.getElementById(id).querySelector('.selected');return s?s.dataset.color:COLORS[0];}

function toggleNavDropdown(){
  document.getElementById('nav-dropdown-menu').classList.toggle('open');
}
function closeNavDropdown(){
  document.getElementById('nav-dropdown-menu').classList.remove('open');
}
// Close dropdown when clicking outside
document.addEventListener('click',function(e){
  const dd=document.getElementById('nav-dropdown');
  if(dd&&!dd.contains(e.target))closeNavDropdown();
  const nb=document.getElementById('notif-bell-wrap');
  if(nb&&!nb.contains(e.target))closeNotifPanel();
});

// ‚îÄ‚îÄ GUEST MODE ‚îÄ‚îÄ
let isGuest = false;

function browseAsGuest(){
  isGuest=true;
  document.getElementById('mainNav').style.display='flex';
  document.getElementById('mobileNav').style.display='block';
  // Show guest-specific nav elements, hide member-only ones
  document.getElementById('nav-myprofile').style.display='none';
  document.getElementById('nav-settings-btn').style.display='none';
  document.getElementById('nav-signout-btn').style.display='none';
  document.getElementById('nav-pick-btn').style.display='none';
  document.getElementById('nav-join-btn').style.display='inline-flex';
  document.getElementById('nav-join-btn').style.display='inline-flex';
  document.getElementById('nav-user').textContent='Guest';
  document.getElementById('guest-banner').style.display='block';
  // Update mobile nav ‚Äî hide pick button, show join instead
  const mnavProfile=document.getElementById('mnav-myprofile');
  if(mnavProfile)mnavProfile.style.display='none';
  showView('feed');
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function switchTab(tab){
  document.getElementById('auth-signin').style.display=tab==='signin'?'block':'none';
  document.getElementById('auth-signup').style.display=tab==='signup'?'block':'none';
  document.getElementById('tab-signin').classList.toggle('active',tab==='signin');
  document.getElementById('tab-signup').classList.toggle('active',tab==='signup');
}

async function signIn(){
  const email=document.getElementById('signin-email').value.trim();
  const pass=document.getElementById('signin-password').value;
  const err=document.getElementById('signin-error');
  const btn=document.getElementById('signin-btn');
  err.textContent='';
  if(!email||!pass){err.textContent='Please enter your email and password.';return;}
  btn.disabled=true;btn.textContent='Signing in...';
  const {data,error}=await sb.auth.signInWithPassword({email,password:pass});
  btn.disabled=false;btn.textContent='Sign In';
  if(error){err.textContent=error.message;return;}
  currentUser=data.user;
  await loadProfileAndContinue();
}

async function signUp(){
  const email=document.getElementById('signup-email').value.trim();
  const pass=document.getElementById('signup-password').value;
  const err=document.getElementById('signup-error');
  const btn=document.getElementById('signup-btn');
  err.textContent='';
  if(!email||!pass){err.textContent='Please enter your email and password.';return;}
  if(pass.length<6){err.textContent='Password must be at least 6 characters.';return;}
  btn.disabled=true;btn.textContent='Creating account...';
  const {data,error}=await sb.auth.signUp({email,password:pass});
  btn.disabled=false;btn.textContent='Create Account';
  if(error){err.textContent=error.message;return;}
  if(data.session){
    currentUser=data.user;
    await loadProfileAndContinue();
  } else {
    err.style.color='#6bffb8';
    err.textContent='Check your email to confirm your account, then sign in.';
  }
}

async function signOut(){
  await sb.auth.signOut();currentUser=null;currentProfile=null;isGuest=false;
  document.getElementById('mainNav').style.display='none';
  document.getElementById('mobileNav').style.display='none';
  document.getElementById('notif-bell-wrap').style.display='none';
  showView('auth');
}

async function loadProfileAndContinue(){
  isGuest=false;
  // Reset any guest-mode UI changes
  document.getElementById('nav-myprofile').style.display='';
  document.getElementById('nav-settings-btn').style.display='';
  document.getElementById('nav-signout-btn').style.display='';
  document.getElementById('nav-pick-btn').style.display='';
  document.getElementById('nav-join-btn').style.display='none';
  document.getElementById('guest-banner').style.display='none';
  const mnavProfile=document.getElementById('mnav-myprofile');
  if(mnavProfile)mnavProfile.style.display='';
  const {data}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
  if(data){
    currentProfile=data;
    document.getElementById('nav-user').textContent='@'+data.username;
    document.getElementById('mainNav').style.display='flex';
    document.getElementById('mobileNav').style.display='block';
    document.getElementById('notif-bell-wrap').style.display='block';
    loadNotifications();
    showView('feed');
  } else {
    buildColorPicker('ob-colors',null);
    buildInstrumentPicker('ob-instruments',null);
    showView('onboarding');
  }
}

async function createProfile(){
  const name=document.getElementById('ob-name').value.trim();
  const username=document.getElementById('ob-username').value.trim().toLowerCase().replace(/\s+/g,'_');
  const err=document.getElementById('ob-error');
  const btn=document.getElementById('ob-btn');
  err.textContent='';
  if(!name||!username){err.textContent='Both fields are required.';return;}
  if(!/^[a-z0-9_]+$/.test(username)){err.textContent='Username: letters, numbers, underscores only.';return;}
  btn.disabled=true;btn.textContent='Saving...';
  const {data,error}=await sb.from('profiles').insert({id:currentUser.id,username,display_name:name,color:getColor('ob-colors'),instrument:getInstrument('ob-instruments')}).select().single();
  btn.disabled=false;btn.textContent='Enter Wavelength';
  if(error){err.textContent=error.message.includes('unique')?'That username is taken. Try another.':error.message;return;}
  currentProfile=data;
  document.getElementById('nav-user').textContent='@'+data.username;
  document.getElementById('mainNav').style.display='flex';
  document.getElementById('mobileNav').style.display='block';
  showView('feed');
  showToast('Welcome to Wavelength! üéµ');
}

// ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ
function showView(name,opts){
  opts=opts||{};
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  window.scrollTo(0,0);
  ['feed','members','about'].forEach(n=>{
    const el=document.getElementById('nav-'+n);if(el)el.classList.toggle('active',n===name);
    const mel=document.getElementById('mnav-'+n);if(mel)mel.classList.toggle('active',n===name);
  });
  const mnavProfile=document.getElementById('mnav-myprofile');
  if(mnavProfile)mnavProfile.classList.toggle('active',name==='profile');
  if(name==='feed')renderFeed();
  if(name==='members')renderMembers();
  if(name==='profile')renderProfile(opts.userId||(currentUser&&currentUser.id));
  if(name==='songdetail')renderSongDetail(opts);
  if(name==='settings')renderSettings();
}

// ‚îÄ‚îÄ WEEK UTILS ‚îÄ‚îÄ
// Weeks run Sun‚ÄìSat. Week 1 = Jan 1 through the first Saturday.
// Week 2 starts on the first Sunday of the year, etc.
function getFirstSunday(year){
  // The first Sunday ON OR AFTER Jan 1 that starts week 2.
  // Week 1 is always Jan 1 ‚Üí first Saturday (may be just 1‚Äì6 days).
  const jan1 = new Date(year,0,1);
  const dayOfWeek = jan1.getDay(); // 0=Sun,1=Mon,...,6=Sat
  if(dayOfWeek===0) return jan1; // Jan 1 is Sunday ‚Äî week 1 starts and ends same day, week 2 starts Jan 1
  // First Sunday after Jan 1
  const firstSun = new Date(year,0,1+(7-dayOfWeek));
  return firstSun;
}
function getCurrentWeek(){
  const now = new Date();
  const year = now.getFullYear();
  const jan1 = new Date(year,0,1);
  const dayOfWeek = jan1.getDay();
  // If Jan 1 is Sunday, no short week ‚Äî just count full weeks from Jan 1
  if(dayOfWeek===0){
    return Math.min(52,Math.max(1,Math.ceil((now-jan1)/(7*24*60*60*1000))));
  }
  // Week 1 ends on the first Saturday
  const firstSun = new Date(year,0,1+(7-dayOfWeek));
  if(now < firstSun) return 1;
  const msFromFirstSun = now - firstSun;
  return Math.min(52,Math.max(2,2+Math.floor(msFromFirstSun/(7*24*60*60*1000))));
}
function getWeekRange(w,year){
  year = year||new Date().getFullYear();
  const jan1 = new Date(year,0,1);
  const dayOfWeek = jan1.getDay();
  const f = d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(dayOfWeek===0){
    // Jan 1 is Sunday ‚Äî all weeks are clean Sun‚ÄìSat
    const s = new Date(year,0,1+(w-1)*7);
    const e = new Date(s.getTime()+6*24*60*60*1000);
    return f(s)+' \u2013 '+f(e);
  }
  if(w===1){
    // Short opening week: Jan 1 ‚Üí first Saturday
    const e = new Date(year,0,7-dayOfWeek); // first Saturday
    return f(jan1)+' \u2013 '+f(e);
  }
  // Week 2+ start on a Sunday
  const firstSun = new Date(year,0,1+(7-dayOfWeek));
  const s = new Date(firstSun.getTime()+(w-2)*7*24*60*60*1000);
  const e = new Date(s.getTime()+6*24*60*60*1000);
  return f(s)+' \u2013 '+f(e);
}

// ‚îÄ‚îÄ FEED ‚îÄ‚îÄ
async function renderFeed(){
  const week=getCurrentWeek();
  const year=new Date().getFullYear();
  document.getElementById('feed-pill').textContent='Week '+week+' \u00b7 '+year;
  document.getElementById('feed-range').textContent=getWeekRange(week,year);
  const grid=document.getElementById('friends-grid');
  grid.innerHTML='<div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>';

  let ids=[];
  if(isGuest){
    // Guests see everyone
    const {data:everyone}=await sb.from('profiles').select('id');
    ids=(everyone||[]).map(p=>p.id);
  } else {
    const {data:follows}=await sb.from('follows').select('following_id').eq('follower_id',currentUser.id);
    ids=[currentUser.id,...(follows||[]).map(f=>f.following_id)];
  }
  const {data:profiles}=await sb.from('profiles').select('*').in('id',ids);
  const {data:picks}=await sb.from('picks').select('*').in('user_id',ids).eq('week_number',week).eq('year',year);
  const pickMap=Object.fromEntries((picks||[]).map(p=>[p.user_id,p]));
  if(!profiles||profiles.length===0){
    grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">üé∏</div><p>'+(isGuest?'No members yet. Be the first ‚Äî sign up!':'Your feed is empty.<br>Go to Members to find people to follow!')+'</p>'+(isGuest?'<button class="btn btn-primary" onclick="showView(\'auth\')">Join Wavelength</button>':'')+'</div>';return;
  }
  const sorted=isGuest?profiles:[profiles.find(p=>p.id===currentUser.id),...profiles.filter(p=>p.id!==currentUser.id)].filter(Boolean);
  grid.innerHTML=sorted.map(p=>{
    const pick=pickMap[p.id];const me=!isGuest&&p.id===currentUser.id;
    const artHtml=pick&&pick.art_url
      ?'<img class="friend-card-art" src="'+esc(pick.art_url)+'" alt="Album art" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div class="friend-card-art-ph" style="display:none">üéµ</div>'
      :'<div class="friend-card-art-ph">'+(pick?'üéµ':'üé∏')+'</div>';
    return '<div class="friend-card" onclick="showView(\'profile\',{userId:\''+p.id+'\'})">'
      +artHtml
      +'<div class="friend-card-body">'
      +'<div class="f-avatar" style="background:'+p.color+'22;color:'+p.color+'">'+getAvatar(p)+'</div>'
      +'<div class="f-name">'+(me?'‚≠ê You':'@'+esc(p.username))+'</div>'
      +(pick?'<div class="f-song">'+esc(pick.song)+'</div><div class="f-artist">'+esc(pick.artist)+'</div>':'<div class="no-pick">No pick yet this week</div>')
      +'</div><div class="card-arrow">&#8599;</div></div>';
  }).join('');
}

// ‚îÄ‚îÄ MEMBERS ‚îÄ‚îÄ
async function renderMembers(){
  const grid=document.getElementById('members-grid');
  grid.innerHTML='<div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>';
  const {data:profiles}=await sb.from('profiles').select('*').order('created_at',{ascending:false});
  const {data:allPicks}=await sb.from('picks').select('user_id');
  const counts={};(allPicks||[]).forEach(p=>{counts[p.user_id]=(counts[p.user_id]||0)+1;});

  let followSet=new Set();
  if(!isGuest){
    const {data:follows}=await sb.from('follows').select('following_id').eq('follower_id',currentUser.id);
    followSet=new Set((follows||[]).map(f=>f.following_id));
  }

  if(!profiles||profiles.length===0){
    grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">üé∑</div><p>No members yet.</p></div>';return;
  }
  grid.innerHTML=profiles.map(p=>{
    const n=counts[p.id]||0;
    const me=!isGuest&&p.id===currentUser.id;
    const following=followSet.has(p.id);
    let followBtn='';
    if(!isGuest&&!me){
      followBtn=following
        ?'<button class="member-follow-btn following" onclick="event.stopPropagation();toggleMemberFollow(\''+p.id+'\',true,this)">‚úì Following</button>'
        :'<button class="member-follow-btn" onclick="event.stopPropagation();toggleMemberFollow(\''+p.id+'\',false,this)">+ Follow</button>';
    }
    if(isGuest){
      followBtn='<button class="member-follow-btn guest-follow" onclick="event.stopPropagation();showView(\'auth\')">+ Follow</button>';
    }
    return '<div class="member-card" onclick="showView(\'profile\',{userId:\''+p.id+'\'})">'
      +'<div class="member-avatar" style="background:'+p.color+'22;color:'+p.color+'">'+getAvatar(p)+'</div>'
      +'<div class="member-name">'+esc(p.display_name)+(me?' ‚≠ê':'')+'</div>'
      +'<div class="member-username">@'+esc(p.username)+'</div>'
      +'<div class="member-picks">'+n+' pick'+(n!==1?'s':'')+'</div>'
      +followBtn
      +'</div>';
  }).join('');
}

async function toggleMemberFollow(userId,isFollowing,btn){
  btn.disabled=true;
  if(isFollowing){
    await sb.from('follows').delete().eq('follower_id',currentUser.id).eq('following_id',userId);
    btn.textContent='+ Follow';
    btn.classList.remove('following');
    btn.onclick=function(e){e.stopPropagation();toggleMemberFollow(userId,false,btn);};
  } else {
    await sb.from('follows').insert({follower_id:currentUser.id,following_id:userId});
    btn.textContent='‚úì Following';
    btn.classList.add('following');
    btn.onclick=function(e){e.stopPropagation();toggleMemberFollow(userId,true,btn);};
    showToast('Following!');
  }
  btn.disabled=false;
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
async function renderProfile(userId){
  if(!userId)return;
  const isMe=!isGuest&&userId===currentUser.id;
  const week=getCurrentWeek();
  const year=new Date().getFullYear();
  document.getElementById('profile-back').onclick=function(){showView('feed');};
  document.getElementById('profile-hero').innerHTML='<div class="loading-center"><div class="spinner"></div></div><div class="profile-hero-deco">üé∏</div>';
  document.getElementById('weeks-list').innerHTML='';
  const {data:profile}=await sb.from('profiles').select('*').eq('id',userId).single();
  if(!profile)return;
  const {data:picks}=await sb.from('picks').select('*').eq('user_id',userId).eq('year',year).order('week_number',{ascending:false});
  const pickMap=Object.fromEntries((picks||[]).map(p=>[p.week_number,p]));
  // Fetch reaction counts and current user's reactions for this profile's picks
  const pickIds=(picks||[]).map(p=>p.id);
  let reactionCounts={};let myReactions=new Set();
  if(pickIds.length){
    const {data:reactions}=await sb.from('reactions').select('pick_id,user_id').in('pick_id',pickIds);
    (reactions||[]).forEach(r=>{
      reactionCounts[r.pick_id]=(reactionCounts[r.pick_id]||0)+1;
      if(!isGuest&&r.user_id===currentUser.id)myReactions.add(r.pick_id);
    });
  }
  document.getElementById('profile-hero').innerHTML=
    '<div class="profile-hero-deco">üé∏</div>'
    +'<div class="p-avatar-lg" style="background:'+profile.color+'22;color:'+profile.color+'">'+getAvatar(profile)+'</div>'
    +'<div class="p-meta"><h2>'+esc(profile.display_name)+'</h2><p>@'+esc(profile.username)+' &middot; '+((picks||[]).length)+' picks in '+year+'</p></div>';
  let html='';
  for(let w=week;w>=1;w--){
    const pick=pickMap[w];const cur=w===week;
    const artHtml=pick&&pick.art_url
      ?'<img class="week-row-art" src="'+esc(pick.art_url)+'" alt="" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div class="week-row-art-ph" style="display:none">üéµ</div>'
      :'<div class="week-row-art-ph">üéµ</div>';
    const click=pick?'showView(\'songdetail\',{userId:\''+userId+'\',week:'+w+',year:'+year+'})':isMe?'openPickModal()':'';
    const thumbHtml=pick&&!isGuest&&!isMe
      ?'<button class="reaction-btn'+(myReactions.has(pick.id)?' reacted':'')+'" onclick="event.stopPropagation();toggleReaction(\''+pick.id+'\',\''+userId+'\',this)">üëç <span class="reaction-count">'+(reactionCounts[pick.id]||0)+'</span></button>'
      :pick?'<span style="font-family:\'IBM Plex Mono\',monospace;font-size:0.6rem;color:var(--text-dim)">'+(reactionCounts[pick.id]||0)+' üëç</span>':'';
    html+='<div class="week-row '+(cur?'is-current':'')+'" onclick="'+click+'">'
      +artHtml
      +'<div><div class="wk-label">'+(cur?'&#9733; This week':'Week '+w)+'</div><div class="wk-date">'+getWeekRange(w,year)+'</div></div>'
      +(pick
        ?'<div class="wk-song"><strong>'+esc(pick.song)+'</strong><span>'+esc(pick.artist)+'</span></div>'
        :isMe
          ?'<div class="wk-song"><strong style="font-family:\'IBM Plex Mono\',monospace;font-size:0.7rem;font-weight:400;color:var(--text-muted)">+ Add your pick</strong></div>'
          :'<div class="wk-song"><strong style="font-family:\'IBM Plex Mono\',monospace;font-size:0.7rem;font-weight:400;color:var(--text-dim)">No pick</strong></div>')
      +(pick?'<div>'+thumbHtml+'</div>':'<div></div>')
      +'<div class="wk-arrow">'+(pick?'&#8594;':'')+'</div>'
      +'</div>';
  }
  document.getElementById('weeks-list').innerHTML=html;
}

// ‚îÄ‚îÄ SONG DETAIL ‚îÄ‚îÄ
async function renderSongDetail(opts){
  const userId=opts.userId; const week=opts.week; const year=opts.year||new Date().getFullYear();
  document.getElementById('song-back').onclick=function(){showView('profile',{userId:userId});};
  document.getElementById('song-content').innerHTML='<div class="loading-center"><div class="spinner"></div></div>';
  const {data:pick}=await sb.from('picks').select('*').eq('user_id',userId).eq('week_number',week).eq('year',year).single();
  const {data:profile}=await sb.from('profiles').select('*').eq('id',userId).single();
  if(!pick||!profile)return;
  currentPick=pick;

  // Log listen
  if(!isGuest&&currentUser.id!==userId){
    const alreadyLogged=sessionStorage.getItem('listen_'+pick.id);
    if(!alreadyLogged){
      sessionStorage.setItem('listen_'+pick.id,'1');
      await sb.from('listens').upsert({pick_id:pick.id,listener_id:currentUser.id,pick_owner_id:userId},{onConflict:'pick_id,listener_id',ignoreDuplicates:true});
      const {data:existing}=await sb.from('notifications').select('id').eq('user_id',userId).eq('type','listen').eq('actor_id',currentUser.id).eq('pick_id',pick.id).maybeSingle();
      if(!existing) await sb.from('notifications').insert({user_id:userId,type:'listen',actor_id:currentUser.id,pick_id:pick.id,read:false});
    }
  }

  // Reactions
  if(!isGuest){
    const {data:reactions}=await sb.from('reactions').select('user_id').eq('pick_id',pick.id);
    reactionCount=(reactions||[]).length;
    myReaction=(reactions||[]).some(r=>r.user_id===currentUser.id);
  }

  // Parse saved data
  const rawTags=pick.tags||[];
  const tags=Array.isArray(rawTags)?rawTags:(typeof rawTags==='string'?rawTags.split(',').map(t=>t.trim()).filter(Boolean):[]);
  const relatedArtists=pick.related_artists
    ?pick.related_artists.split(',').filter(Boolean).map(a=>a.trim())
    :(getRelatedArtistsFromDB(pick.artist,tags)||null);
  const simSongs=findSimilar(pick.artist,SIMILAR_SONGS);

  // Album art
  const artHtml=pick.art_url
    ?'<img class="song-hero-art" src="'+esc(pick.art_url)+'" alt="Album art" onerror="this.outerHTML=\'<div class=\\\'song-hero-art-ph\\\'>üéµ</div>\'">'
    :'<div class="song-hero-art-ph">üéµ</div>';

  // Player
  let playerHtml=''; let fullSongLinks='';
  if(pick.spotify_url){
    const trackId=pick.spotify_url.split('/track/').pop().split('?')[0];
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const spotifyHref=isMobile?'spotify:track:'+trackId:'https://open.spotify.com/track/'+trackId;
    fullSongLinks+='<a class="play-on-spotify-btn" href="'+spotifyHref+'" target="_blank" rel="noopener"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>Full Song on Spotify</a>';
  }
  if(pick.youtube_url){
    let ytId=''; const m2=pick.youtube_url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/); if(m2)ytId=m2[1];
    if(ytId) fullSongLinks+='<a class="play-on-youtube-btn" href="'+pick.youtube_url+'" target="_blank" rel="noopener">‚ñ∂ Full Song on YouTube</a>';
  }
  if(pick.spotify_url){
    const sid=pick.spotify_url.split('/track/').pop().split('?')[0];
    if(sid) playerHtml='<div class="detail-sec"><h3>üéµ Listen</h3><iframe style="border-radius:8px;border:none;width:100%;margin-top:0.5rem" src="https://open.spotify.com/embed/track/'+sid+'?utm_source=generator&theme=0" height="152" allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>'+(fullSongLinks?'<div style="margin-top:0.9rem;display:flex;flex-wrap:wrap;gap:0.6rem;align-items:center"><span style="font-family:\'IBM Plex Mono\',monospace;font-size:0.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em">Want the full song?</span>'+fullSongLinks+'</div>':'')+'</div>';
  } else if(pick.youtube_url){
    let ytId=''; const m=pick.youtube_url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/); if(m)ytId=m[1];
    if(ytId) playerHtml='<div class="detail-sec"><h3>üéµ Listen</h3><div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:8px;margin-top:0.5rem"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" src="https://www.youtube.com/embed/'+ytId+'" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" loading="lazy"></iframe></div>'+(fullSongLinks?'<div style="margin-top:0.9rem;display:flex;flex-wrap:wrap;gap:0.6rem;align-items:center">'+fullSongLinks+'</div>':'')+'</div>';
  }

  // About section ‚Äî parse stored band_info
  function buildAboutHtml(bi){
    if(!bi||!bi.trim()) return '<div class="detail-sec" id="about-section" style="display:none"></div>';
    const lines=bi.split(' ¬∑ ');
    const pills=lines.filter(l=>l.includes('followers')||l.includes('Popularity score'));
    const desc=lines.filter(l=>!l.includes('followers')&&!l.includes('Popularity score')).filter(l=>l.trim());
    const pillsHtml=pills.map(l=>'<span class="artist-stat-pill">'+esc(l)+'</span>').join('');
    const descHtml=desc.map(l=>'<p>'+esc(l)+'</p>').join('');
    if(!pillsHtml&&!descHtml) return '<div class="detail-sec" id="about-section" style="display:none"></div>';
    return '<div class="detail-sec" id="about-section"><h3>About '+esc(pick.artist)+'</h3>'+(pillsHtml?'<div class="artist-stats">'+pillsHtml+'</div>':'')+descHtml+'</div>';
  }

  // Render page
  document.getElementById('song-content').innerHTML=
    '<div class="song-hero">'+artHtml
    +'<div><div class="song-badge">Week '+week+' &middot; '+getWeekRange(week,year)+' &middot; '+esc(profile.display_name)+'\'s Pick</div>'
    +'<div class="song-title">'+esc(pick.song)+'</div>'
    +'<div class="song-artist">'+esc(pick.artist)+(pick.release_year?' &middot; '+pick.release_year:'')+'</div>'
    +(pick.note?'<p style="margin-top:1rem;font-size:0.95rem;line-height:1.75;color:var(--text-muted);border-left:2px solid var(--red-dim);padding-left:1rem;font-style:italic">"'+esc(pick.note)+'"</p>':'')
    +(userId===currentUser.id?'<button class="btn btn-ghost" style="margin-top:1.25rem;font-size:0.62rem" onclick="openPickModal()">‚úè Edit This Pick</button>':'')
    +(!isGuest&&userId!==currentUser.id
      ?'<div style="margin-top:1.25rem"><button class="reaction-btn'+(myReaction?' reacted':'')+'" id="detail-reaction-btn" onclick="toggleReaction(\''+pick.id+'\',\''+userId+'\',this)">üëç <span class="reaction-count">'+reactionCount+'</span> '+(myReaction?'Liked':'Like this pick')+'</button></div>'
      :reactionCount?'<div style="margin-top:1rem;font-family:\'IBM Plex Mono\',monospace;font-size:0.65rem;color:var(--text-muted)">'+reactionCount+' üëç</div>':'')
    +'</div></div>'
    +playerHtml
    +buildAboutHtml(pick.band_info)
    +(tags.length
      ?'<div class="detail-sec" id="vibes-section"><h3>üéß Vibes</h3><div class="tags">'+tags.map(t=>'<div class="tag">'+esc(t)+'</div>').join('')+'</div></div>'
      :'<div class="detail-sec" id="vibes-section" style="display:none"></div>')
    +'<div class="detail-sec"><h3>Song Info</h3>'
    +'<div class="stat-row"><span class="lbl">Title</span><span>'+esc(pick.song)+'</span></div>'
    +'<div class="stat-row"><span class="lbl">Artist</span><span>'+esc(pick.artist)+'</span></div>'
    +(pick.release_year?'<div class="stat-row"><span class="lbl">Year</span><span>'+pick.release_year+'</span></div>':'')
    +'</div>'
    +(simSongs?'<div class="detail-sec"><h3>üéµ Similar Songs</h3><div class="similar-grid">'+simSongs.map(s=>{const p=s.split('\u2014');return'<div class="sim-item"><strong>'+esc(p[0].trim())+'</strong><span>'+esc((p[1]||'').trim())+'</span></div>';}).join('')+'</div></div>':'')
    +(relatedArtists
      ?'<div class="detail-sec" id="related-section"><h3>üé∏ If You Like This, Try</h3><div class="similar-grid">'+relatedArtists.map(a=>'<div class="sim-item"><strong>'+esc(a)+'</strong><span>Similar artist</span></div>').join('')+'</div></div>'
      :'<div class="detail-sec" id="related-section" style="display:none"></div>');

  // Silently fetch and fill in missing data ‚Äî no button needed
  autoEnrichSongDetail(pick);
}

// Fetches artist info from Spotify + genre fallback, injects into page, saves to DB
async function autoEnrichSongDetail(pick){
  // Only run if we're missing tags or bio ‚Äî related artists always come from local DB
  const hasTags = pick.tags && (Array.isArray(pick.tags)?pick.tags.length:pick.tags.split(',').filter(Boolean).length) > 0;
  const hasBio = pick.band_info && pick.band_info.trim().length > 0;
  if(hasTags && hasBio) return; // already have everything
  if(!pick.spotify_url) return; // no way to look up

  try {
    const token = await getSpotifyToken();
    const trackId = pick.spotify_url.split('/track/').pop().split('?')[0];
    const trackData = await spotifyFetch('https://api.spotify.com/v1/tracks/'+trackId, token);
    if(!trackData||!trackData.artists||!trackData.artists[0]) return;
    const artistId = trackData.artists[0].id;
    const artistData = await spotifyFetch('https://api.spotify.com/v1/artists/'+artistId, token);
    if(!artistData) return;

    // Genres: use Spotify's if available, otherwise infer from our local map
    let genres = (artistData.genres||[]).slice(0,5);
    if(!genres.length) genres = inferGenres(pick.artist);

    const followers = artistData.followers ? artistData.followers.total.toLocaleString() : null;
    const popularity = artistData.popularity || null;

    // Build bio
    let bioLines = [];
    if(genres.length) bioLines.push(genres.slice(0,3).join(', ')+' artist');
    if(followers) bioLines.push(followers+' followers on Spotify');
    if(popularity) bioLines.push('Popularity score: '+popularity+'/100');
    const band_info = bioLines.join(' ¬∑ ');

    // Save to DB
    const updates = {};
    if(!hasBio && band_info) updates.band_info = band_info;
    if(!hasTags && genres.length) updates.tags = genres;
    if(!pick.release_year && trackData.album && trackData.album.release_date)
      updates.release_year = trackData.album.release_date.split('-')[0];
    if(Object.keys(updates).length) await sb.from('picks').update(updates).eq('id',pick.id);

    // Inject into page (only if user hasn't navigated away)
    if(!document.getElementById('about-section')) return;

    // About
    if(!hasBio && band_info){
      const pills = bioLines.filter(l=>l.includes('followers')||l.includes('Popularity score'));
      const desc = bioLines.filter(l=>!l.includes('followers')&&!l.includes('Popularity score'));
      const pillsHtml = pills.map(l=>'<span class="artist-stat-pill">'+esc(l)+'</span>').join('');
      const descHtml = desc.map(l=>'<p>'+esc(l)+'</p>').join('');
      const el = document.getElementById('about-section');
      if(el){
        el.innerHTML='<h3>About '+esc(pick.artist)+'</h3>'+(pillsHtml?'<div class="artist-stats">'+pillsHtml+'</div>':'')+descHtml;
        el.style.display='';
      }
    }

    // Vibes
    if(!hasTags && genres.length){
      const el = document.getElementById('vibes-section');
      if(el){
        el.innerHTML='<h3>üéß Vibes</h3><div class="tags">'+genres.map(t=>'<div class="tag">'+esc(t)+'</div>').join('')+'</div>';
        el.style.display='';
      }
    }

  } catch(e){ /* silent fail ‚Äî enrichment is best-effort */ }
}

// Infer genres from our local artist database when Spotify has none
function inferGenres(artist){
  const a = artist.toLowerCase();
  const genreMap = {
    'the church':'post-punk, dream pop, jangle pop',
    'echo & the bunnymen':'post-punk, new wave',
    'joy division':'post-punk, gothic rock',
    'the cure':'post-punk, gothic rock',
    'the smiths':'indie pop, post-punk',
    'new order':'synth-pop, post-punk',
    'depeche mode':'synth-pop, new wave',
    'talking heads':'new wave, art rock',
    'radiohead':'alternative rock, art rock',
    'portishead':'trip-hop, electronic',
    'massive attack':'trip-hop, electronic',
    'slowdive':'shoegaze, dream pop',
    'my bloody valentine':'shoegaze, noise pop',
    'cocteau twins':'dream pop, ethereal wave',
    'mazzy star':'dream pop, slowcore',
    'sigur ros':'post-rock, ambient',
    'mogwai':'post-rock, instrumental',
    'godspeed you':'post-rock, experimental',
    'explosions in the sky':'post-rock, instrumental',
    'beach house':'dream pop, indie pop',
    'tame impala':'psychedelic rock, indie pop',
    'arctic monkeys':'indie rock, garage rock',
    'the strokes':'indie rock, garage rock',
    'interpol':'post-punk revival, indie rock',
    'lcd soundsystem':'dance punk, indie electronic',
    'vampire weekend':'indie pop, indie rock',
    'fleet foxes':'indie folk, baroque pop',
    'bon iver':'indie folk, chamber pop',
    'sufjan stevens':'indie folk, chamber pop',
    'frank ocean':'r&b, alternative r&b',
    'james blake':'indie r&b, electronic',
    'kendrick lamar':'hip hop, conscious rap',
    'tyler the creator':'alternative hip hop, rap',
    'four tet':'electronic, ambient',
    'boards of canada':'electronic, ambient',
    'burial':'uk garage, ambient',
    'nick drake':'folk, acoustic',
    'nick cave':'post-punk, gothic rock',
    'iron & wine':'indie folk, folk pop',
    'big thief':'indie folk, indie rock',
    'phoebe bridgers':'indie folk, indie pop',
    'the national':'indie rock, chamber pop',
    'pixies':'alternative rock, indie rock',
    'sonic youth':'noise rock, alternative rock',
    'pavement':'indie rock, lo-fi',
    'neutral milk hotel':'indie folk, lo-fi',
    'built to spill':'indie rock, alternative rock',
    'modest mouse':'indie rock, alternative rock',
  };
  const key = Object.keys(genreMap).find(k => a.includes(k) || k.includes(a));
  return key ? genreMap[key].split(', ') : [];
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function renderSettings(){
  if(!currentProfile)return;
  document.getElementById('s-name').value=currentProfile.display_name;
  document.getElementById('s-username').value=currentProfile.username;
  buildColorPicker('s-colors',currentProfile.color);
  buildInstrumentPicker('s-instruments',currentProfile.instrument||null);
  document.getElementById('search-results').innerHTML='';
  document.getElementById('search-q').value='';
  document.getElementById('cp-password').value='';
  document.getElementById('cp-password2').value='';
  document.getElementById('cp-msg').textContent='';
}

async function saveSettings(){
  const name=document.getElementById('s-name').value.trim();
  const username=document.getElementById('s-username').value.trim().toLowerCase().replace(/\s+/g,'_');
  if(!name||!username){showToast('Fields required',true);return;}
  const {data,error}=await sb.from('profiles').update({display_name:name,username,color:getColor('s-colors'),instrument:getInstrument('s-instruments')}).eq('id',currentUser.id).select().single();
  if(error){showToast(error.message,true);return;}
  currentProfile=data;
  document.getElementById('nav-user').textContent='@'+data.username;
  showToast('Saved!');
}

async function searchUsers(){
  const q=document.getElementById('search-q').value.trim();if(!q)return;
  const {data}=await sb.from('profiles').select('*').ilike('username','%'+q+'%').neq('id',currentUser.id).limit(10);
  const {data:follows}=await sb.from('follows').select('following_id').eq('follower_id',currentUser.id);
  const followSet=new Set((follows||[]).map(f=>f.following_id));
  const el=document.getElementById('search-results');
  if(!data||data.length===0){el.innerHTML='<p style="font-family:\'IBM Plex Mono\',monospace;font-size:0.7rem;color:var(--text-muted);padding:0.5rem 0">No users found.</p>';return;}
  el.innerHTML=data.map(u=>{
    const following=followSet.has(u.id);
    return '<div class="user-result">'
      +'<div class="ur-avatar" style="background:'+u.color+'22;color:'+u.color+'">'+getAvatar(u)+'</div>'
      +'<div class="ur-info"><strong>'+esc(u.display_name)+'</strong><span>@'+esc(u.username)+'</span></div>'
      +'<button class="btn '+(following?'btn-ghost':'btn-primary')+'" style="font-size:0.6rem;padding:0.4rem 0.9rem" onclick="toggleFollow(\''+u.id+'\','+following+',this)">'+(following?'Following':'Follow')+'</button>'
      +'</div>';
  }).join('');
}

async function toggleFollow(userId,isFollowing,btn){
  btn.disabled=true;
  if(isFollowing){
    await sb.from('follows').delete().eq('follower_id',currentUser.id).eq('following_id',userId);
    btn.textContent='Follow';btn.className='btn btn-primary';btn.style.cssText='font-size:0.6rem;padding:0.4rem 0.9rem';
    btn.onclick=function(){toggleFollow(userId,false,btn);};
  } else {
    await sb.from('follows').insert({follower_id:currentUser.id,following_id:userId});
    btn.textContent='Following';btn.className='btn btn-ghost';btn.style.cssText='font-size:0.6rem;padding:0.4rem 0.9rem';
    btn.onclick=function(){toggleFollow(userId,true,btn);};
    showToast('Following!');
  }
  btn.disabled=false;
}

// ‚îÄ‚îÄ PICK MODAL ‚îÄ‚îÄ
async function openPickModal(){
  if(isGuest){
    showToast('Sign up to make your own picks! üéµ');
    setTimeout(()=>showView('auth'),1200);
    return;
  }
  const week=getCurrentWeek();
  const year=new Date().getFullYear();
  document.getElementById('pick-week-label').textContent='Week '+week+' \u00b7 '+getWeekRange(week,year);
  document.getElementById('pick-error').textContent='';
  const {data}=await sb.from('picks').select('*').eq('user_id',currentUser.id).eq('week_number',week).eq('year',year).single();
  // Reset / pre-fill search UI
  closeSpotifyResults();
  document.getElementById('p-song').value=(data&&data.song)||'';
  document.getElementById('p-artist').value=(data&&data.artist)||'';
  document.getElementById('p-art').value=(data&&data.art_url)||'';
  document.getElementById('p-spotify').value=(data&&data.spotify_url)||'';
  document.getElementById('p-year').value=(data&&data.release_year)||'';
  document.getElementById('p-youtube').value=(data&&data.youtube_url)||'';
  document.getElementById('p-note').value=(data&&data.note)||'';
  document.getElementById('p-tags').value=(data&&data.tags&&data.tags.join(', '))||'';
  document.getElementById('p-bandinfo').value=(data&&data.band_info)||'';
  if(data&&data.song){
    document.getElementById('p-search').value=data.song+' ‚Äî '+data.artist;
    document.getElementById('p-clear-btn').style.display='inline-flex';
    document.getElementById('pick-preview-art').src=data.art_url||'';
    document.getElementById('pick-preview-song').textContent=data.song;
    document.getElementById('pick-preview-artist').textContent=data.artist;
    document.getElementById('pick-preview-year').textContent=data.release_year||'';
    document.getElementById('pick-selected-preview').style.display='block';
  } else {
    document.getElementById('p-search').value='';
    document.getElementById('p-clear-btn').style.display='none';
    document.getElementById('pick-selected-preview').style.display='none';
  }
  document.getElementById('pick-modal').classList.add('open');
}

function closePickModal(){document.getElementById('pick-modal').classList.remove('open');}

async function savePick(){
  const song=document.getElementById('p-song').value.trim();
  const artist=document.getElementById('p-artist').value.trim();
  const err=document.getElementById('pick-error');
  const btn=document.getElementById('pick-save-btn');
  err.textContent='';
  if(!song||!artist){err.textContent='Please search for and select a song first.';return;}
  const tags=document.getElementById('p-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const relatedArtists=document.getElementById('p-song').dataset.relatedArtists||'';
  const week=getCurrentWeek();
  const year=new Date().getFullYear();
  btn.disabled=true;btn.textContent='Saving...';
  const {error}=await sb.from('picks').upsert({
    user_id:currentUser.id,week_number:week,year:year,song,artist,
    note:document.getElementById('p-note').value.trim(),
    tags,release_year:document.getElementById('p-year').value.trim(),
    band_info:document.getElementById('p-bandinfo').value.trim(),
    art_url:document.getElementById('p-art').value.trim(),
    spotify_url:document.getElementById('p-spotify').value.trim(),
    youtube_url:document.getElementById('p-youtube').value.trim(),
    related_artists:relatedArtists,
  },{onConflict:'user_id,week_number,year'});
  btn.disabled=false;btn.textContent='Save Pick';
  if(error){err.textContent=error.message;return;}
  closePickModal();showToast('Pick saved! üéµ');
  if(document.getElementById('view-feed').classList.contains('active'))renderFeed();
  if(document.getElementById('view-profile').classList.contains('active'))renderProfile(currentUser.id);
}

async function changePassword(){
  const p1=document.getElementById('cp-password').value;
  const p2=document.getElementById('cp-password2').value;
  const msg=document.getElementById('cp-msg');
  const btn=document.getElementById('cp-btn');
  msg.textContent='';msg.style.color='#ff7070';
  if(!p1||!p2){msg.textContent='Please fill in both fields.';return;}
  if(p1.length<6){msg.textContent='Password must be at least 6 characters.';return;}
  if(p1!==p2){msg.textContent='Passwords do not match.';return;}
  btn.disabled=true;btn.textContent='Saving...';
  const {error}=await sb.auth.updateUser({password:p1});
  btn.disabled=false;btn.textContent='Update Password';
  if(error){msg.textContent=error.message;return;}
  document.getElementById('cp-password').value='';
  document.getElementById('cp-password2').value='';
  msg.style.color='#6bffb8';
  msg.textContent='Password updated successfully!';
  setTimeout(function(){msg.textContent='';},3000);
}

// ‚îÄ‚îÄ FORGOT / RESET PASSWORD ‚îÄ‚îÄ
function showForgotPassword(){
  showView('forgot');
  document.getElementById('forgot-email').value='';
  document.getElementById('forgot-msg').textContent='';
}

async function sendPasswordReset(){
  const email=document.getElementById('forgot-email').value.trim();
  const msg=document.getElementById('forgot-msg');
  const btn=document.getElementById('forgot-btn');
  msg.textContent='';msg.style.color='#ff7070';
  if(!email){msg.textContent='Please enter your email.';return;}
  btn.disabled=true;btn.textContent='Sending...';
  const {error}=await sb.auth.resetPasswordForEmail(email,{
    redirectTo: window.location.origin+window.location.pathname
  });
  btn.disabled=false;btn.textContent='Send Reset Link';
  if(error){msg.textContent=error.message;return;}
  msg.style.color='#6bffb8';
  msg.textContent='Reset link sent! Check your email and click the link.';
}

async function saveNewPassword(){
  const p1=document.getElementById('reset-password').value;
  const p2=document.getElementById('reset-password2').value;
  const msg=document.getElementById('reset-msg');
  const btn=document.getElementById('reset-btn');
  msg.textContent='';msg.style.color='#ff7070';
  if(!p1||!p2){msg.textContent='Please fill in both fields.';return;}
  if(p1.length<6){msg.textContent='Password must be at least 6 characters.';return;}
  if(p1!==p2){msg.textContent='Passwords do not match.';return;}
  btn.disabled=true;btn.textContent='Saving...';
  const {error}=await sb.auth.updateUser({password:p1});
  btn.disabled=false;btn.textContent='Save New Password';
  if(error){msg.textContent=error.message;return;}
  msg.style.color='#6bffb8';
  msg.textContent='Password saved! Taking you in...';
  setTimeout(async function(){
    await loadProfileAndContinue();
  },1500);
}

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ
async function loadNotifications(){
  if(isGuest||!currentUser)return;
  const {data:notifs}=await sb.from('notifications')
    .select('*')
    .eq('user_id',currentUser.id)
    .order('created_at',{ascending:false})
    .limit(30);
  const unread=(notifs||[]).filter(n=>!n.read).length;
  const badge=document.getElementById('notif-badge');
  if(unread>0){badge.textContent=unread>9?'9+':unread;badge.style.display='flex';}
  else{badge.style.display='none';}
  // Fetch actor profiles
  const actorIds=[...new Set((notifs||[]).map(n=>n.actor_id).filter(Boolean))];
  let actorMap={};
  if(actorIds.length){
    const {data:actors}=await sb.from('profiles').select('id,display_name,username').in('id',actorIds);
    actorMap=Object.fromEntries((actors||[]).map(a=>[a.id,a]));
  }
  const list=document.getElementById('notif-list');
  if(!notifs||notifs.length===0){list.innerHTML='<div class="notif-empty">No notifications yet</div>';return;}
  list.innerHTML=notifs.map(n=>{
    const actor=actorMap[n.actor_id];
    const name=actor?('<strong>'+esc(actor.display_name)+'</strong>'):'Someone';
    const icon=n.type==='listen'?'üëÄ':'üëç';
    const text=n.type==='listen'?name+' checked out your pick':name+' liked your pick';
    const time=timeAgo(n.created_at);
    const dest=n.pick_id?'onclick="closeNotifPanel();openNotifPick(\''+n.id+'\')"':'';
    return '<div class="notif-item'+(n.read?'':' unread')+'" '+dest+'>'
      +'<div class="notif-icon">'+icon+'</div>'
      +'<div class="notif-body"><div class="notif-text">'+text+'</div><div class="notif-time">'+time+'</div></div>'
      +'</div>';
  }).join('');
}

async function openNotifPick(notifId){
  // Mark as read then navigate to the pick
  await sb.from('notifications').update({read:true}).eq('id',notifId);
  const {data:n}=await sb.from('notifications').select('*').eq('id',notifId).single();
  if(!n||!n.pick_id)return;
  const {data:pick}=await sb.from('picks').select('*').eq('id',n.pick_id).single();
  if(!pick)return;
  showView('songdetail',{userId:pick.user_id,week:pick.week_number,year:pick.year});
  loadNotifications();
}

async function markAllRead(){
  if(!currentUser)return;
  await sb.from('notifications').update({read:true}).eq('user_id',currentUser.id).eq('read',false);
  loadNotifications();
}

function toggleNotifPanel(){
  const panel=document.getElementById('notif-panel');
  panel.classList.toggle('open');
  if(panel.classList.contains('open'))loadNotifications();
  closeNavDropdown();
}
function closeNotifPanel(){
  document.getElementById('notif-panel').classList.remove('open');
}

// ‚îÄ‚îÄ REACTIONS ‚îÄ‚îÄ
async function toggleReaction(pickId,pickOwnerId,btn){
  if(isGuest){showView('auth');return;}
  const reacted=btn.classList.contains('reacted');
  const countEl=btn.querySelector('.reaction-count');
  const cur=parseInt(countEl?countEl.textContent:0)||0;
  if(reacted){
    btn.classList.remove('reacted');
    if(countEl)countEl.textContent=Math.max(0,cur-1);
    // Update label if on detail page
    if(btn.id==='detail-reaction-btn')btn.lastChild.textContent=' Like this pick';
    await sb.from('reactions').delete().eq('pick_id',pickId).eq('user_id',currentUser.id);
  } else {
    btn.classList.add('reacted');
    if(countEl)countEl.textContent=cur+1;
    if(btn.id==='detail-reaction-btn')btn.lastChild.textContent=' Liked';
    await sb.from('reactions').insert({pick_id:pickId,user_id:currentUser.id,pick_owner_id:pickOwnerId});
    if(pickOwnerId!==currentUser.id){
      await sb.from('notifications').insert({user_id:pickOwnerId,type:'reaction',actor_id:currentUser.id,pick_id:pickId,read:false});
    }
    loadNotifications();
  }
}

function timeAgo(ts){
  const diff=Date.now()-new Date(ts).getTime();
  const m=Math.floor(diff/60000);const h=Math.floor(m/60);const d=Math.floor(h/24);
  if(d>0)return d+'d ago';if(h>0)return h+'h ago';if(m>0)return m+'m ago';return'just now';
}

// ‚îÄ‚îÄ SPOTIFY SEARCH ‚îÄ‚îÄ
const SPOTIFY_CLIENT_ID = 'a2775113b5b24216b96e1985633a4cc1';
const SPOTIFY_CLIENT_SECRET = 'cc6c43ee3d024b3b8cedcc28dd2ec905';
let spotifyAccessToken = null;
let spotifyTokenExpiry = 0;
let searchDebounceTimer = null;

async function getSpotifyToken(){
  // Check localStorage first ‚Äî token lasts 1 hour
  const cached = localStorage.getItem('sp_token');
  const expiry = parseInt(localStorage.getItem('sp_token_expiry')||'0');
  if(cached && Date.now() < expiry) return cached;
  // Prevent parallel fetches
  if(getSpotifyToken._pending) return getSpotifyToken._pending;
  getSpotifyToken._pending = fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'grant_type=client_credentials&client_id='+SPOTIFY_CLIENT_ID+'&client_secret='+SPOTIFY_CLIENT_SECRET
  }).then(async r=>{
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch(e){ throw new Error('Spotify rate limited ‚Äî try again later'); }
    console.log('Spotify token response:', data);
    if(!data.access_token) throw new Error('Spotify error: '+(data.error_description||data.error||JSON.stringify(data)));
    localStorage.setItem('sp_token', data.access_token);
    localStorage.setItem('sp_token_expiry', Date.now() + (data.expires_in - 120) * 1000);
    spotifyAccessToken = data.access_token;
    spotifyTokenExpiry = Date.now() + (data.expires_in - 120) * 1000;
    getSpotifyToken._pending = null;
    return data.access_token;
  }).catch(e=>{ console.error('Spotify token error:', e); getSpotifyToken._pending=null; throw e; });
  return getSpotifyToken._pending;
}

async function spotifyFetch(url, token){
  const r = await fetch(url, {headers:{'Authorization':'Bearer '+token}});
  const text = await r.text();
  try { return JSON.parse(text); }
  catch(e){ throw new Error('Spotify rate limited ‚Äî try again later'); }
}
function debounceSpotifySearch(){
  clearTimeout(searchDebounceTimer);
  const q = document.getElementById('p-search').value.trim();
  if(!q){ closeSpotifyResults(); return; }
  searchDebounceTimer = setTimeout(()=>doSpotifySearch(q), 350);
}

async function doSpotifySearch(q){
  const resultsEl = document.getElementById('spotify-search-results');
  resultsEl.innerHTML = '<div class="spotify-result-searching">Searching...</div>';
  resultsEl.classList.add('open');
  try {
    const token = await getSpotifyToken();
    const data = await spotifyFetch('https://api.spotify.com/v1/search?q='+encodeURIComponent(q)+'&type=track&limit=8', token);
    const tracks = (data.tracks && data.tracks.items) || [];
    if(!tracks.length){ resultsEl.innerHTML='<div class="spotify-result-searching">No results found</div>'; return; }
    resultsEl.innerHTML = tracks.map((t,i)=>{
      const art = t.album.images[2]||t.album.images[0];
      const artUrl = art ? art.url : '';
      const year = t.album.release_date ? t.album.release_date.split('-')[0] : '';
      const artists = t.artists.map(a=>a.name).join(', ');
      return '<div class="spotify-result" onclick="selectSpotifyTrack('+i+')">'
        +'<img class="spotify-result-art" src="'+esc(artUrl)+'" alt="" />'
        +'<div class="spotify-result-info">'
        +'<div class="spotify-result-song">'+esc(t.name)+'</div>'
        +'<div class="spotify-result-artist">'+esc(artists)+' ¬∑ '+year+'</div>'
        +'</div></div>';
    }).join('');
    // Store results for selection
    resultsEl._tracks = tracks;
  } catch(e){ resultsEl.innerHTML='<div class="spotify-result-searching">Search failed ‚Äî check connection</div>'; }
}

async function selectSpotifyTrack(idx){
  const resultsEl = document.getElementById('spotify-search-results');
  const track = resultsEl._tracks[idx];
  if(!track)return;
  const art = track.album.images[0];
  const artUrl = art ? art.url : '';
  const year = track.album.release_date ? track.album.release_date.split('-')[0] : '';
  const artists = track.artists.map(a=>a.name).join(', ');
  const primaryArtistId = track.artists[0].id;

  // Fill basic hidden fields immediately
  document.getElementById('p-song').value = track.name;
  document.getElementById('p-artist').value = artists;
  document.getElementById('p-art').value = artUrl;
  document.getElementById('p-spotify').value = track.external_urls.spotify;
  document.getElementById('p-year').value = year;

  // Show preview right away
  document.getElementById('p-search').value = track.name + ' ‚Äî ' + artists;
  document.getElementById('p-clear-btn').style.display = 'inline-flex';
  document.getElementById('pick-preview-art').src = artUrl;
  document.getElementById('pick-preview-song').textContent = track.name;
  document.getElementById('pick-preview-artist').textContent = artists;
  document.getElementById('pick-preview-year').textContent = year ? year + ' ¬∑ ' + track.album.name : track.album.name;
  document.getElementById('pick-selected-preview').style.display = 'block';
  closeSpotifyResults();

  // Show loading state on enriched fields
  document.getElementById('p-tags').value = 'Loading genres...';
  document.getElementById('p-bandinfo').value = 'Loading artist info...';

  try {
    const token = await getSpotifyToken();
    const [artistData] = await Promise.all([
      spotifyFetch('https://api.spotify.com/v1/artists/'+primaryArtistId, token)
    ]);
    const relatedNames = getRelatedArtistsFromDB(track.artists[0].name, artistData.genres||[]) || [];

    // Auto-fill genre tags from Spotify
    const genres = (artistData.genres||[]).slice(0,5);
    document.getElementById('p-tags').value = genres.join(', ');

    // Build artist info paragraph
    const followers = artistData.followers ? artistData.followers.total.toLocaleString() : null;
    const popularity = artistData.popularity || null;

    let bioLines = [];
    if(genres.length) bioLines.push(genres.slice(0,3).join(', ')+(genres.length>3?' and more':'')+' artist');
    if(followers) bioLines.push(followers+' followers on Spotify');
    if(popularity) bioLines.push('Popularity score: '+popularity+'/100');

    document.getElementById('p-bandinfo').value = bioLines.join(' ¬∑ ');

    // Store related artists for similar music section
    document.getElementById('p-song').dataset.relatedArtists = relatedNames.join(',');
    document.getElementById('p-song').dataset.genres = genres.join(',');

  } catch(e){
    document.getElementById('p-tags').value = '';
    document.getElementById('p-bandinfo').value = '';
  }
}

function clearPickSelection(){
  document.getElementById('p-song').value='';
  document.getElementById('p-artist').value='';
  document.getElementById('p-art').value='';
  document.getElementById('p-spotify').value='';
  document.getElementById('p-year').value='';
  document.getElementById('p-search').value='';
  document.getElementById('p-clear-btn').style.display='none';
  document.getElementById('pick-selected-preview').style.display='none';
  closeSpotifyResults();
  document.getElementById('p-search').focus();
}

function closeSpotifyResults(){
  const el=document.getElementById('spotify-search-results');
  el.classList.remove('open');
  el.innerHTML='';
}

let currentPick = null; // holds pick for enrichment


// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showToast(msg,isErr){
  const t=document.getElementById('toast');t.textContent=msg;
  t.className='toast'+(isErr?' err':'');t.classList.add('show');
  setTimeout(function(){t.classList.remove('show');},2800);
}
document.getElementById('pick-modal').addEventListener('click',function(e){if(e.target.id==='pick-modal')closePickModal();});

// ‚îÄ‚îÄ BOOT ‚Äî goes straight to auth, no setup screen ‚îÄ‚îÄ
(async function init(){
  const {data:{session}}=await sb.auth.getSession();
  if(session){currentUser=session.user;await loadProfileAndContinue();}
  else showView('auth');
  sb.auth.onAuthStateChange(async function(event,session){
    if(event==='PASSWORD_RECOVERY'){
      showView('resetpassword');
      document.getElementById('reset-msg').textContent='';
      document.getElementById('reset-password').value='';
      document.getElementById('reset-password2').value='';
    } else if(event==='SIGNED_IN'&&session&&!currentUser){
      currentUser=session.user;await loadProfileAndContinue();
    }
  });
})();
</script>
</body>
</html>
