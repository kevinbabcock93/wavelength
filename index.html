<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wavelength ‚Äî Song of the Week</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #080808;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --red: #cc0000;
    --red-bright: #ff1a1a;
    --red-dim: #660000;
    --white: #f0f0f0;
    --white-dim: #aaaaaa;
    --white-dimmer: #555555;
    --text: #f0f0f0;
    --text-muted: #888888;
    --text-dim: #3a3a3a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Crimson Pro', serif; min-height: 100vh; overflow-x: hidden; }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 1000; opacity: 0.5;
  }

  .music-bg { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
  .music-bg svg { position: absolute; opacity: 0.03; fill: var(--white); }

  .view { display: none; position: relative; z-index: 1; }
  .view.active { display: block; }

  nav {
    position: sticky; top: 0; z-index: 200;
    background: rgba(8,8,8,0.95); backdrop-filter: blur(20px);
    border-bottom: 2px solid var(--red);
    padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 64px;
  }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 0.08em; color: var(--white); cursor: pointer; display: flex; align-items: center; gap: 0.4rem; }
  .logo .logo-dot { color: var(--red); }
  .nav-links { display: flex; gap: 0; align-items: center; }
  .nav-link { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); cursor: pointer; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; background: none; border-left: none; border-right: none; border-top: none; }
  .nav-link:hover, .nav-link.active { color: var(--white); border-bottom-color: var(--red); }
  .nav-actions { display: flex; gap: 0.6rem; align-items: center; }
  .nav-user { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; color: var(--text-muted); }

  .btn { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; padding: 0.5rem 1.1rem; border-radius: 2px; border: none; cursor: pointer; transition: all 0.15s; }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
  .btn-ghost:hover { border-color: var(--white-dimmer); color: var(--white); }
  .btn-primary { background: var(--red); color: var(--white); border: 1px solid var(--red); }
  .btn-primary:hover { background: var(--red-bright); border-color: var(--red-bright); transform: translateY(-1px); }
  .btn-outline { background: transparent; border: 1px solid var(--red); color: var(--red); }
  .btn-outline:hover { background: var(--red); color: var(--white); }
  .btn-danger { background: transparent; border: 1px solid #660000; color: #cc4444; }
  .btn-danger:hover { background: #330000; }
  .btn-wide { width: 100%; padding: 0.9rem; font-size: 0.78rem; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

  .form-group { margin-bottom: 1.25rem; }
  .form-group label { display: block; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--text-muted); margin-bottom: 0.4rem; }
  .form-group input, .form-group textarea { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 2px; padding: 0.75rem 0.9rem; color: var(--text); font-family: 'Crimson Pro', serif; font-size: 1rem; transition: border-color 0.15s; outline: none; }
  .form-group input:focus, .form-group textarea:focus { border-color: var(--red); }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-hint { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.35rem; }
  .form-error { color: #ff6666; font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; margin-top: 0.4rem; text-align: center; }

  .center-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
  .center-box { width: 100%; max-width: 480px; }

  .setup-logo { font-family: 'Bebas Neue', sans-serif; font-size: 4rem; letter-spacing: 0.1em; color: var(--white); margin-bottom: 0.2rem; line-height: 1; }
  .setup-logo span { color: var(--red); }
  .setup-tagline { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2.5rem; line-height: 1.7; }
  .step-card { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--red); border-radius: 2px; padding: 1.4rem 1.5rem; margin-bottom: 1rem; }
  .step-num { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--red); text-transform: uppercase; letter-spacing: 0.14em; margin-bottom: 0.5rem; }
  .step-card h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.06em; margin-bottom: 0.6rem; color: var(--white); }
  .step-card p, .step-card li { font-size: 0.92rem; color: var(--text-muted); line-height: 1.65; }
  .step-card ul { padding-left: 1.2rem; }
  .step-card li { margin-bottom: 0.35rem; }
  .step-card strong { color: var(--white); }
  .code-block { background: #030303; border: 1px solid var(--border); border-radius: 2px; padding: 1rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; color: #44ff88; margin-top: 0.85rem; white-space: pre; overflow-x: auto; line-height: 1.65; }
  .copy-btn { display: inline-block; margin-top: 0.5rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); cursor: pointer; border: none; background: none; padding: 0; transition: color 0.15s; }
  .copy-btn:hover { color: var(--red); }
  .creds-section { margin-top: 1.5rem; }
  .creds-section h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.06em; margin-bottom: 0.3rem; }
  .creds-section p { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.6; }
  .cred-group { margin-bottom: 0.9rem; }
  .cred-group label { display: block; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.35rem; }
  .cred-group input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 2px; padding: 0.7rem 0.9rem; color: var(--text); font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; outline: none; transition: border-color 0.15s; }
  .cred-group input:focus { border-color: var(--red); }

  .auth-logo { font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem; letter-spacing: 0.1em; color: var(--white); margin-bottom: 0.2rem; }
  .auth-logo span { color: var(--red); }
  .auth-tagline { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.7; }
  .magic-sent-box { background: var(--surface); border: 1px solid var(--red); border-radius: 2px; padding: 1.75rem; text-align: center; }
  .magic-sent-box .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
  .magic-sent-box h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 0.06em; margin-bottom: 0.5rem; }
  .magic-sent-box p { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); line-height: 1.7; }

  .ob-box h2 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 0.06em; margin-bottom: 0.4rem; }
  .ob-box .sub { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.65; }

  .color-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; flex-shrink: 0; }
  .swatch:hover, .swatch.on { border-color: white; transform: scale(1.12); }

  .feed-hero { background: var(--surface); border-bottom: 2px solid var(--red); padding: 3rem 2rem 2.5rem; position: relative; overflow: hidden; }
  .feed-hero::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(-45deg, transparent, transparent 40px, rgba(204,0,0,0.02) 40px, rgba(204,0,0,0.02) 80px); }
  .feed-hero-inner { max-width: 960px; margin: 0 auto; position: relative; }
  .feed-hero h1 { font-family: 'Bebas Neue', sans-serif; font-size: 4rem; letter-spacing: 0.06em; line-height: 0.9; color: var(--white); margin-bottom: 0.5rem; }
  .feed-hero h1 span { color: var(--red); }
  .feed-hero .week-info { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-muted); margin-top: 0.75rem; display: flex; align-items: center; gap: 1rem; }
  .week-badge { background: var(--red); color: white; font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em; padding: 0.2rem 0.6rem; border-radius: 1px; }

  .feed-grid { max-width: 960px; margin: 0 auto; padding: 2rem 2rem 4rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1px; background: var(--border); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
  .friend-card { background: var(--surface); cursor: pointer; transition: background 0.15s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
  .friend-card:hover { background: var(--surface2); }
  .friend-card:hover .card-art { transform: scale(1.03); }
  .card-art-wrap { width: 100%; aspect-ratio: 1; overflow: hidden; background: #0d0d0d; position: relative; }
  .card-art { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; display: block; }
  .card-art-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0d0d0d, #1a0000); }
  .card-body { padding: 1rem 1.1rem 1.2rem; flex: 1; }
  .card-username { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.35rem; display: flex; align-items: center; gap: 0.4rem; }
  .card-username .dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .card-song { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.04em; line-height: 1.1; margin-bottom: 0.2rem; color: var(--white); }
  .card-artist { font-size: 0.88rem; color: var(--text-muted); font-style: italic; }
  .no-pick { color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; padding: 2rem 1.1rem; }
  .card-arrow { position: absolute; top: 1rem; right: 1rem; color: var(--red); font-size: 0.9rem; opacity: 0; transition: opacity 0.15s; }
  .friend-card:hover .card-arrow { opacity: 1; }

  .section-header { max-width: 960px; margin: 0 auto; padding: 2rem 2rem 1rem; display: flex; align-items: baseline; gap: 1rem; border-bottom: 1px solid var(--border); }
  .section-header h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 0.06em; }
  .section-header .count { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; color: var(--text-muted); }

  .browse-grid { max-width: 960px; margin: 0 auto; padding: 1rem 2rem 4rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1px; background: var(--border); border: 1px solid var(--border); }
  .browse-card { background: var(--surface); padding: 1.5rem; cursor: pointer; transition: background 0.15s; text-align: center; }
  .browse-card:hover { background: var(--surface2); }
  .browse-avatar { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; margin: 0 auto 0.75rem; border: 2px solid transparent; transition: border-color 0.15s; }
  .browse-card:hover .browse-avatar { border-color: var(--red); }
  .browse-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.04em; margin-bottom: 0.15rem; }
  .browse-username { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-muted); }
  .browse-picks { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; color: var(--red); margin-top: 0.4rem; }

  .profile-hero { background: var(--surface); border-bottom: 2px solid var(--red); padding: 2.5rem 2rem; position: relative; overflow: hidden; }
  .profile-hero::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(-45deg, transparent, transparent 30px, rgba(204,0,0,0.015) 30px, rgba(204,0,0,0.015) 60px); }
  .profile-hero-inner { max-width: 860px; margin: 0 auto; display: flex; align-items: flex-end; gap: 1.5rem; position: relative; }
  .p-avatar { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; flex-shrink: 0; border: 3px solid var(--red); }
  .p-name { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 0.04em; line-height: 1; }
  .p-username { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-muted); margin-top: 0.2rem; }
  .p-stats { display: flex; gap: 1.5rem; margin-top: 0.5rem; }
  .p-stat { font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; color: var(--text-muted); }
  .p-stat strong { color: var(--red); font-size: 0.9rem; display: block; }

  .weeks-wrap { max-width: 860px; margin: 0 auto; padding: 0 2rem 4rem; }
  .week-row { display: grid; grid-template-columns: 60px 60px 1fr auto; align-items: center; gap: 1rem; padding: 0.9rem 0.5rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; border-radius: 2px; margin: 0 -0.5rem; }
  .week-row:hover { background: var(--surface); }
  .week-row.is-cur .wk-num { color: var(--red); }
  .week-thumb { width: 52px; height: 52px; border-radius: 2px; object-fit: cover; border: 1px solid var(--border); background: #0d0d0d; flex-shrink: 0; }
  .week-thumb-ph { width: 52px; height: 52px; border-radius: 2px; border: 1px solid var(--border); background: #0d0d0d; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .wk-num { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
  .wk-song strong { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.03em; display: block; line-height: 1.1; }
  .wk-song span { font-size: 0.85rem; color: var(--text-muted); font-style: italic; }
  .wk-arrow { color: var(--text-dim); font-size: 0.9rem; }
  .week-row:hover .wk-arrow { color: var(--red); }

  .song-wrap { max-width: 760px; margin: 0 auto; padding: 0 2rem 4rem; }
  .song-hero { padding: 2.5rem 0 2rem; border-bottom: 2px solid var(--red); display: grid; grid-template-columns: 180px 1fr; gap: 2rem; align-items: start; }
  .song-art { width: 180px; height: 180px; object-fit: cover; border-radius: 2px; border: 1px solid var(--border); background: #0d0d0d; display: block; }
  .song-art-ph { width: 180px; height: 180px; border-radius: 2px; border: 1px solid var(--border); background: #0d0d0d; display: flex; align-items: center; justify-content: center; }
  .song-badge { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 0.75rem; }
  .song-title { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; letter-spacing: 0.04em; line-height: 0.95; margin-bottom: 0.4rem; color: var(--white); }
  .song-artist { font-size: 1.15rem; color: var(--text-muted); font-style: italic; }
  .song-tags { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.9rem; }
  .tag { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.06em; padding: 0.22rem 0.55rem; border-radius: 1px; border: 1px solid var(--red); color: var(--red); }
  .detail-sec { padding: 2rem 0; border-bottom: 1px solid var(--border); }
  .detail-sec:last-child { border-bottom: none; }
  .detail-sec h3 { font-family: 'IBM Plex Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--red); margin-bottom: 1.2rem; }
  .detail-sec p { font-size: 1rem; line-height: 1.75; color: var(--white-dim); }
  .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
  .stat-row:last-child { border-bottom: none; }
  .stat-row .lbl { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; }
  .similar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .sim-item { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; padding: 0.85rem 1rem; transition: border-color 0.15s; }
  .sim-item:hover { border-color: var(--red); }
  .sim-item strong { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.03em; display: block; margin-bottom: 0.1rem; }
  .sim-item span { font-size: 0.82rem; color: var(--text-muted); font-style: italic; }

  .settings-wrap { max-width: 560px; margin: 0 auto; padding: 2rem; }
  .settings-wrap h2 { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 0.06em; margin-bottom: 0.3rem; }
  .settings-wrap .sub { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 2rem; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 1.75rem 0; }
  .user-result { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
  .user-result:last-child { border-bottom: none; }
  .ur-av { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 1rem; flex-shrink: 0; }
  .ur-info { flex: 1; }
  .ur-info strong { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.03em; }
  .ur-info span { display: block; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--text-muted); }

  .back-btn { background: none; border: none; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; transition: color 0.15s; padding: 0; }
  .back-btn:hover { color: var(--red); }
  .back-wrap { max-width: 860px; margin: 0 auto; padding: 1.5rem 2rem 0; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.82); backdrop-filter: blur(12px); z-index: 500; display: none; align-items: center; justify-content: center; padding: 1rem; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-top: 3px solid var(--red); border-radius: 2px; padding: 2rem; width: 100%; max-width: 520px; position: relative; max-height: 92vh; overflow-y: auto; }
  .modal h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 0.06em; margin-bottom: 0.2rem; }
  .modal .modal-sub { color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.68rem; margin-bottom: 1.5rem; }
  .modal-close { position: absolute; top: 1.2rem; right: 1.2rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; transition: color 0.15s; line-height: 1; }
  .modal-close:hover { color: var(--red); }
  .art-preview { width: 80px; height: 80px; border-radius: 2px; object-fit: cover; border: 1px solid var(--border); display: none; margin-bottom: 1rem; }
  .art-preview.show { display: block; }

  .spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--red); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-center { display: flex; align-items: center; justify-content: center; padding: 4rem; }
  .empty-state { text-align: center; padding: 4rem 2rem; }
  .empty-state .eicon { font-size: 2.5rem; margin-bottom: 1rem; }
  .empty-state p { font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; color: var(--text-muted); line-height: 1.7; margin-bottom: 1.5rem; }

  .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(120px); background: var(--red); color: white; font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; font-weight: 500; padding: 0.7rem 1.4rem; border-radius: 2px; z-index: 9999; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.ok { background: #006600; }

  @media (max-width: 640px) {
    .song-hero { grid-template-columns: 1fr; }
    .song-art, .song-art-ph { width: 100%; height: 200px; }
    .similar-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .week-row { grid-template-columns: 52px 1fr auto; }
    nav { padding: 0 1rem; }
    .nav-links { display: none; }
    .feed-hero h1 { font-size: 2.8rem; }
    .song-title { font-size: 2.2rem; }
  }
</style>
</head>
<body>

<div class="music-bg" aria-hidden="true">
  <svg style="top:-5%;right:-8%;width:500px;height:500px" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" stroke="white" stroke-width="1" fill="none"/><circle cx="50" cy="50" r="38" stroke="white" stroke-width="0.5" fill="none"/><circle cx="50" cy="50" r="28" stroke="white" stroke-width="0.5" fill="none"/><circle cx="50" cy="50" r="18" stroke="white" stroke-width="0.5" fill="none"/><circle cx="50" cy="50" r="5" fill="white"/></svg>
  <svg style="bottom:10%;left:-5%;width:400px;height:280px" viewBox="0 0 140 100"><rect x="5" y="15" width="130" height="70" rx="6" stroke="white" stroke-width="2" fill="none"/><circle cx="40" cy="50" r="15" stroke="white" stroke-width="1.5" fill="none"/><circle cx="100" cy="50" r="15" stroke="white" stroke-width="1.5" fill="none"/><circle cx="40" cy="50" r="5" fill="white"/><circle cx="100" cy="50" r="5" fill="white"/><line x1="55" y1="50" x2="85" y2="50" stroke="white" stroke-width="1"/><rect x="55" y="60" width="30" height="10" rx="2" stroke="white" stroke-width="1" fill="none"/></svg>
  <svg style="top:30%;left:2%;width:120px;height:120px" viewBox="0 0 60 60"><text x="5" y="45" font-size="40" fill="white">‚ô™</text></svg>
  <svg style="top:60%;right:3%;width:100px;height:100px" viewBox="0 0 60 60"><text x="5" y="45" font-size="40" fill="white">‚ô´</text></svg>
  <svg style="bottom:-5%;right:5%;width:300px;height:300px" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="8" stroke="white" stroke-width="2" fill="none"/><circle cx="50" cy="50" r="28" stroke="white" stroke-width="1.5" fill="none"/><circle cx="50" cy="50" r="18" stroke="white" stroke-width="1.5" fill="none"/><circle cx="50" cy="50" r="6" fill="white"/><circle cx="20" cy="20" r="5" stroke="white" stroke-width="1.5" fill="none"/></svg>
  <svg style="top:15%;right:2%;width:80px;height:200px" viewBox="0 0 40 100"><rect x="15" y="0" width="10" height="80" rx="5" stroke="white" stroke-width="1.5" fill="none"/><ellipse cx="20" cy="85" rx="12" ry="15" stroke="white" stroke-width="1.5" fill="none"/><line x1="5" y1="15" x2="35" y2="15" stroke="white" stroke-width="1"/><line x1="5" y1="25" x2="35" y2="25" stroke="white" stroke-width="1"/></svg>
</div>

<!-- SETUP -->
<div class="view active" id="view-setup">
  <div class="center-screen" style="align-items:flex-start;padding-top:3rem">
    <div class="center-box" style="max-width:520px">
      <div class="setup-logo">WAVE<span>LENGTH</span></div>
      <p class="setup-tagline">Connect a free Supabase database to get started.<br>Follow the four steps below ‚Äî takes about 5 minutes.</p>
      <div class="step-card"><div class="step-num">Step 1 of 4</div><h3>Create a Supabase account</h3><ul><li>Go to <strong>supabase.com</strong> and sign up for free</li><li>Click <strong>"New project"</strong>, give it a name like <em>wavelength</em></li><li>Choose a region close to you, set a database password, click <strong>"Create new project"</strong></li><li>Wait ~2 minutes for setup to complete</li></ul></div>
      <div class="step-card"><div class="step-num">Step 2 of 4</div><h3>Enable Magic Link login</h3><ul><li>In Supabase, click <strong>Authentication</strong> in the left sidebar</li><li>Click <strong>Providers</strong> ‚Äî make sure <strong>Email</strong> is enabled ‚úì</li><li>Make sure <strong>"Confirm email"</strong> is turned <strong>ON</strong></li></ul></div>
      <div class="step-card"><div class="step-num">Step 3 of 4</div><h3>Create the database tables</h3><p>Go to <strong>SQL Editor ‚Üí New query</strong>, paste the SQL below, and click <strong>Run</strong>.</p>
        <div class="code-block" id="sql-block">-- Profiles
create table profiles (
  id uuid references auth.users primary key,
  username text unique not null,
  display_name text not null,
  color text default '#cc0000',
  created_at timestamptz default now()
);

-- Picks (one per user per week)
create table picks (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references profiles(id) on delete cascade,
  week_number integer not null,
  song text not null,
  artist text not null,
  note text,
  tags text[],
  year text,
  band_info text,
  artwork_url text,
  created_at timestamptz default now(),
  unique(user_id, week_number)
);

-- Follows
create table follows (
  follower_id uuid references profiles(id) on delete cascade,
  following_id uuid references profiles(id) on delete cascade,
  created_at timestamptz default now(),
  primary key (follower_id, following_id)
);

-- Security
alter table profiles enable row level security;
alter table picks enable row level security;
alter table follows enable row level security;

create policy "Profiles public" on profiles for select using (true);
create policy "Insert own profile" on profiles for insert with check (auth.uid() = id);
create policy "Update own profile" on profiles for update using (auth.uid() = id);
create policy "Picks public" on picks for select using (true);
create policy "Manage own picks" on picks for all using (auth.uid() = user_id);
create policy "Follows public" on follows for select using (true);
create policy "Manage own follows" on follows for all using (auth.uid() = follower_id);</div>
        <button class="copy-btn" onclick="copySQL()">‚éò Copy SQL</button>
      </div>
      <div class="step-card"><div class="step-num">Step 4 of 4</div><h3>Get your API credentials</h3><ul><li>Go to <strong>Project Settings ‚Üí API</strong> (gear icon, bottom of sidebar)</li><li>Copy your <strong>Project URL</strong> and <strong>anon / public key</strong></li><li>Paste them below</li></ul></div>
      <div class="creds-section">
        <h3>Paste Your Credentials</h3>
        <p>Saved in your browser only ‚Äî never sent anywhere else.</p>
        <div class="cred-group"><label>Project URL</label><input type="text" id="setup-url" placeholder="https://xxxxxxxxxxx.supabase.co" /></div>
        <div class="cred-group"><label>Anon / Public Key</label><input type="text" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." /></div>
        <br>
        <button class="btn btn-primary btn-wide" onclick="connectSupabase()">Connect & Continue ‚Üí</button>
        <div id="setup-error" class="form-error" style="margin-top:0.6rem"></div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH -->
<div class="view" id="view-auth">
  <div class="center-screen">
    <div class="center-box">
      <div class="auth-logo">WAVE<span>LENGTH</span></div>
      <p class="auth-tagline">One song. Every week. Share what's moving you.<br>Enter your email ‚Äî we'll send a magic sign-in link. No password needed.</p>
      <div id="auth-form">
        <div class="form-group"><label>Your Email</label><input type="email" id="auth-email" placeholder="you@example.com" /><p class="form-hint">We'll email you a link. Click it and you're in.</p></div>
        <button class="btn btn-primary btn-wide" id="auth-btn" onclick="sendMagicLink()">Send Magic Link ‚Üí</button>
        <div id="auth-error" class="form-error" style="margin-top:0.5rem"></div>
      </div>
      <div id="auth-sent" style="display:none">
        <div class="magic-sent-box"><div class="icon">‚úâÔ∏è</div><h3>Check Your Inbox</h3><p>We sent a sign-in link to <strong id="auth-sent-email"></strong>.<br><br>Click the link in the email to sign in.</p></div>
        <p style="margin-top:1rem;font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--text-muted);text-align:center;cursor:pointer" onclick="resetAuth()">‚Üê Use a different email</p>
      </div>
      <p style="margin-top:2rem;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--text-dim);text-align:center;cursor:pointer" onclick="resetSetup()">‚Üê Change Supabase credentials</p>
    </div>
  </div>
</div>

<!-- ONBOARDING -->
<div class="view" id="view-onboarding">
  <div class="center-screen">
    <div class="center-box ob-box">
      <h2>Set Up Your Profile</h2>
      <p class="sub">You're in! Pick a name and username ‚Äî this is what your friends will see.</p>
      <div class="form-group"><label>Display Name</label><input type="text" id="ob-name" placeholder="e.g. Jamie" /></div>
      <div class="form-group"><label>Username</label><input type="text" id="ob-username" placeholder="e.g. jamie_listens" /><p class="form-hint">Letters, numbers, underscores only.</p></div>
      <div class="form-group"><label>Avatar Color</label><div class="color-row" id="ob-colors"></div></div>
      <button class="btn btn-primary btn-wide" id="ob-btn" onclick="createProfile()">Enter Wavelength ‚Üí</button>
      <div id="ob-error" class="form-error" style="margin-top:0.5rem"></div>
    </div>
  </div>
</div>

<!-- NAV -->
<nav id="mainNav" style="display:none">
  <div class="logo" onclick="showView('feed')">WAVE<span class="logo-dot">‚óè</span>LENGTH</div>
  <div class="nav-links">
    <button class="nav-link" id="nl-feed" onclick="showView('feed')">Feed</button>
    <button class="nav-link" id="nl-browse" onclick="showView('browse')">Browse Users</button>
    <button class="nav-link" id="nl-myprofile" onclick="showView('profile',{userId:currentUser?.id})">My Profile</button>
    <button class="nav-link" id="nl-settings" onclick="showView('settings')">Settings</button>
  </div>
  <div class="nav-actions">
    <span class="nav-user" id="nav-user"></span>
    <button class="btn btn-primary" onclick="openPickModal()">+ This Week</button>
  </div>
</nav>

<!-- FEED -->
<div class="view" id="view-feed">
  <div class="feed-hero">
    <div class="feed-hero-inner">
      <h1>THIS WEEK'S<br><span>PICKS</span></h1>
      <div class="week-info"><span class="week-badge" id="feed-pill">Week 1</span><span id="feed-range"></span></div>
    </div>
  </div>
  <div class="feed-grid" id="friends-grid"><div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div></div>
</div>

<!-- BROWSE -->
<div class="view" id="view-browse">
  <div class="section-header"><h2>All Users</h2><span class="count" id="browse-count"></span></div>
  <div class="browse-grid" id="browse-grid"><div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div></div>
</div>

<!-- PROFILE -->
<div class="view" id="view-profile">
  <div class="back-wrap"><button class="back-btn" id="profile-back">‚Üê Back</button></div>
  <div class="profile-hero" id="profile-hero"></div>
  <div class="weeks-wrap" id="weeks-list"></div>
</div>

<!-- SONG DETAIL -->
<div class="view" id="view-songdetail">
  <div class="song-wrap">
    <div style="padding-top:1.5rem;margin-bottom:0.5rem"><button class="back-btn" id="song-back">‚Üê Back to Profile</button></div>
    <div id="song-content"></div>
  </div>
</div>

<!-- SETTINGS -->
<div class="view" id="view-settings">
  <div class="settings-wrap">
    <button class="back-btn" style="margin-bottom:1.5rem" onclick="showView('feed')">‚Üê Back to Feed</button>
    <h2>Settings</h2>
    <p class="sub">Update your profile or find friends to follow</p>
    <div class="form-group"><label>Display Name</label><input type="text" id="s-name" /></div>
    <div class="form-group"><label>Username</label><input type="text" id="s-username" /></div>
    <div class="form-group"><label>Avatar Color</label><div class="color-row" id="s-colors"></div></div>
    <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
    <hr class="divider">
    <h3 style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:0.06em;margin-bottom:0.4rem">Find Friends</h3>
    <p style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--text-muted);margin-bottom:1rem">Search by username to follow people</p>
    <div style="display:flex;gap:0.75rem;margin-bottom:1rem">
      <input type="text" id="search-q" placeholder="Search username..." style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:0.65rem 0.9rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:1rem;outline:none;transition:border-color 0.15s" onfocus="this.style.borderColor='var(--red)'" onblur="this.style.borderColor='var(--border)'" />
      <button class="btn btn-outline" onclick="searchUsers()">Search</button>
    </div>
    <div id="search-results"></div>
    <hr class="divider">
    <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
  </div>
</div>

<!-- PICK MODAL -->
<div class="modal-overlay" id="pick-modal">
  <div class="modal">
    <button class="modal-close" onclick="closePickModal()">‚úï</button>
    <h3>This Week's Pick</h3>
    <p class="modal-sub" id="pick-week-label"></p>
    <img class="art-preview" id="art-preview" src="" alt="Album art" />
    <div class="form-row">
      <div class="form-group"><label>Song Title</label><input type="text" id="p-song" placeholder="e.g. Karma Police" oninput="debounceArt()" /></div>
      <div class="form-group"><label>Artist / Band</label><input type="text" id="p-artist" placeholder="e.g. Radiohead" oninput="debounceArt()" /></div>
    </div>
    <div class="form-group"><label>Why this song? <span style="color:var(--text-dim)">(optional)</span></label><textarea id="p-note" placeholder="What makes this your pick this week?"></textarea></div>
    <div class="form-row">
      <div class="form-group"><label>Vibe Tags <span style="color:var(--text-dim)">(comma-separated)</span></label><input type="text" id="p-tags" placeholder="e.g. alt-rock, melancholic" /></div>
      <div class="form-group"><label>Release Year <span style="color:var(--text-dim)">(optional)</span></label><input type="text" id="p-year" placeholder="e.g. 1997" /></div>
    </div>
    <div class="form-group"><label>About the Artist <span style="color:var(--text-dim)">(optional)</span></label><textarea id="p-bandinfo" placeholder="A little background on the artist..."></textarea></div>
    <button class="btn btn-primary btn-wide" id="pick-save-btn" onclick="savePick()">Save Pick ‚Üí</button>
    <div id="pick-error" class="form-error" style="margin-top:0.5rem"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SIM_SONGS = {
  'kate bush':['Running Up That Hill ‚Äî Kate Bush','Wuthering Heights ‚Äî Kate Bush','Cloudbusting ‚Äî Kate Bush'],
  'radiohead':['Exit Music ‚Äî Radiohead','How to Disappear Completely ‚Äî Radiohead','Street Spirit ‚Äî Radiohead'],
  'kendrick lamar':['Alright ‚Äî Kendrick Lamar','DNA. ‚Äî Kendrick Lamar','m.A.A.d city ‚Äî Kendrick Lamar'],
  'frank ocean':['Nights ‚Äî Frank Ocean','Self Control ‚Äî Frank Ocean','Pink + White ‚Äî Frank Ocean'],
  'alt-j':['Tessellate ‚Äî alt-J','Breezeblocks ‚Äî alt-J','Something Good ‚Äî alt-J'],
  'beach house':['Space Song ‚Äî Beach House','Silver Soul ‚Äî Beach House','Myth ‚Äî Beach House'],
  'tame impala':['Let It Happen ‚Äî Tame Impala','Feels Like We Only Go Backwards ‚Äî Tame Impala','Eventually ‚Äî Tame Impala'],
  'the national':['Bloodbuzz Ohio ‚Äî The National','Sorrow ‚Äî The National','Terrible Love ‚Äî The National'],
  'bon iver':['Holocene ‚Äî Bon Iver','Skinny Love ‚Äî Bon Iver','Towers ‚Äî Bon Iver'],
  'phoebe bridgers':['Motion Sickness ‚Äî Phoebe Bridgers','Savior Complex ‚Äî Phoebe Bridgers','Funeral ‚Äî Phoebe Bridgers'],
};
const SIM_ARTISTS = {
  'kate bush':['Bj√∂rk','Florence + The Machine','Tori Amos','Bat for Lashes'],
  'radiohead':['Portishead','Thom Yorke','Sigur R√≥s','The National'],
  'kendrick lamar':['J. Cole','Isaiah Rashad','ScHoolboy Q','Jay Rock'],
  'frank ocean':['Syd','Steve Lacy','Brent Faiyaz','Daniel Caesar'],
  'alt-j':['Bon Iver','The xx','Foals','Glass Animals'],
  'beach house':['Mazzy Star','Cocteau Twins','Washed Out','Cigarettes After Sex'],
  'tame impala':['MGMT','Unknown Mortal Orchestra','Pond','TEMPOREX'],
  'the national':['Frightened Rabbit','Bon Iver','Iron & Wine','Sufjan Stevens'],
  'bon iver':['The National','Fleet Foxes','Sufjan Stevens','Elbow'],
  'phoebe bridgers':['Julien Baker','Lucy Dacus','boygenius','Angel Olsen'],
};
function findSim(artist, db) { const a=artist.toLowerCase(); const k=Object.keys(db).find(k=>a.includes(k)||k.includes(a)); return k?db[k]:null; }

const COLORS = ['#cc0000','#ff4444','#ffffff','#cccccc','#888888','#ff6600','#ffcc00','#004499'];
function buildPicker(id, sel) {
  const el = document.getElementById(id); el.innerHTML = '';
  COLORS.forEach((c,i) => {
    const sw = document.createElement('div');
    sw.className = 'swatch'+(sel?(c===sel?' on':''):(i===0?' on':''));
    sw.style.background = c; sw.dataset.c = c;
    if (c==='#ffffff'||c==='#cccccc') sw.style.border='2px solid #444';
    sw.onclick = () => { el.querySelectorAll('.swatch').forEach(s=>s.classList.remove('on')); sw.classList.add('on'); };
    el.appendChild(sw);
  });
}
function getColor(id) { const s=document.getElementById(id).querySelector('.on'); return s?s.dataset.c:COLORS[0]; }

let sb=null, currentUser=null, currentProfile=null;

let artTimer=null, lastArtQuery='';
function debounceArt() { clearTimeout(artTimer); artTimer=setTimeout(fetchArt,900); }
async function fetchArt() {
  const song=document.getElementById('p-song').value.trim();
  const artist=document.getElementById('p-artist').value.trim();
  if(!song||!artist) return;
  const q=encodeURIComponent(`${song} ${artist}`);
  if(q===lastArtQuery) return; lastArtQuery=q;
  try {
    const res=await fetch(`https://itunes.apple.com/search?term=${q}&media=music&limit=1`);
    const data=await res.json();
    if(data.results&&data.results.length>0) {
      const url=data.results[0].artworkUrl100.replace('100x100','400x400');
      const img=document.getElementById('art-preview');
      img.src=url; img.classList.add('show'); img.dataset.artUrl=url;
    }
  } catch(e) {}
}

function connectSupabase() {
  const url=document.getElementById('setup-url').value.trim();
  const key=document.getElementById('setup-key').value.trim();
  const err=document.getElementById('setup-error'); err.textContent='';
  if(!url||!key){err.textContent='Both fields are required.';return;}
  if(!url.startsWith('https://')){err.textContent='URL must start with https://';return;}
  localStorage.setItem('wl_url',url); localStorage.setItem('wl_key',key);
  bootSupabase(url,key);
}
async function bootSupabase(url,key) {
  try {
    sb=window.supabase.createClient(url,key);
    const{data:{session}}=await sb.auth.getSession();
    if(session){currentUser=session.user;await loadProfile();}
    else showView('auth');
    sb.auth.onAuthStateChange(async(event,session)=>{
      if(event==='SIGNED_IN'&&session&&!currentUser){currentUser=session.user;await loadProfile();}
    });
  } catch(e){document.getElementById('setup-error').textContent='Could not connect. Check your URL and key.';}
}
function resetSetup(){localStorage.removeItem('wl_url');localStorage.removeItem('wl_key');showView('setup');}

async function sendMagicLink() {
  const email=document.getElementById('auth-email').value.trim();
  const err=document.getElementById('auth-error'); const btn=document.getElementById('auth-btn');
  err.textContent='';
  if(!email||!email.includes('@')){err.textContent='Please enter a valid email.';return;}
  btn.disabled=true; btn.textContent='Sending...';
  const{error}=await sb.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.href}});
  btn.disabled=false; btn.textContent='Send Magic Link ‚Üí';
  if(error){err.textContent=error.message;return;}
  document.getElementById('auth-sent-email').textContent=email;
  document.getElementById('auth-form').style.display='none';
  document.getElementById('auth-sent').style.display='block';
}
function resetAuth(){document.getElementById('auth-form').style.display='block';document.getElementById('auth-sent').style.display='none';document.getElementById('auth-email').value='';}
async function signOut(){await sb.auth.signOut();currentUser=null;currentProfile=null;document.getElementById('mainNav').style.display='none';showView('auth');}
async function loadProfile(){
  const{data}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
  if(data){currentProfile=data;document.getElementById('nav-user').textContent='@'+data.username;document.getElementById('mainNav').style.display='flex';showView('feed');}
  else{buildPicker('ob-colors',null);showView('onboarding');}
}

async function createProfile(){
  const name=document.getElementById('ob-name').value.trim();
  const username=document.getElementById('ob-username').value.trim().toLowerCase().replace(/\s+/g,'_');
  const err=document.getElementById('ob-error'); const btn=document.getElementById('ob-btn');
  err.textContent='';
  if(!name||!username){err.textContent='Both fields are required.';return;}
  if(!/^[a-z0-9_]+$/.test(username)){err.textContent='Username: letters, numbers, underscores only.';return;}
  btn.disabled=true; btn.textContent='Saving...';
  const{data,error}=await sb.from('profiles').insert({id:currentUser.id,username,display_name:name,color:getColor('ob-colors')}).select().single();
  btn.disabled=false; btn.textContent='Enter Wavelength ‚Üí';
  if(error){err.textContent=error.message.includes('duplicate')?'Username taken. Try another.':error.message;return;}
  currentProfile=data; document.getElementById('nav-user').textContent='@'+data.username;
  document.getElementById('mainNav').style.display='flex'; showView('feed'); showToast('Welcome to Wavelength! üéµ',true);
}

function showView(name,opts={}){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  ['feed','browse','myprofile','settings'].forEach(n=>{
    const el=document.getElementById('nl-'+n);
    if(el) el.classList.toggle('active',n===name||(n==='myprofile'&&name==='profile'&&opts.userId===currentUser?.id));
  });
  window.scrollTo(0,0);
  if(name==='feed') renderFeed();
  if(name==='browse') renderBrowse();
  if(name==='profile') renderProfile(opts.userId);
  if(name==='songdetail') renderSongDetail(opts);
  if(name==='settings') renderSettings();
}

function getWeek(){return Math.max(1,Math.floor((new Date()-new Date('2024-01-01'))/(7*24*60*60*1000))+1);}
function getRange(w){const s=new Date('2024-01-01');s.setDate(s.getDate()+(w-1)*7);const e=new Date(s);e.setDate(e.getDate()+6);const f=d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});return`${f(s)} ‚Äì ${f(e)}`;}
function noteSVG(size=32){return`<svg width="${size}" height="${size}" viewBox="0 0 40 40"><text x="4" y="32" font-size="28" fill="#cc0000" opacity="0.4">‚ô™</text></svg>`;}

async function renderFeed(){
  const week=getWeek();
  document.getElementById('feed-pill').textContent=`Week ${week}`;
  document.getElementById('feed-range').textContent=getRange(week);
  const grid=document.getElementById('friends-grid');
  grid.innerHTML='<div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>';
  const{data:follows}=await sb.from('follows').select('following_id').eq('follower_id',currentUser.id);
  const ids=[currentUser.id,...(follows||[]).map(f=>f.following_id)];
  const{data:profiles}=await sb.from('profiles').select('*').in('id',ids);
  const{data:picks}=await sb.from('picks').select('*').in('user_id',ids).eq('week_number',week);
  const pm=Object.fromEntries((picks||[]).map(p=>[p.user_id,p]));
  if(!profiles||profiles.length===0){grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="eicon">üéµ</div><p>Your feed is empty.<br>Go to <strong>Browse Users</strong> to find friends to follow!</p></div>`;return;}
  const sorted=[profiles.find(p=>p.id===currentUser.id),...profiles.filter(p=>p.id!==currentUser.id)].filter(Boolean);
  grid.innerHTML=sorted.map(p=>{
    const pick=pm[p.id]; const me=p.id===currentUser.id;
    const artHtml=pick?.artwork_url?`<img class="card-art" src="${esc(pick.artwork_url)}" alt="Album art" loading="lazy" />`:`<div class="card-art-placeholder">${noteSVG(64)}</div>`;
    return`<div class="friend-card" onclick="showView('profile',{userId:'${p.id}'})">
      <div class="card-art-wrap">${artHtml}</div>
      <div class="card-body">
        <div class="card-username"><span class="dot" style="background:${p.color}"></span>${me?'‚≠ê You':'@'+esc(p.username)}</div>
        ${pick?`<div class="card-song">${esc(pick.song)}</div><div class="card-artist">${esc(pick.artist)}</div>`:`<div class="no-pick">No pick yet this week</div>`}
      </div>
      <div class="card-arrow">‚Üó</div>
    </div>`;
  }).join('');
}

async function renderBrowse(){
  const grid=document.getElementById('browse-grid');
  grid.innerHTML='<div class="loading-center" style="grid-column:1/-1"><div class="spinner"></div></div>';
  const{data:profiles}=await sb.from('profiles').select('*').order('created_at',{ascending:false});
  if(!profiles||profiles.length===0){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><p>No users yet.</p></div>';return;}
  document.getElementById('browse-count').textContent=`${profiles.length} member${profiles.length!==1?'s':''}`;
  const{data:picks}=await sb.from('picks').select('user_id');
  const pc={};(picks||[]).forEach(p=>{pc[p.user_id]=(pc[p.user_id]||0)+1;});
  grid.innerHTML=profiles.map(p=>{
    const count=pc[p.id]||0; const me=p.id===currentUser.id;
    return`<div class="browse-card" onclick="showView('profile',{userId:'${p.id}'})">
      <div class="browse-avatar" style="background:${p.color}22;color:${p.color};border-color:${p.color}44">${p.display_name[0]}</div>
      <div class="browse-name">${esc(p.display_name)}${me?' ‚≠ê':''}</div>
      <div class="browse-username">@${esc(p.username)}</div>
      <div class="browse-picks">${count} pick${count!==1?'s':''}</div>
    </div>`;
  }).join('');
}

async function renderProfile(userId){
  const isMe=userId===currentUser.id; const week=getWeek();
  document.getElementById('profile-back').onclick=()=>showView('feed');
  document.getElementById('profile-hero').innerHTML='<div class="loading-center"><div class="spinner"></div></div>';
  document.getElementById('weeks-list').innerHTML='';
  const{data:profile}=await sb.from('profiles').select('*').eq('id',userId).single();
  if(!profile) return;
  const{data:picks}=await sb.from('picks').select('*').eq('user_id',userId).order('week_number',{ascending:false});
  const pm=Object.fromEntries((picks||[]).map(p=>[p.week_number,p]));
  let isFollowing=false;
  if(!isMe){const{data:f}=await sb.from('follows').select('*').eq('follower_id',currentUser.id).eq('following_id',userId).single();isFollowing=!!f;}
  document.getElementById('profile-hero').innerHTML=`
    <div class="profile-hero-inner">
      <div class="p-avatar" style="background:${profile.color}22;color:${profile.color}">${profile.display_name[0]}</div>
      <div>
        <div class="p-name">${esc(profile.display_name)}</div>
        <div class="p-username">@${esc(profile.username)}</div>
        <div class="p-stats"><div class="p-stat"><strong>${(picks||[]).length}</strong>picks</div></div>
        ${!isMe?`<div style="margin-top:0.75rem"><button class="btn ${isFollowing?'btn-ghost':'btn-outline'}" id="follow-btn" onclick="toggleFollowProfile('${userId}',${isFollowing})">${isFollowing?'Following':'+ Follow'}</button></div>`:''}
      </div>
    </div>`;
  let html='';
  for(let w=week;w>=1;w--){
    const pick=pm[w]; const cur=w===week;
    const thumbHtml=pick?.artwork_url?`<img class="week-thumb" src="${esc(pick.artwork_url)}" alt="" loading="lazy" />`:`<div class="week-thumb-ph">${noteSVG(20)}</div>`;
    html+=`<div class="week-row ${cur?'is-cur':''}" onclick="${pick?`showView('songdetail',{userId:'${userId}',week:${w}})`:isMe?'openPickModal()':''}">
      <div><div class="wk-num">${cur?'‚òÖ NOW':`WK ${w}`}</div></div>
      ${thumbHtml}
      ${pick?`<div class="wk-song"><strong>${esc(pick.song)}</strong><span>${esc(pick.artist)}</span></div><div class="wk-arrow">‚Üí</div>`
            :isMe?`<div class="wk-song" style="color:var(--text-muted);font-family:'IBM Plex Mono',monospace;font-size:0.72rem">+ Add your pick</div><div></div>`
                 :`<div class="wk-song" style="color:var(--text-dim);font-family:'IBM Plex Mono',monospace;font-size:0.72rem">No pick</div><div></div>`}
    </div>`;
  }
  document.getElementById('weeks-list').innerHTML=html;
}

async function toggleFollowProfile(userId,isFollowing){
  const btn=document.getElementById('follow-btn'); btn.disabled=true;
  if(isFollowing){
    await sb.from('follows').delete().eq('follower_id',currentUser.id).eq('following_id',userId);
    btn.textContent='+ Follow'; btn.className='btn btn-outline'; btn.onclick=()=>toggleFollowProfile(userId,false);
  } else {
    await sb.from('follows').insert({follower_id:currentUser.id,following_id:userId});
    btn.textContent='Following'; btn.className='btn btn-ghost'; btn.onclick=()=>toggleFollowProfile(userId,true);
    showToast('Now following!',true);
  }
  btn.disabled=false;
}

async function renderSongDetail({userId,week}){
  document.getElementById('song-back').onclick=()=>showView('profile',{userId});
  document.getElementById('song-content').innerHTML='<div class="loading-center"><div class="spinner"></div></div>';
  const{data:pick}=await sb.from('picks').select('*').eq('user_id',userId).eq('week_number',week).single();
  const{data:profile}=await sb.from('profiles').select('*').eq('id',userId).single();
  if(!pick||!profile) return;
  const tags=pick.tags||[];
  const simSongs=findSim(pick.artist,SIM_SONGS); const simArtists=findSim(pick.artist,SIM_ARTISTS);
  const artHtml=pick.artwork_url?`<img class="song-art" src="${esc(pick.artwork_url)}" alt="Album art" />`:`<div class="song-art-ph">${noteSVG(64)}</div>`;
  document.getElementById('song-content').innerHTML=`
    <div class="song-hero">
      ${artHtml}
      <div>
        <div class="song-badge">Week ${week} ¬∑ ${getRange(week)} ¬∑ ${esc(profile.display_name)}'s Pick</div>
        <div class="song-title">${esc(pick.song)}</div>
        <div class="song-artist">${esc(pick.artist)}${pick.year?` ¬∑ ${pick.year}`:''}</div>
        ${tags.length?`<div class="song-tags">${tags.map(t=>`<div class="tag">${esc(t)}</div>`).join('')}</div>`:''}
        ${pick.note?`<p style="margin-top:1.2rem;font-size:0.95rem;line-height:1.75;color:var(--text-muted);border-left:3px solid var(--red);padding-left:1rem;font-style:italic">"${esc(pick.note)}"</p>`:''}
      </div>
    </div>
    ${pick.band_info?`<div class="detail-sec"><h3>About ${esc(pick.artist)}</h3><p>${esc(pick.band_info)}</p></div>`:''}
    <div class="detail-sec"><h3>Song Info</h3>
      <div class="stat-row"><span class="lbl">Title</span><span>${esc(pick.song)}</span></div>
      <div class="stat-row"><span class="lbl">Artist</span><span>${esc(pick.artist)}</span></div>
      ${pick.year?`<div class="stat-row"><span class="lbl">Year</span><span>${pick.year}</span></div>`:''}
      ${tags.length?`<div class="stat-row"><span class="lbl">Vibe</span><span>${tags.join(', ')}</span></div>`:''}
    </div>
    ${simSongs?`<div class="detail-sec"><h3>Similar Songs</h3><div class="similar-grid">${simSongs.map(s=>{const p=s.split(' ‚Äî ');return`<div class="sim-item"><strong>${esc(p[0])}</strong><span>${esc(p[1]||'')}</span></div>`;}).join('')}</div></div>`:''}
    ${simArtists?`<div class="detail-sec"><h3>Similar Artists</h3><div class="similar-grid">${simArtists.map(a=>`<div class="sim-item"><strong>${esc(a)}</strong><span>You might enjoy</span></div>`).join('')}</div></div>`:''}
  `;
}

function renderSettings(){
  if(!currentProfile) return;
  document.getElementById('s-name').value=currentProfile.display_name;
  document.getElementById('s-username').value=currentProfile.username;
  buildPicker('s-colors',currentProfile.color);
  document.getElementById('search-results').innerHTML='';
  document.getElementById('search-q').value='';
}
async function saveSettings(){
  const name=document.getElementById('s-name').value.trim();
  const username=document.getElementById('s-username').value.trim().toLowerCase().replace(/\s+/g,'_');
  if(!name||!username){showToast('Fields required');return;}
  const{data,error}=await sb.from('profiles').update({display_name:name,username,color:getColor('s-colors')}).eq('id',currentUser.id).select().single();
  if(error){showToast(error.message);return;}
  currentProfile=data; document.getElementById('nav-user').textContent='@'+data.username; showToast('Saved!',true);
}
async function searchUsers(){
  const q=document.getElementById('search-q').value.trim(); if(!q) return;
  const{data}=await sb.from('profiles').select('*').ilike('username',`%${q}%`).neq('id',currentUser.id).limit(10);
  const{data:follows}=await sb.from('follows').select('following_id').eq('follower_id',currentUser.id);
  const fs=new Set((follows||[]).map(f=>f.following_id));
  const el=document.getElementById('search-results');
  if(!data||data.length===0){el.innerHTML='<p style="font-family:\'IBM Plex Mono\',monospace;font-size:0.75rem;color:var(--text-muted);padding:0.5rem 0">No users found.</p>';return;}
  el.innerHTML=data.map(u=>{
    const following=fs.has(u.id);
    return`<div class="user-result">
      <div class="ur-av" style="background:${u.color}22;color:${u.color}">${u.display_name[0]}</div>
      <div class="ur-info"><strong>${esc(u.display_name)}</strong><span>@${esc(u.username)}</span></div>
      <button class="btn ${following?'btn-ghost':'btn-outline'}" style="font-size:0.62rem;padding:0.4rem 0.8rem" onclick="toggleFollow('${u.id}',${following},this)">${following?'Following':'+ Follow'}</button>
    </div>`;
  }).join('');
}
async function toggleFollow(userId,isFollowing,btn){
  btn.disabled=true;
  if(isFollowing){
    await sb.from('follows').delete().eq('follower_id',currentUser.id).eq('following_id',userId);
    btn.textContent='+ Follow'; btn.className='btn btn-outline'; btn.style.cssText='font-size:0.62rem;padding:0.4rem 0.8rem';
    btn.onclick=()=>toggleFollow(userId,false,btn);
  } else {
    await sb.from('follows').insert({follower_id:currentUser.id,following_id:userId});
    btn.textContent='Following'; btn.className='btn btn-ghost'; btn.style.cssText='font-size:0.62rem;padding:0.4rem 0.8rem';
    btn.onclick=()=>toggleFollow(userId,true,btn); showToast('Following!',true);
  }
  btn.disabled=false;
}

async function openPickModal(){
  const week=getWeek();
  document.getElementById('pick-week-label').textContent=`Week ${week} ¬∑ ${getRange(week)}`;
  document.getElementById('pick-error').textContent='';
  const preview=document.getElementById('art-preview');
  preview.classList.remove('show'); preview.src=''; preview.dataset.artUrl=''; lastArtQuery='';
  const{data}=await sb.from('picks').select('*').eq('user_id',currentUser.id).eq('week_number',week).single();
  document.getElementById('p-song').value=data?.song||'';
  document.getElementById('p-artist').value=data?.artist||'';
  document.getElementById('p-note').value=data?.note||'';
  document.getElementById('p-tags').value=data?.tags?.join(', ')||'';
  document.getElementById('p-year').value=data?.year||'';
  document.getElementById('p-bandinfo').value=data?.band_info||'';
  if(data?.artwork_url){preview.src=data.artwork_url;preview.classList.add('show');preview.dataset.artUrl=data.artwork_url;}
  document.getElementById('pick-modal').classList.add('open');
}
function closePickModal(){document.getElementById('pick-modal').classList.remove('open');}
async function savePick(){
  const song=document.getElementById('p-song').value.trim();
  const artist=document.getElementById('p-artist').value.trim();
  const err=document.getElementById('pick-error'); const btn=document.getElementById('pick-save-btn');
  err.textContent='';
  if(!song||!artist){err.textContent='Song title and artist are required.';return;}
  const tags=document.getElementById('p-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const week=getWeek(); const artUrl=document.getElementById('art-preview').dataset.artUrl||null;
  btn.disabled=true; btn.textContent='Saving...';
  const{error}=await sb.from('picks').upsert({user_id:currentUser.id,week_number:week,song,artist,note:document.getElementById('p-note').value.trim(),tags,year:document.getElementById('p-year').value.trim(),band_info:document.getElementById('p-bandinfo').value.trim(),artwork_url:artUrl},{onConflict:'user_id,week_number'});
  btn.disabled=false; btn.textContent='Save Pick ‚Üí';
  if(error){err.textContent=error.message;return;}
  closePickModal(); showToast('Pick saved! üéµ',true);
  if(document.getElementById('view-feed').classList.contains('active')) renderFeed();
  if(document.getElementById('view-profile').classList.contains('active')) renderProfile(currentUser.id);
}

function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showToast(msg,ok=false){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(ok?' ok':'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
function copySQL(){navigator.clipboard.writeText(document.getElementById('sql-block').textContent).then(()=>showToast('SQL copied!',true));}
document.getElementById('pick-modal').addEventListener('click',e=>{if(e.target.id==='pick-modal')closePickModal();});

(function(){const url=localStorage.getItem('wl_url');const key=localStorage.getItem('wl_key');if(url&&key)bootSupabase(url,key);else showView('setup');})();
</script>
</body>
</html>
